<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>VirtualApp原理速览 - 容器内 APP 启动流程 | TokameinE - 雨声淅淅沥沥，犬吠永不止息</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: Bender;
 src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
 font-family: BenderLight;
 src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/91110244_p0.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>VirtualApp原理速览 - 容器内 APP 启动流程</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2026-05-23T19:41:16.000Z" id="date"> 2026-05-24</time></div></span><br><span>Last Update: <div class="control"><time datetime="2025-05-24T03:30:32.748Z" id="updated"> 2025-05-24</time></div></span></div></div><hr><div id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在了解了正常环境下 app 的 activity 是如何被启动的以后，接下來我们希望能够了解一下 VirtualApp 中是如何启动目标 app 的。不过整个流程涉及到了对部分 Service 的 Hook，但这些内容却不是本节我们重点关心的内容，因此会有相应的介绍，但或许并不全面。</p>
<h1 id="容器内-APP-启动流程"><a href="#容器内-APP-启动流程" class="headerlink" title="容器内 APP 启动流程"></a>容器内 APP 启动流程</h1><h2 id="点击启动应用时发生了啥"><a href="#点击启动应用时发生了啥" class="headerlink" title="点击启动应用时发生了啥"></a>点击启动应用时发生了啥</h2><p>当用户点击了视图上目标应用的图标后，触发点击事件并向下调用，在 blackbox 中将来到 <code>launchApk</code> 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">launchApk</span><span class="hljs-params">(String packageName, <span class="hljs-type">int</span> userId)</span> &#123;  <br>  <span class="hljs-type">Intent</span> <span class="hljs-variable">launchIntentForPackage</span> <span class="hljs-operator">=</span>  <br>      getBPackageManager().getLaunchIntentForPackage(packageName, userId);  <br>  <span class="hljs-keyword">if</span> (launchIntentForPackage == <span class="hljs-literal">null</span>) &#123;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <br>  &#125;  <br>  startActivity(launchIntentForPackage, userId);  <br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startActivity</span><span class="hljs-params">(Intent intent, <span class="hljs-type">int</span> userId)</span> &#123;  <br>  <span class="hljs-keyword">if</span> (mClientConfiguration.isEnableLauncherActivity()) &#123;  <br>    LauncherActivity.launch(intent, userId);  <br>  &#125; <span class="hljs-keyword">else</span> &#123;  <br>    getBActivityManager().startActivity(intent, userId);  <br>  &#125;  <br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">launch</span><span class="hljs-params">(Intent intent, <span class="hljs-type">int</span> userId)</span> &#123;  <br>  <span class="hljs-type">Intent</span> <span class="hljs-variable">splash</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>();  <br>  splash.setClass(SandBoxCore.getContext(), LauncherActivity.class);  <br>  splash.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);  <br>  <br>  splash.putExtra(LauncherActivity.KEY_INTENT, intent);  <br>  splash.putExtra(LauncherActivity.KEY_PKG, intent.getPackage());  <br>  splash.putExtra(LauncherActivity.KEY_USER_ID, userId);  <br>  SandBoxCore.getContext().startActivity(splash);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>mClientConfiguration.isEnableLauncherActivity</code> 是恒真的，因此最终会调用 <code>LauncherActivity.launch</code> ，在该函数中，<code>blackbox</code> 初始化了一个 <code>Intent</code>，然后调用原生的 <code>startActivity</code> 函数来进入 <code>LauncherActivity</code>，在进入时，会调用该对象的 <code>onCreate</code> 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;  <br>  <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);  <br>  <span class="hljs-comment">// 获取启动当前 Activity 的 Intent</span><br>  <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> getIntent();  <br>  <span class="hljs-keyword">if</span> (intent == <span class="hljs-literal">null</span>) &#123;  <br>    finish();  <br>    <span class="hljs-keyword">return</span>;  <br>  &#125;  <br>  <span class="hljs-comment">// 获取需要启动的对于 APP 的相关信息</span><br>  <span class="hljs-type">Intent</span> <span class="hljs-variable">launchIntent</span> <span class="hljs-operator">=</span> intent.getParcelableExtra(KEY_INTENT);  <br>  <span class="hljs-type">String</span> <span class="hljs-variable">packageName</span> <span class="hljs-operator">=</span> intent.getStringExtra(KEY_PKG);  <br>  <span class="hljs-type">int</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> intent.getIntExtra(KEY_USER_ID, <span class="hljs-number">0</span>);  <br>  <br>  <span class="hljs-type">PackageInfo</span> <span class="hljs-variable">packageInfo</span> <span class="hljs-operator">=</span>  <br>      SandBoxCore.getBPackageManager().getPackageInfo(packageName, <span class="hljs-number">0</span>, userId);  <br>  <span class="hljs-keyword">if</span> (packageInfo == <span class="hljs-literal">null</span>) &#123;  <br>    Slog.e(TAG, packageName + <span class="hljs-string">&quot; not installed!&quot;</span>);  <br>    finish();  <br>    <span class="hljs-keyword">return</span>;  <br>  &#125;  <br>  <span class="hljs-type">Drawable</span> <span class="hljs-variable">drawable</span> <span class="hljs-operator">=</span> packageInfo.applicationInfo.loadIcon(SandBoxCore.getPackageManager());  <br>  setContentView(R.layout.activity_launcher);  <br>  findViewById(R.id.iv_icon).setBackgroundDrawable(drawable);  <br>  <span class="hljs-comment">// 调用 BActivityManager.startActivity 在 Blackbox 中启动应用</span><br>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; SandBoxCore.getBActivityManager().startActivity(launchIntent, userId)).start();  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>函数首先获取之前那个 splash ，然后从中读取出需要启动的目标应用的包名和用户 ID，并通过包名来读取包的相关信息，最后调用 <code>BActivityManager.startActivity</code> 来在 Blackbox 中启动应用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startActivity</span><span class="hljs-params">(Intent intent, <span class="hljs-type">int</span> userId)</span> &#123;  <br>  <span class="hljs-keyword">try</span> &#123;  <br>    getService().startActivity(intent, userId);  <br>  &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;  <br>    e.printStackTrace();  <br>  &#125;  <br>&#125;<br><br><span class="hljs-keyword">public</span> Service <span class="hljs-title function_">getService</span><span class="hljs-params">()</span> &#123;  <br>  <span class="hljs-keyword">if</span> (mService != <span class="hljs-literal">null</span>  <br>      &amp;&amp; mService.asBinder().pingBinder()  <br>      &amp;&amp; mService.asBinder().isBinderAlive()) &#123;  <br>    <span class="hljs-keyword">return</span> mService;  <br>  &#125;  <br>  <span class="hljs-keyword">try</span> &#123;  <br>    mService =  <br>        Reflector.on(getTClass().getName() + <span class="hljs-string">&quot;$Stub&quot;</span>)  <br>            .method(<span class="hljs-string">&quot;asInterface&quot;</span>, IBinder.class)  <br>            .call(SandBoxCore.get().getService(getServiceName()));  <br>    mService  <br>        .asBinder()  <br>        .linkToDeath(  <br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">IBinder</span>.DeathRecipient() &#123;  <br>              <span class="hljs-meta">@Override</span>  <br>              <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">binderDied</span><span class="hljs-params">()</span> &#123;  <br>                mService.asBinder().unlinkToDeath(<span class="hljs-built_in">this</span>, <span class="hljs-number">0</span>);  <br>                mService = <span class="hljs-literal">null</span>;  <br>              &#125;  <br>            &#125;,  <br>            <span class="hljs-number">0</span>);  <br>    <span class="hljs-keyword">return</span> getService();  <br>  &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;  <br>    e.printStackTrace();  <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>getService</code> 函数会返回对应的 Service ，在这个函数中将会返回 <code>BActivityManagerService</code>，这里涉及到了一个我们尚且没有关注过的问题，VirtualApp 是如何伪造各种系统 Service 的？</p>
<h2 id="那些系统服务如何被-Hook"><a href="#那些系统服务如何被-Hook" class="headerlink" title="那些系统服务如何被 Hook"></a>那些系统服务如何被 Hook</h2><p>在应用的 <code>Manifest</code> 里声明了这么一段：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">provider</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.core.system.SystemCallProvider&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">&quot;$&#123;applicationId&#125;.blackbox.SystemCallProvider&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:exported</span>=<span class="hljs-string">&quot;false&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:process</span>=<span class="hljs-string">&quot;@string/black_box_service_name&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure>

<p>在启动 Blackbox 的时候，<code>handleBindApplication</code> 中会主动调用对应 <code>ContentProvider</code> 下的 <code>onCreate</code> 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> &#123;  <br>  <span class="hljs-keyword">return</span> initSystem();  <br>&#125;  <br>  <br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">initSystem</span><span class="hljs-params">()</span> &#123;  <br>  BlackBoxSystem.getSystem().startup();  <br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startup</span><span class="hljs-params">()</span> &#123;  <br>  <span class="hljs-comment">// 如果已经启动过了，则直接返回即可</span><br>  <span class="hljs-keyword">if</span> (isStartup.getAndSet(<span class="hljs-literal">true</span>)) <span class="hljs-keyword">return</span>;  <br>  BEnvironment.load();  <br><br>  <span class="hljs-comment">// 将需要 hook 的系统 Service 代理放入 mServices</span><br>  mServices.add(BPackageManagerService.get());  <br>  mServices.add(BUserManagerService.get());  <br>  mServices.add(BActivityManagerService.get());  <br>  mServices.add(BJobManagerService.get());  <br>  mServices.add(BStorageManagerService.get());  <br>  mServices.add(BPackageInstallerService.get());  <br>  mServices.add(BXposedManagerService.get());  <br>  mServices.add(BProcessManagerService.get());  <br>  mServices.add(BAccountManagerService.get());  <br>  mServices.add(BLocationManagerService.get());  <br>  mServices.add(BNotificationManagerService.get());  <br>  <span class="hljs-comment">// 遍历每个 Service 并调用 systemReady 完成准备工作</span><br>  <span class="hljs-keyword">for</span> (ISystemService service : mServices) &#123;  <br>    service.systemReady();  <br>  &#125;  <br>  <span class="hljs-comment">// 遍历 blackbox 中每个预先安装的应用，如果有哪个尚未安装完成，重新恢复安装</span><br>  List&lt;String&gt; preInstallPackages = AppSystemEnv.getPreInstallPackages();  <br>  <span class="hljs-keyword">for</span> (String preInstallPackage : preInstallPackages) &#123;  <br>    <span class="hljs-keyword">try</span> &#123;  <br>      <span class="hljs-keyword">if</span> (!BPackageManagerService.get().isInstalled(preInstallPackage, BUserHandle.USER_ALL)) &#123;  <br>        <span class="hljs-type">PackageInfo</span> <span class="hljs-variable">packageInfo</span> <span class="hljs-operator">=</span>  <br>            SandBoxCore.getPackageManager().getPackageInfo(preInstallPackage, <span class="hljs-number">0</span>);  <br>        BPackageManagerService.get()  <br>            .installPackageAsUser(  <br>                packageInfo.applicationInfo.sourceDir,  <br>                InstallOption.installBySystem(),  <br>                BUserHandle.USER_ALL);  <br>      &#125;  <br>    &#125; <span class="hljs-keyword">catch</span> (PackageManager.NameNotFoundException ignored) &#123;  <br>    &#125;  <br>  &#125;  <br>  initJarEnv();  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们重点关注的是 <code>mServices</code> 这个成员，在注意到它将 <code>BActivityManagerService</code> 放入了数组，并调用对应的 <code>systemReady</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">BActivityManagerService</span><span class="hljs-params">()</span> &#123;  <br>  mBroadcastManager = BroadcastManager.startSystem(<span class="hljs-built_in">this</span>, mPms);  <br>&#125;<br><br><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">systemReady</span><span class="hljs-params">()</span> &#123;  <br>  mBroadcastManager.startup();  <br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startup</span><span class="hljs-params">()</span> &#123;  <br>  mPms.addPackageMonitor(<span class="hljs-built_in">this</span>);  <br>  List&lt;BPackageSettings&gt; bPackageSettings = mPms.getBPackageSettings();  <br>  <span class="hljs-keyword">for</span> (BPackageSettings bPackageSetting : bPackageSettings) &#123;  <br>    <span class="hljs-type">BPackage</span> <span class="hljs-variable">bPackage</span> <span class="hljs-operator">=</span> bPackageSetting.pkg;  <br>    registerPackage(bPackage);  <br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>最终会为每个包注册一个 <code>BroadcastReceiver</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addReceiver</span><span class="hljs-params">(String packageName, BroadcastReceiver receiver)</span> &#123;  <br>  List&lt;BroadcastReceiver&gt; broadcastReceivers = mReceivers.get(packageName);  <br>  <span class="hljs-keyword">if</span> (broadcastReceivers == <span class="hljs-literal">null</span>) &#123;  <br>    broadcastReceivers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();  <br>    mReceivers.put(packageName, broadcastReceivers);  <br>  &#125;  <br>  broadcastReceivers.add(receiver);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>而这个 <code>SystemCallProvider</code> 本身也作为一个 IBinder，将它管理的这些 Service 暴露给其他应用使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span>  <br><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> Bundle <span class="hljs-title function_">call</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> String method, <span class="hljs-meta">@Nullable</span> String arg, <span class="hljs-meta">@Nullable</span> Bundle extras)</span> &#123;  <br>  Slog.d(TAG, <span class="hljs-string">&quot;call: &quot;</span> + method + <span class="hljs-string">&quot;, &quot;</span> + extras);  <br>  <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;VM&quot;</span>.equals(method)) &#123;  <br>    <span class="hljs-type">Bundle</span> <span class="hljs-variable">bundle</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bundle</span>();  <br>    <span class="hljs-keyword">if</span> (extras != <span class="hljs-literal">null</span>) &#123;  <br>      <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> extras.getString(<span class="hljs-string">&quot;_B_|_server_name_&quot;</span>);  <br>      BundleCompat.putBinder(bundle, <span class="hljs-string">&quot;_B_|_server_&quot;</span>, ServiceManager.getService(name));  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> bundle;  <br>  &#125;  <br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.call(method, arg, extras);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>ServiceManager.getService</code> 可以能够根据参数来返回对应的 Service：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> IBinder <span class="hljs-title function_">getService</span><span class="hljs-params">(String name)</span> &#123;  <br>  <span class="hljs-keyword">return</span> get().getServiceInternal(name);  <br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ServiceManager <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;  <br>  <span class="hljs-keyword">if</span> (sServiceManager == <span class="hljs-literal">null</span>) &#123;  <br>    <span class="hljs-keyword">synchronized</span> (ServiceManager.class) &#123;  <br>      <span class="hljs-keyword">if</span> (sServiceManager == <span class="hljs-literal">null</span>) &#123;  <br>        sServiceManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceManager</span>();  <br>      &#125;  <br>    &#125;  <br>  &#125;  <br>  <span class="hljs-keyword">return</span> sServiceManager;  <br>&#125;<br><span class="hljs-keyword">private</span> <span class="hljs-title function_">ServiceManager</span><span class="hljs-params">()</span> &#123;  <br>  mCaches.put(ACTIVITY_MANAGER, BActivityManagerService.get());  <br>  mCaches.put(JOB_MANAGER, BJobManagerService.get());  <br>  mCaches.put(PACKAGE_MANAGER, BPackageManagerService.get());  <br>  mCaches.put(STORAGE_MANAGER, BStorageManagerService.get());  <br>  mCaches.put(USER_MANAGER, BUserManagerService.get());  <br>  mCaches.put(XPOSED_MANAGER, BXposedManagerService.get());  <br>  mCaches.put(ACCOUNT_MANAGER, BAccountManagerService.get());  <br>  mCaches.put(LOCATION_MANAGER, BLocationManagerService.get());  <br>  mCaches.put(NOTIFICATION_MANAGER, BNotificationManagerService.get());  <br>&#125;<br><span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">getServiceInternal</span><span class="hljs-params">(String name)</span> &#123;  <br>  <span class="hljs-keyword">return</span> mCaches.get(name);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果 <code>ServiceManager</code> 没初始化的话就先创建并初始化，将所有的 Service 都放入 <code>mCaches</code>，并在需要的时候返回该对象。最终其他需要使用这些服务的应用就都能够通过 Binder 拿到这些对应的对象了。</p>
<p>对这些获取 Service 的对象来说，他们本该获取到原生的 <code>ActivityManagerService</code> ，却被 <code>BActivityManagerService</code> 替换掉了，对应的去调用那些本该调用的方法时，自然这些方法也就一起被 Hook 掉了。</p>
<p>一般来说我们都是通过 <code>getSystemService</code> 来获取对应的服务的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getSystemService</span><span class="hljs-params">(String name)</span> &#123;<br>	<span class="hljs-comment">// this 是 ContextImpl</span><br>    <span class="hljs-keyword">return</span> SystemServiceRegistry.getSystemService(<span class="hljs-built_in">this</span>, name);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>而在 Blackbox 的 HookManager 中注册了对各种对象的钩子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;  <br>  <span class="hljs-keyword">if</span> (SandBoxCore.get().isBlackProcess() || SandBoxCore.get().isServerProcess()) &#123;  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IDisplayManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OsStub</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IActivityManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IPackageManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ITelephonyManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HCallbackProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IAppOpsManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">INotificationManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IAlarmManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IAppWidgetManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentServiceStub</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IWindowManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IUserManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RestrictionsManagerStub</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IMediaSessionManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ILocationManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IStorageManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ILauncherAppsProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IJobServiceProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IAccessibilityManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ITelephonyRegistryProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IDevicePolicyManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IAccountManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IConnectivityManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IClipboardManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IPhoneSubInfoProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IMediaRouterServiceProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IPowerManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IContextHubServiceProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IVibratorServiceProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IPersistentDataBlockServiceProxy</span>());  <br>    addInjector(AppInstrumentation.get());  <br>    <span class="hljs-comment">/*  </span><br><span class="hljs-comment">     * It takes time to test and enhance the compatibility of WifiManager     * (only tested in Android 10).     * commented by BlackBoxing at 2022/03/08     * */</span>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IWifiManagerProxy</span>());  <br>    addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IWifiScannerProxy</span>());  <br>    <span class="hljs-comment">// 12.0  </span><br>    <span class="hljs-keyword">if</span> (BuildCompat.isS()) &#123;  <br>      addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IActivityClientProxy</span>(<span class="hljs-literal">null</span>));  <br>      addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IVpnManagerProxy</span>());  <br>    &#125;  <br>    <span class="hljs-comment">// 11.0  </span><br>    <span class="hljs-keyword">if</span> (BuildCompat.isR()) &#123;  <br>      addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IPermissionManagerProxy</span>());  <br>    &#125;  <br>    <span class="hljs-comment">// 10.0  </span><br>    <span class="hljs-keyword">if</span> (BuildCompat.isQ()) &#123;  <br>      addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IActivityTaskManagerProxy</span>());  <br>    &#125;  <br>    <span class="hljs-comment">// 9.0  </span><br>    <span class="hljs-keyword">if</span> (BuildCompat.isPie()) &#123;  <br>      addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ISystemUpdateProxy</span>());  <br>    &#125;  <br>    <span class="hljs-comment">// 8.0  </span><br>    <span class="hljs-keyword">if</span> (BuildCompat.isOreo()) &#123;  <br>      addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IAutofillManagerProxy</span>());  <br>      addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IDeviceIdentifiersPolicyProxy</span>());  <br>      addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IStorageStatsManagerProxy</span>());  <br>    &#125;  <br>    <span class="hljs-comment">// 7.1  </span><br>    <span class="hljs-keyword">if</span> (BuildCompat.isN_MR1()) &#123;  <br>      addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IShortcutManagerProxy</span>());  <br>    &#125;  <br>    <span class="hljs-comment">// 7.0  </span><br>    <span class="hljs-keyword">if</span> (BuildCompat.isN()) &#123;  <br>      addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">INetworkManagementServiceProxy</span>());  <br>    &#125;  <br>    <span class="hljs-comment">// 6.0  </span><br>    <span class="hljs-keyword">if</span> (BuildCompat.isM()) &#123;  <br>      addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IFingerprintManagerProxy</span>());  <br>      addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IGraphicsStatsProxy</span>());  <br>    &#125;  <br>    <span class="hljs-comment">// 5.0  </span><br>    <span class="hljs-keyword">if</span> (BuildCompat.isL()) &#123;  <br>      addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IJobServiceProxy</span>());  <br>    &#125;  <br>  &#125;  <br>  injectAll();  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们主要看 <code>IActivityManagerProxy</code> 是如何对 <code>ActivityManager</code> 进行 hook 的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inject</span><span class="hljs-params">(Object base, Object proxy)</span> &#123;  <br>  <span class="hljs-type">Object</span> <span class="hljs-variable">iActivityManager</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br>  <span class="hljs-keyword">if</span> (BuildCompat.isOreo()) &#123;  <br>    iActivityManager = BRActivityManagerOreo.get().IActivityManagerSingleton();  <br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (BuildCompat.isL()) &#123;  <br>    iActivityManager = BRActivityManagerNative.get().gDefault();  <br>  &#125;  <br>  BRSingleton.get(iActivityManager)._set_mInstance(proxy);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里有一个 <code>_set_mInstance</code> 实际上是 <code>blackreflection</code> 的语法糖，它通过反射的方式来修改 <code>gDefault().mInstance</code> 。我们在上一节中提到过启动应用时会通过 <code>ActivityManagerNative.getDefault</code> 来得到 <code>ActivityManagerProxy</code> ，这里会将结果给改成 <code>Proxy</code>，也就是用 <code>IActivityManagerProxy</code> 来代理原本的返回对象。</p>
<p>比如说 <code>getServices</code> 函数会被 hook 为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ProxyMethod(&quot;getServices&quot;)</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GetServices</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MethodHook</span> &#123;  <br>  <span class="hljs-meta">@Override</span>  <br>  <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">hook</span><span class="hljs-params">(Object who, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;  <br>    <span class="hljs-type">RunningServiceInfo</span> <span class="hljs-variable">runningServices</span> <span class="hljs-operator">=</span>  <br>        BActivityManager.get()  <br>            .getRunningServices(BActivityThread.getAppPackageName(), BActivityThread.getUserId());  <br>    <span class="hljs-keyword">if</span> (runningServices == <span class="hljs-literal">null</span>) &#123;  <br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> runningServices.mRunningServiceInfoList;  <br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>可以注意到，在注入 Service Hook 的时候是有做进程判断的，因为主进程肯定还是需要和 Service 进行正常沟通的，如果全都 Hook 掉的话，主进程也无法正常通信了。所以在满足<code>isBlackProcess</code> 或 <code>isServerProcess</code> 时才会注入那些代理，也就是那些需要启动的内部应用或是服务进程才会注入。</p>
</blockquote>
<p>顺带一提，ServerProcess 中包含了这么几个：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">provider</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.core.system.SystemCallProvider&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">&quot;$&#123;applicationId&#125;.blackbox.SystemCallProvider&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:exported</span>=<span class="hljs-string">&quot;false&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:process</span>=<span class="hljs-string">&quot;@string/black_box_service_name&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">receiver</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.proxy.ProxyBroadcastReceiver&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:enabled</span>=<span class="hljs-string">&quot;true&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:exported</span>=<span class="hljs-string">&quot;true&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:process</span>=<span class="hljs-string">&quot;@string/black_box_service_name&quot;</span>&gt;</span>  <br>  <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;$&#123;applicationId&#125;.stub_receiver&quot;</span> /&gt;</span>  <br>  <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">receiver</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">service</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.core.system.DaemonService&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:exported</span>=<span class="hljs-string">&quot;false&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:process</span>=<span class="hljs-string">&quot;@string/black_box_service_name&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">service</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.core.system.DaemonService$DaemonInnerService&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:exported</span>=<span class="hljs-string">&quot;false&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:process</span>=<span class="hljs-string">&quot;@string/black_box_service_name&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure>

<h2 id="BActivityManagerService-startActivity-如何启动应用"><a href="#BActivityManagerService-startActivity-如何启动应用" class="headerlink" title="BActivityManagerService.startActivity 如何启动应用"></a>BActivityManagerService.startActivity 如何启动应用</h2><p>接下来我们回到 <code>BActivityManagerService.startActivity</code> 来看看它如何启动应用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startActivity</span><span class="hljs-params">(Intent intent, <span class="hljs-type">int</span> userId)</span> &#123;  <br>  <span class="hljs-type">UserSpace</span> <span class="hljs-variable">userSpace</span> <span class="hljs-operator">=</span> getOrCreateSpaceLocked(userId);  <br>  <span class="hljs-keyword">synchronized</span> (userSpace.mStack) &#123;  <br>    userSpace.mStack.startActivityLocked(userId, intent, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, <span class="hljs-literal">null</span>);  <br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里向下继续调用 <code>startActivityLocked</code>，不过这个函数有点长，这里主要关注两个几个关键步骤即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">startActivityLocked</span><span class="hljs-params">(  </span><br><span class="hljs-params">    <span class="hljs-type">int</span> userId,  </span><br><span class="hljs-params">    Intent intent,  </span><br><span class="hljs-params">    String resolvedType,  </span><br><span class="hljs-params">    IBinder resultTo,  </span><br><span class="hljs-params">    String resultWho,  </span><br><span class="hljs-params">    <span class="hljs-type">int</span> requestCode,  </span><br><span class="hljs-params">    <span class="hljs-type">int</span> flags,  </span><br><span class="hljs-params">    Bundle options)</span> &#123;  <br>  <span class="hljs-keyword">synchronized</span> (mTasks) &#123;  <br>    synchronizeTasks();  <br>  &#125;  <br>  <br>  <span class="hljs-type">ResolveInfo</span> <span class="hljs-variable">resolveInfo</span> <span class="hljs-operator">=</span>  <br>      BPackageManagerService.get().resolveActivity(intent, GET_ACTIVITIES, resolvedType, userId);  <br>  <span class="hljs-keyword">if</span> (resolveInfo == <span class="hljs-literal">null</span> || resolveInfo.activityInfo == <span class="hljs-literal">null</span>) &#123;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>  &#125;  <br>  Log.d(TAG, <span class="hljs-string">&quot;startActivityLocked : &quot;</span> + resolveInfo.activityInfo);  <br>  <span class="hljs-type">ActivityInfo</span> <span class="hljs-variable">activityInfo</span> <span class="hljs-operator">=</span> resolveInfo.activityInfo;  <br>  <br>  <span class="hljs-type">ActivityRecord</span> <span class="hljs-variable">sourceRecord</span> <span class="hljs-operator">=</span> findActivityRecordByToken(userId, resultTo);  <br>  <span class="hljs-keyword">if</span> (sourceRecord == <span class="hljs-literal">null</span>) &#123;  <br>    resultTo = <span class="hljs-literal">null</span>;  <br>  &#125;  <br>  <span class="hljs-type">TaskRecord</span> <span class="hljs-variable">sourceTask</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br>  <span class="hljs-keyword">if</span> (sourceRecord != <span class="hljs-literal">null</span>) &#123;  <br>    sourceTask = sourceRecord.task;  <br>  &#125;  <br>  <br>  <span class="hljs-type">String</span> <span class="hljs-variable">taskAffinity</span> <span class="hljs-operator">=</span> ComponentUtils.getTaskAffinity(activityInfo);  <br>  <br>  <span class="hljs-type">int</span> <span class="hljs-variable">launchModeFlags</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;  <br>  <span class="hljs-type">boolean</span> <span class="hljs-variable">singleTop</span> <span class="hljs-operator">=</span>  <br>      containsFlag(intent, Intent.FLAG_ACTIVITY_SINGLE_TOP)  <br>          || activityInfo.launchMode == ActivityInfo.LAUNCH_SINGLE_TOP;  <br>  <span class="hljs-type">boolean</span> <span class="hljs-variable">newTask</span> <span class="hljs-operator">=</span> containsFlag(intent, Intent.FLAG_ACTIVITY_NEW_TASK);  <br>  <span class="hljs-type">boolean</span> <span class="hljs-variable">clearTop</span> <span class="hljs-operator">=</span> containsFlag(intent, Intent.FLAG_ACTIVITY_CLEAR_TOP);  <br>  <span class="hljs-type">boolean</span> <span class="hljs-variable">clearTask</span> <span class="hljs-operator">=</span> containsFlag(intent, Intent.FLAG_ACTIVITY_CLEAR_TASK);  <br>  <br>  <span class="hljs-type">TaskRecord</span> <span class="hljs-variable">taskRecord</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br>  <span class="hljs-keyword">switch</span> (activityInfo.launchMode) &#123;  <br>    <span class="hljs-keyword">case</span> ActivityInfo.LAUNCH_SINGLE_TOP:  <br>    <span class="hljs-keyword">case</span> ActivityInfo.LAUNCH_MULTIPLE:  <br>    <span class="hljs-keyword">case</span> ActivityInfo.LAUNCH_SINGLE_TASK:  <br>      taskRecord = findTaskRecordByTaskAffinityLocked(userId, taskAffinity);  <br>      <span class="hljs-keyword">if</span> (taskRecord == <span class="hljs-literal">null</span> &amp;&amp; !newTask) &#123;  <br>        taskRecord = sourceTask;  <br>      &#125;  <br>      <span class="hljs-keyword">break</span>;  <br>    <span class="hljs-keyword">case</span> ActivityInfo.LAUNCH_SINGLE_INSTANCE:  <br>      taskRecord = findTaskRecordByTaskAffinityLocked(userId, taskAffinity);  <br>      <span class="hljs-keyword">break</span>;  <br>  &#125;  <br>  <br>  <span class="hljs-comment">// 如果还没有task则新启动一个task  </span><br>  <span class="hljs-keyword">if</span> (taskRecord == <span class="hljs-literal">null</span> || taskRecord.needNewTask()) &#123;  <br>    <span class="hljs-keyword">return</span> startActivityInNewTaskLocked(userId, intent, activityInfo, resultTo, launchModeFlags);  <br>  &#125;  <br>  <span class="hljs-comment">// 移至前台  </span><br>  mAms.moveTaskToFront(taskRecord.id, <span class="hljs-number">0</span>);  <br>  <br>  <span class="hljs-type">boolean</span> <span class="hljs-variable">notStartToFront</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;  <br>  <span class="hljs-keyword">if</span> (clearTop || singleTop || clearTask) &#123;  <br>    notStartToFront = <span class="hljs-literal">true</span>;  <br>  &#125;  <br>  <br>  <span class="hljs-type">boolean</span> <span class="hljs-variable">startTaskToFront</span> <span class="hljs-operator">=</span>  <br>      !notStartToFront  <br>          &amp;&amp; ComponentUtils.intentFilterEquals(taskRecord.rootIntent, intent)  <br>          &amp;&amp; taskRecord.rootIntent.getFlags() == intent.getFlags();  <br>  <br>  <span class="hljs-keyword">if</span> (startTaskToFront) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>  <br>  <span class="hljs-type">ActivityRecord</span> <span class="hljs-variable">topActivityRecord</span> <span class="hljs-operator">=</span> taskRecord.getTopActivityRecord();  <br>  <span class="hljs-type">ActivityRecord</span> <span class="hljs-variable">targetActivityRecord</span> <span class="hljs-operator">=</span>  <br>      findActivityRecordByComponentName(userId, ComponentUtils.toComponentName(activityInfo));  <br>  <span class="hljs-type">ActivityRecord</span> <span class="hljs-variable">newIntentRecord</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br>  <span class="hljs-type">boolean</span> <span class="hljs-variable">ignore</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;  <br>  <br>  <span class="hljs-keyword">if</span> (clearTop) &#123;  <br>    <span class="hljs-keyword">if</span> (targetActivityRecord != <span class="hljs-literal">null</span>) &#123;  <br>      <span class="hljs-comment">// 目标栈上面所有activity出栈  </span><br>      <span class="hljs-keyword">synchronized</span> (targetActivityRecord.task.activities) &#123;  <br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> targetActivityRecord.task.activities.size() - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) &#123;  <br>          <span class="hljs-type">ActivityRecord</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> targetActivityRecord.task.activities.get(i);  <br>          <span class="hljs-keyword">if</span> (next != targetActivityRecord) &#123;  <br>            next.finished = <span class="hljs-literal">true</span>;  <br>            Log.d(TAG, <span class="hljs-string">&quot;makerFinish: &quot;</span> + next.component.toString());  <br>          &#125; <span class="hljs-keyword">else</span> &#123;  <br>            <span class="hljs-keyword">if</span> (singleTop) &#123;  <br>              newIntentRecord = targetActivityRecord;  <br>            &#125; <span class="hljs-keyword">else</span> &#123;  <br>              <span class="hljs-comment">// clearTop并且不是singleTop，目标也finish，重建。  </span><br>              targetActivityRecord.finished = <span class="hljs-literal">true</span>;  <br>            &#125;  <br>            <span class="hljs-keyword">break</span>;  <br>          &#125;  <br>        &#125;  <br>      &#125;  <br>    &#125;  <br>  &#125;  <br>  <br>  <span class="hljs-keyword">if</span> (singleTop &amp;&amp; !clearTop) &#123;  <br>    <span class="hljs-keyword">if</span> (ComponentUtils.intentFilterEquals(topActivityRecord.intent, intent)) &#123;  <br>      newIntentRecord = topActivityRecord;  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>      <span class="hljs-keyword">synchronized</span> (mLaunchingActivities) &#123;  <br>        <span class="hljs-keyword">for</span> (ActivityRecord launchingActivity : mLaunchingActivities) &#123;  <br>          <span class="hljs-keyword">if</span> (!launchingActivity.finished  <br>              &amp;&amp; launchingActivity.component.equals(intent.getComponent())) &#123;  <br>            <span class="hljs-comment">// todo update onNewIntent from intent  </span><br>            ignore = <span class="hljs-literal">true</span>;  <br>          &#125;  <br>        &#125;  <br>      &#125;  <br>    &#125;  <br>  &#125;  <br>  <br>  <span class="hljs-keyword">if</span> (activityInfo.launchMode == ActivityInfo.LAUNCH_SINGLE_TASK &amp;&amp; !clearTop) &#123;  <br>    <span class="hljs-keyword">if</span> (ComponentUtils.intentFilterEquals(topActivityRecord.intent, intent)) &#123;  <br>      newIntentRecord = topActivityRecord;  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>      <span class="hljs-type">ActivityRecord</span> <span class="hljs-variable">record</span> <span class="hljs-operator">=</span>  <br>          findActivityRecordByComponentName(userId, ComponentUtils.toComponentName(activityInfo));  <br>      <span class="hljs-keyword">if</span> (record != <span class="hljs-literal">null</span>) &#123;  <br>        <span class="hljs-comment">// 需要调用目标onNewIntent  </span><br>        newIntentRecord = record;  <br>        <span class="hljs-comment">// 目标栈上面所有activity出栈  </span><br>        <span class="hljs-keyword">synchronized</span> (taskRecord.activities) &#123;  <br>          <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> taskRecord.activities.size() - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) &#123;  <br>            <span class="hljs-type">ActivityRecord</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> taskRecord.activities.get(i);  <br>            <span class="hljs-keyword">if</span> (next != record) &#123;  <br>              next.finished = <span class="hljs-literal">true</span>;  <br>            &#125; <span class="hljs-keyword">else</span> &#123;  <br>              <span class="hljs-keyword">break</span>;  <br>            &#125;  <br>          &#125;  <br>        &#125;  <br>      &#125;  <br>    &#125;  <br>  &#125;  <br>  <br>  <span class="hljs-keyword">if</span> (activityInfo.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE) &#123;  <br>    newIntentRecord = topActivityRecord;  <br>  &#125;  <br>  <br>  <span class="hljs-comment">// clearTask finish All  </span><br>  <span class="hljs-keyword">if</span> (clearTask &amp;&amp; newTask) &#123;  <br>    <span class="hljs-keyword">for</span> (ActivityRecord activity : taskRecord.activities) &#123;  <br>      activity.finished = <span class="hljs-literal">true</span>;  <br>    &#125;  <br>  &#125;  <br>  <br>  finishAllActivity(userId);  <br>  <br>  <span class="hljs-keyword">if</span> (newIntentRecord != <span class="hljs-literal">null</span>) &#123;  <br>    <span class="hljs-comment">// 通知onNewIntent  </span><br>    deliverNewIntentLocked(newIntentRecord, intent);  <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ignore) &#123;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>  &#125;  <br>  <br>  <span class="hljs-keyword">if</span> (resultTo == <span class="hljs-literal">null</span>) &#123;  <br>    <span class="hljs-type">ActivityRecord</span> <span class="hljs-variable">top</span> <span class="hljs-operator">=</span> taskRecord.getTopActivityRecord();  <br>    <span class="hljs-keyword">if</span> (top != <span class="hljs-literal">null</span>) &#123;  <br>      resultTo = top.token;  <br>    &#125;  <br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sourceTask != <span class="hljs-literal">null</span>) &#123;  <br>    <span class="hljs-type">ActivityRecord</span> <span class="hljs-variable">top</span> <span class="hljs-operator">=</span> sourceTask.getTopActivityRecord();  <br>    <span class="hljs-keyword">if</span> (top != <span class="hljs-literal">null</span>) &#123;  <br>      resultTo = top.token;  <br>    &#125;  <br>  &#125;  <br>  <span class="hljs-keyword">return</span> startActivityInSourceTask(  <br>      intent,  <br>      resolvedType,  <br>      resultTo,  <br>      resultWho,  <br>      requestCode,  <br>      flags,  <br>      options,  <br>      userId,  <br>      topActivityRecord,  <br>      activityInfo,  <br>      launchModeFlags);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>首先我们关注 <code>startActivityInNewTaskLocked</code> ，对于那些需要新启动的情况，使用该函数创建对应的任务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">startActivityInNewTaskLocked</span><span class="hljs-params">(  </span><br><span class="hljs-params">    <span class="hljs-type">int</span> userId, Intent intent, ActivityInfo activityInfo, IBinder resultTo, <span class="hljs-type">int</span> launchMode)</span> &#123;  <br>  <span class="hljs-type">ActivityRecord</span> <span class="hljs-variable">record</span> <span class="hljs-operator">=</span> newActivityRecord(intent, activityInfo, resultTo, userId);  <br>  <span class="hljs-type">Intent</span> <span class="hljs-variable">shadow</span> <span class="hljs-operator">=</span> startActivityProcess(userId, intent, activityInfo, record);  <br>  <br>  shadow.addFlags(Intent.FLAG_ACTIVITY_MULTIPLE_TASK);  <br>  shadow.addFlags(Intent.FLAG_ACTIVITY_NEW_DOCUMENT);  <br>  shadow.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);  <br>  shadow.addFlags(launchMode);  <br>  <br>  SandBoxCore.getContext().startActivity(shadow);  <br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>该函数创建了一个 <code>shadow</code> ，它实际上是用来创建一个虚假的 <code>Intent</code> 的，我们往下跟踪 <code>startActivityProcess</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Intent <span class="hljs-title function_">startActivityProcess</span><span class="hljs-params">(  </span><br><span class="hljs-params">    <span class="hljs-type">int</span> userId, Intent intent, ActivityInfo info, ActivityRecord record)</span> &#123;  <br>  <span class="hljs-type">ProxyActivityRecord</span> <span class="hljs-variable">stubRecord</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyActivityRecord</span>(userId, info, intent, record);  <br>  <span class="hljs-type">ProcessRecord</span> <span class="hljs-variable">targetApp</span> <span class="hljs-operator">=</span>  <br>      BProcessManagerService.get()  <br>          .startProcessLocked(  <br>              info.packageName, info.processName, userId, -<span class="hljs-number">1</span>, Binder.getCallingPid());  <br>  <span class="hljs-keyword">if</span> (targetApp == <span class="hljs-literal">null</span>) &#123;  <br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Unable to create process, name:&quot;</span> + info.name);  <br>  &#125;  <br>  <span class="hljs-keyword">return</span> getStartStubActivityIntentInner(intent, targetApp.bpid, userId, stubRecord, info);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>targetApp</code> 初始化了我们将要启动的目标应用的相关信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> ProcessRecord <span class="hljs-title function_">startProcessLocked</span><span class="hljs-params">(  </span><br><span class="hljs-params">    String packageName, String processName, <span class="hljs-type">int</span> userId, <span class="hljs-type">int</span> bpid, <span class="hljs-type">int</span> callingPid)</span> &#123;  <br>  <span class="hljs-type">ApplicationInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> BPackageManagerService.get().getApplicationInfo(packageName, <span class="hljs-number">0</span>, userId);  <br>  <span class="hljs-keyword">if</span> (info == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <br>  ProcessRecord app;  <br>  <span class="hljs-type">int</span> <span class="hljs-variable">buid</span> <span class="hljs-operator">=</span> BUserHandle.getUid(userId, BPackageManagerService.get().getAppId(packageName));  <br>  <span class="hljs-keyword">synchronized</span> (mProcessLock) &#123;  <br>    Map&lt;String, ProcessRecord&gt; bProcess = mProcessMap.get(buid);  <br>  <br>    <span class="hljs-keyword">if</span> (bProcess == <span class="hljs-literal">null</span>) &#123;  <br>      bProcess = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <br>    &#125;  <br>    <span class="hljs-keyword">if</span> (bpid == -<span class="hljs-number">1</span>) &#123;  <br>      app = bProcess.get(processName);  <br>      <span class="hljs-keyword">if</span> (app != <span class="hljs-literal">null</span>) &#123;  <br>        <span class="hljs-keyword">if</span> (app.initLock != <span class="hljs-literal">null</span>) &#123;  <br>          app.initLock.block();  <br>        &#125;  <br>        <span class="hljs-keyword">if</span> (app.bActivityThread != <span class="hljs-literal">null</span>) &#123;  <br>          <span class="hljs-keyword">return</span> app;  <br>        &#125;  <br>      &#125;  <br>      bpid = getUsingBPidL();  <br>      Slog.d(TAG, <span class="hljs-string">&quot;init bUid = &quot;</span> + buid + <span class="hljs-string">&quot;, bPid = &quot;</span> + bpid);  <br>    &#125;  <br>    <span class="hljs-keyword">if</span> (bpid == -<span class="hljs-number">1</span>) &#123;  <br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;No processes available&quot;</span>);  <br>    &#125;  <br>    app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessRecord</span>(info, processName);  <br>    app.uid = Process.myUid();  <br>    app.bpid = bpid;  <br>    app.buid = BPackageManagerService.get().getAppId(packageName);  <br>    app.callingBUid = getBUidByPidOrPackageName(callingPid, packageName);  <br>    app.userId = userId;  <br>  <br>    bProcess.put(processName, app);  <br>    mPidsSelfLocked.add(app);  <br>  <br>    <span class="hljs-keyword">synchronized</span> (mProcessMap) &#123;  <br>      mProcessMap.put(buid, bProcess);  <br>    &#125;  <br>    <span class="hljs-keyword">if</span> (!initAppProcessL(app)) &#123;  <br>      <span class="hljs-comment">// init process fail  </span><br>      bProcess.remove(processName);  <br>      mPidsSelfLocked.remove(app);  <br>      app = <span class="hljs-literal">null</span>;  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>      app.pid = getPid(SandBoxCore.getContext(), ProxyManifest.getProcessName(app.bpid));  <br>    &#125;  <br>  &#125;  <br>  <span class="hljs-keyword">return</span> app;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到主要就是一些 ID 的初始化，不过注意，其中 bpid 指的其实是对 Blackbox 来说的进程 ID ，因为对系统来说只有 Blackbox 这一个进程，但是对 Blackbox 来说却需要管理其中启动的不同应用。</p>
<p>其中还包括了一个 <code>initAppProcessL</code> 用来初始化 app：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">initAppProcessL</span><span class="hljs-params">(ProcessRecord record)</span> &#123;  <br>  Log.d(TAG, <span class="hljs-string">&quot;initProcess: &quot;</span> + record.processName);  <br>  <span class="hljs-type">AppConfig</span> <span class="hljs-variable">appConfig</span> <span class="hljs-operator">=</span> record.getClientConfig();  <br>  <span class="hljs-type">Bundle</span> <span class="hljs-variable">bundle</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bundle</span>();  <br>  bundle.putParcelable(AppConfig.KEY, appConfig);  <br>  <span class="hljs-type">Bundle</span> <span class="hljs-variable">init</span> <span class="hljs-operator">=</span>  <br>      ProviderCall.callSafely(  <br>          record.getProviderAuthority(), <span class="hljs-string">&quot;_Black_|_init_process_&quot;</span>, <span class="hljs-literal">null</span>, bundle);  <br>  <span class="hljs-type">IBinder</span> <span class="hljs-variable">appThread</span> <span class="hljs-operator">=</span> BundleCompat.getBinder(init, <span class="hljs-string">&quot;_Black_|_client_&quot;</span>);  <br>  <span class="hljs-keyword">if</span> (appThread == <span class="hljs-literal">null</span> || !appThread.isBinderAlive()) &#123;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <br>  &#125;  <br>  attachClientL(record, appThread);  <br>  <br>  createProc(record);  <br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>这是一个通过 Binder 来调用 <code>initprocess</code> 函数的接口函数，对应调用为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span>  <br><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> Bundle <span class="hljs-title function_">call</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> String method, <span class="hljs-meta">@Nullable</span> String arg, <span class="hljs-meta">@Nullable</span> Bundle extras)</span> &#123;  <br>  <span class="hljs-keyword">if</span> (method.equals(<span class="hljs-string">&quot;_Black_|_init_process_&quot;</span>)) &#123;  <br>    <span class="hljs-keyword">assert</span> extras != <span class="hljs-literal">null</span>;  <br>    extras.setClassLoader(AppConfig.class.getClassLoader());  <br>    <span class="hljs-type">AppConfig</span> <span class="hljs-variable">appConfig</span> <span class="hljs-operator">=</span> extras.getParcelable(AppConfig.KEY);  <br>    BActivityThread.currentActivityThread().initProcess(appConfig);  <br>  <br>    <span class="hljs-type">Bundle</span> <span class="hljs-variable">bundle</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bundle</span>();  <br>    BundleCompat.putBinder(bundle, <span class="hljs-string">&quot;_Black_|_client_&quot;</span>, BActivityThread.currentActivityThread());  <br>    <span class="hljs-keyword">return</span> bundle;  <br>  &#125;  <br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.call(method, arg, extras);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>向下调用 <code>initProcess</code> 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initProcess</span><span class="hljs-params">(AppConfig appConfig)</span> &#123;  <br>  <span class="hljs-keyword">synchronized</span> (mConfigLock) &#123;  <br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.mAppConfig != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-built_in">this</span>.mAppConfig.packageName.equals(appConfig.packageName)) &#123;  <br>      <span class="hljs-comment">// 该进程已被attach  </span><br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(  <br>          <span class="hljs-string">&quot;reject init process: &quot;</span>  <br>              + appConfig.processName  <br>              + <span class="hljs-string">&quot;, this process is : &quot;</span>  <br>              + <span class="hljs-built_in">this</span>.mAppConfig.processName);  <br>    &#125;  <br>    <span class="hljs-built_in">this</span>.mAppConfig = appConfig;  <br>    <span class="hljs-type">IBinder</span> <span class="hljs-variable">iBinder</span> <span class="hljs-operator">=</span> asBinder();  <br>    <span class="hljs-keyword">try</span> &#123;  <br>      iBinder.linkToDeath(  <br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeathRecipient</span>() &#123;  <br>            <span class="hljs-meta">@Override</span>  <br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">binderDied</span><span class="hljs-params">()</span> &#123;  <br>              <span class="hljs-keyword">synchronized</span> (mConfigLock) &#123;  <br>                <span class="hljs-keyword">try</span> &#123;  <br>                  iBinder.linkToDeath(<span class="hljs-built_in">this</span>, <span class="hljs-number">0</span>);  <br>                &#125; <span class="hljs-keyword">catch</span> (RemoteException ignored) &#123;  <br>                &#125;  <br>                mAppConfig = <span class="hljs-literal">null</span>;  <br>              &#125;  <br>            &#125;  <br>          &#125;,  <br>          <span class="hljs-number">0</span>);  <br>    &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;  <br>      e.printStackTrace();  <br>    &#125;  <br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里将 <code>appConfig</code> 设置到了 <code>BActivityThread</code> 对象里去。</p>
<p>然后再调用 <code>getStartStubActivityIntentInner</code> ，不过参数其实只有刚才的 <code>bpid</code>，对应参数中的 <code>vpid</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Intent <span class="hljs-title function_">getStartStubActivityIntentInner</span><span class="hljs-params">(  </span><br><span class="hljs-params">    Intent intent, <span class="hljs-type">int</span> vpid, <span class="hljs-type">int</span> userId, ProxyActivityRecord target, ActivityInfo activityInfo)</span> &#123;  <br>  <span class="hljs-type">Intent</span> <span class="hljs-variable">shadow</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>();  <br>  <span class="hljs-type">TypedArray</span> <span class="hljs-variable">typedArray</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br>  <span class="hljs-keyword">try</span> &#123;  <br>    <span class="hljs-type">Resources</span> <span class="hljs-variable">resources</span> <span class="hljs-operator">=</span>  <br>        PackageManagerCompat.getResources(SandBoxCore.getContext(), activityInfo.applicationInfo);  <br>    <span class="hljs-type">int</span> id;  <br>    <span class="hljs-keyword">if</span> (activityInfo.theme != <span class="hljs-number">0</span>) &#123;  <br>      id = activityInfo.theme;  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>      id = activityInfo.applicationInfo.theme;  <br>    &#125;  <br>    <span class="hljs-keyword">assert</span> resources != <span class="hljs-literal">null</span>;  <br>    typedArray = resources.newTheme().obtainStyledAttributes(id, BRRstyleable.get().Window());  <br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">windowIsTranslucent</span> <span class="hljs-operator">=</span>  <br>        typedArray.getBoolean(BRRstyleable.get().Window_windowIsTranslucent(), <span class="hljs-literal">false</span>);  <br>    <span class="hljs-keyword">if</span> (windowIsTranslucent) &#123;  <br>    <span class="hljs-comment">// 使用 vpid 查找</span><br>      shadow.setComponent(  <br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(  <br>              SandBoxCore.getHostPkg(), ProxyManifest.TransparentProxyActivity(vpid)));  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>    <span class="hljs-comment">// 使用 vpid 查找</span><br>      shadow.setComponent(  <br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(SandBoxCore.getHostPkg(), ProxyManifest.getProxyActivity(vpid)));  <br>    &#125;  <br>    Slog.d(TAG, activityInfo + <span class="hljs-string">&quot;, windowIsTranslucent: &quot;</span> + windowIsTranslucent);  <br>  &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;  <br>    e.printStackTrace();  <br>    shadow.setComponent(  <br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(SandBoxCore.getHostPkg(), ProxyManifest.getProxyActivity(vpid)));  <br>  &#125; <span class="hljs-keyword">finally</span> &#123;  <br>    <span class="hljs-keyword">if</span> (typedArray != <span class="hljs-literal">null</span>) &#123;  <br>      typedArray.recycle();  <br>    &#125;  <br>  &#125;  <br>  ProxyActivityRecord.saveStub(  <br>      shadow, intent, target.mActivityInfo, target.mActivityRecord, target.mUserId);  <br>  <span class="hljs-keyword">return</span> shadow;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个 vpid 参数会用来查找 Blackbox 提前在 Manifest 中占坑的 Activity ：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">activity</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.proxy.ProxyActivity$P0&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:configChanges</span>=<span class="hljs-string">&quot;mcc|mnc|locale|touchscreen|keyboard|keyboardHidden|navigation|orientation|screenLayout|uiMode|screenSize|smallestScreenSize|fontScale&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:exported</span>=<span class="hljs-string">&quot;true&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:process</span>=<span class="hljs-string">&quot;:p0&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:supportsPictureInPicture</span>=<span class="hljs-string">&quot;true&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:taskAffinity</span>=<span class="hljs-string">&quot;com.hello.sandbox.task_affinity&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:theme</span>=<span class="hljs-string">&quot;@style/BTheme&quot;</span> /&gt;</span>  <br><span class="hljs-tag">&lt;<span class="hljs-name">activity</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.proxy.ProxyActivity$P1&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:configChanges</span>=<span class="hljs-string">&quot;mcc|mnc|locale|touchscreen|keyboard|keyboardHidden|navigation|orientation|screenLayout|uiMode|screenSize|smallestScreenSize|fontScale&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:exported</span>=<span class="hljs-string">&quot;true&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:process</span>=<span class="hljs-string">&quot;:p1&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:supportsPictureInPicture</span>=<span class="hljs-string">&quot;true&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:taskAffinity</span>=<span class="hljs-string">&quot;com.hello.sandbox.task_affinity&quot;</span>  </span><br><span class="hljs-tag">  <span class="hljs-attr">android:theme</span>=<span class="hljs-string">&quot;@style/BTheme&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure>

<p>这样的 Activity 总共有 50 个，相当于 Blackbox 最多能支持同时启动 50 个内部应用。</p>
<p>这个操作相当于构造了一个用于启动 <code>ProxyActivity</code> 的 <code>Intent</code>，最终再将这个对象传给系统 AMS 来启动它：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">SandBoxCore.getContext().startActivity(shadow);<br></code></pre></td></tr></table></figure>

<p>AMS 收到这个请求后自然是正常启动这个 Activity 了，因为所有行为都合法。但是当 AMS 完成了相关启动后，在前文我们提到过，会给这个新的 Activity 发一个  <code>H.EXECUTE_TRANSACTION</code> 命令，而这个命令会被 <code>handleLaunchActivity</code> 处理，但是这个函数其实在之前是被 Hook 掉了的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">addInjector(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HCallbackProxy</span>());<br></code></pre></td></tr></table></figure>

<p>这个 HCallbackProxy 中是这样注入的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Handler <span class="hljs-title function_">getH</span><span class="hljs-params">()</span> &#123;  <br>  <span class="hljs-type">Object</span> <span class="hljs-variable">currentActivityThread</span> <span class="hljs-operator">=</span> SandBoxCore.mainThread();  <br>  <span class="hljs-keyword">return</span> BRActivityThread.get(currentActivityThread).mH();  <br>&#125;<br><span class="hljs-keyword">private</span> Handler.Callback <span class="hljs-title function_">getHCallback</span><span class="hljs-params">()</span> &#123;  <br>  <span class="hljs-keyword">return</span> BRHandler.get(getH()).mCallback();  <br>&#125;<br><br><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">injectHook</span><span class="hljs-params">()</span> &#123;  <br>  mOtherCallback = getHCallback();  <br>  <span class="hljs-keyword">if</span> (mOtherCallback != <span class="hljs-literal">null</span>  <br>      &amp;&amp; (mOtherCallback == <span class="hljs-built_in">this</span>  <br>          || mOtherCallback.getClass().getName().equals(<span class="hljs-built_in">this</span>.getClass().getName()))) &#123;  <br>    mOtherCallback = <span class="hljs-literal">null</span>;  <br>  &#125;  <br>  BRHandler.get(getH())._set_mCallback(<span class="hljs-built_in">this</span>);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>最终是把 <code>mCallback</code> 对象用 <code>HCallbackProxy</code> 给替换掉了，从而把下面的消息处理函数 <code>handleMessage</code> 给换掉了。不过如果不是我们需要处理的消息，会重新调用原本的函数来处理。</p>
<p>最终调用自己实现的 <code>handleLaunchActivity</code> 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleBindApplication</span><span class="hljs-params">(String packageName, String processName)</span> &#123;  <br>  <span class="hljs-keyword">if</span> (isInit()) <span class="hljs-keyword">return</span>;  <br>  <span class="hljs-keyword">try</span> &#123;  <br>    CrashHandler.create();  <br>  &#125; <span class="hljs-keyword">catch</span> (Throwable ignored) &#123;  <br>  &#125;  <br>  <br>  <span class="hljs-type">PackageInfo</span> <span class="hljs-variable">packageInfo</span> <span class="hljs-operator">=</span>  <br>      SandBoxCore.getBPackageManager()  <br>          .getPackageInfo(packageName, PackageManager.GET_PROVIDERS, BActivityThread.getUserId());  <br>  <span class="hljs-type">ApplicationInfo</span> <span class="hljs-variable">applicationInfo</span> <span class="hljs-operator">=</span> packageInfo.applicationInfo;  <br>  <span class="hljs-keyword">if</span> (packageInfo.providers == <span class="hljs-literal">null</span>) &#123;  <br>    packageInfo.providers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProviderInfo</span>[] &#123;&#125;;  <br>  &#125;  <br>  mProviders.addAll(Arrays.asList(packageInfo.providers));  <br>  Slog.d(TAG, <span class="hljs-string">&quot;handleBindApplication mProviders=&quot;</span> + mProviders);  <br>  <br>  <span class="hljs-type">Object</span> <span class="hljs-variable">boundApplication</span> <span class="hljs-operator">=</span> BRActivityThread.get(SandBoxCore.mainThread()).mBoundApplication();  <br>  <br>  <span class="hljs-type">Context</span> <span class="hljs-variable">packageContext</span> <span class="hljs-operator">=</span> createPackageContext(applicationInfo);  <br>  <span class="hljs-type">Object</span> <span class="hljs-variable">loadedApk</span> <span class="hljs-operator">=</span> BRContextImpl.get(packageContext).mPackageInfo();  <br>  BRLoadedApk.get(loadedApk)._set_mSecurityViolation(<span class="hljs-literal">false</span>);  <br>  <span class="hljs-comment">// fix applicationInfo  </span><br>  BRLoadedApk.get(loadedApk)._set_mApplicationInfo(applicationInfo);  <br>  <br>  <span class="hljs-type">int</span> <span class="hljs-variable">targetSdkVersion</span> <span class="hljs-operator">=</span> applicationInfo.targetSdkVersion;  <br>  <span class="hljs-keyword">if</span> (targetSdkVersion &lt; Build.VERSION_CODES.GINGERBREAD) &#123;  <br>    StrictMode.<span class="hljs-type">ThreadPolicy</span> <span class="hljs-variable">newPolicy</span> <span class="hljs-operator">=</span>  <br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMode</span>.ThreadPolicy.Builder(StrictMode.getThreadPolicy()).permitNetwork().build();  <br>    StrictMode.setThreadPolicy(newPolicy);  <br>  &#125;  <br>  <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;  <br>    <span class="hljs-keyword">if</span> (targetSdkVersion &lt; Build.VERSION_CODES.N) &#123;  <br>      StrictModeCompat.disableDeathOnFileUriExposure();  <br>    &#125;  <br>  &#125;  <br>  <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) &#123;  <br>    WebView.setDataDirectorySuffix(getUserId() + <span class="hljs-string">&quot;:&quot;</span> + packageName + <span class="hljs-string">&quot;:&quot;</span> + processName);  <br>  &#125;  <br>  <br>  VirtualRuntime.setupRuntime(processName, applicationInfo);  <br>  <br>  BRVMRuntime.get(BRVMRuntime.get().getRuntime())  <br>      .setTargetSdkVersion(applicationInfo.targetSdkVersion);  <br>  <span class="hljs-keyword">if</span> (BuildCompat.isS()) &#123;  <br>    BRCompatibility.get().setTargetSdkVersion(applicationInfo.targetSdkVersion);  <br>  &#125;  <br>  <br>  NativeCore.init(Build.VERSION.SDK_INT);  <br>  <span class="hljs-keyword">assert</span> packageContext != <span class="hljs-literal">null</span>;  <br>  IOCore.get().enableRedirect(packageContext);  <br>  <br>  <span class="hljs-type">AppBindData</span> <span class="hljs-variable">bindData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppBindData</span>();  <br>  bindData.appInfo = applicationInfo;  <br>  bindData.processName = processName;  <br>  bindData.info = loadedApk;  <br>  bindData.providers = mProviders;  <br>  <br>  <span class="hljs-type">ActivityThreadAppBindDataContext</span> <span class="hljs-variable">activityThreadAppBindData</span> <span class="hljs-operator">=</span>  <br>      BRActivityThreadAppBindData.get(boundApplication);  <br>  activityThreadAppBindData._set_instrumentationName(  <br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(bindData.appInfo.packageName, Instrumentation.class.getName()));  <br>  activityThreadAppBindData._set_appInfo(bindData.appInfo);  <br>  activityThreadAppBindData._set_info(bindData.info);  <br>  activityThreadAppBindData._set_processName(bindData.processName);  <br>  activityThreadAppBindData._set_providers(bindData.providers);  <br>  <br>  mBoundApplication = bindData;  <br>  <br>  <span class="hljs-comment">// ssl适配  </span><br>  <span class="hljs-keyword">if</span> (BRNetworkSecurityConfigProvider.getRealClass() != <span class="hljs-literal">null</span>) &#123;  <br>    Security.removeProvider(<span class="hljs-string">&quot;AndroidNSSP&quot;</span>);  <br>    BRNetworkSecurityConfigProvider.get().install(packageContext);  <br>  &#125;  <br>  Application application;  <br>  <span class="hljs-keyword">try</span> &#123;  <br>    onBeforeCreateApplication(packageName, processName, packageContext);  <br>    <span class="hljs-keyword">if</span> (BuildCompat.isT())&#123;  <br>      BEnvironment.getAllDex(packageName).forEach(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Consumer</span>&lt;String&gt;() &#123;  <br>        <span class="hljs-meta">@Override</span>  <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">accept</span><span class="hljs-params">(String s)</span> &#123;  <br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(s).setReadOnly();  <br>        &#125;  <br>      &#125;);  <br>    &#125;  <br>    application = BRLoadedApk.get(loadedApk).makeApplication(<span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);  <br>    mInitialApplication = application;  <br>    BRActivityThread.get(SandBoxCore.mainThread())._set_mInitialApplication(mInitialApplication);  <br>    ContextCompat.fix(  <br>        (Context) BRActivityThread.get(SandBoxCore.mainThread()).getSystemContext());  <br>    ContextCompat.fix(mInitialApplication);  <br><br>    installProviders(mInitialApplication, bindData.processName, bindData.providers);  <br>    <span class="hljs-keyword">try</span> &#123;  <br>      fixAiLiaoPhoto(mInitialApplication);  <br>    &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;  <br>      e.printStackTrace();  <br>    &#125;  <br>    onBeforeApplicationOnCreate(packageName, processName, application);  <br>    AppInstrumentation.get().callApplicationOnCreate(application);  <br>    onAfterApplicationOnCreate(packageName, processName, application);  <br>    NativeCore.init_seccomp();  <br>    HookManager.get().checkEnv(HCallbackProxy.class);  <br><br>    <span class="hljs-keyword">if</span> (BuildConfig.DEBUG) &#123;  <br>      Log.d(  <br>          TAG,  <br>          <span class="hljs-string">&quot;Instrumentation class name &quot;</span>  <br>              + AppInstrumentation.get().getCurrInstrumentation().getClass().getName());  <br>    &#125;  <br>  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;  <br>    e.printStackTrace();  <br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Unable to makeApplication&quot;</span>, e);  <br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>看起来似乎有些复杂，这里稍微总结一下。</p>
<p>首先 <code>handleLaunchActivity</code> 这个函数会有多次调用，不只是收到 <code>LAUNCH_ACTIVITY</code> 时，还有 <code>EXECUTE_TRANSACTION</code> 的时候也一样会调用（似乎是兼容版本），因此看着流程里会有多次提前返回，是因为时机还没到。</p>
<p>以及我们知道，一个 APP 在启动时有可能会创建多个 Activity，第一个创建的 <code>Activity</code> 需要额外的调用 <code>bindApplication</code> 去绑定 <code>Application</code> 对象，这个也是我们前文正常流程里提到过的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleBindApplication</span><span class="hljs-params">(String packageName, String processName)</span> &#123;  <br>  <span class="hljs-keyword">if</span> (isInit()) <span class="hljs-keyword">return</span>;  <br>  <span class="hljs-keyword">try</span> &#123;  <br>    CrashHandler.create();  <br>  &#125; <span class="hljs-keyword">catch</span> (Throwable ignored) &#123;  <br>  &#125;  <br>  <br>  <span class="hljs-type">PackageInfo</span> <span class="hljs-variable">packageInfo</span> <span class="hljs-operator">=</span>  <br>      SandBoxCore.getBPackageManager()  <br>          .getPackageInfo(packageName, PackageManager.GET_PROVIDERS, BActivityThread.getUserId());  <br>  <span class="hljs-type">ApplicationInfo</span> <span class="hljs-variable">applicationInfo</span> <span class="hljs-operator">=</span> packageInfo.applicationInfo;  <br>  <span class="hljs-keyword">if</span> (packageInfo.providers == <span class="hljs-literal">null</span>) &#123;  <br>    packageInfo.providers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProviderInfo</span>[] &#123;&#125;;  <br>  &#125;  <br>  mProviders.addAll(Arrays.asList(packageInfo.providers));  <br>  Slog.d(TAG, <span class="hljs-string">&quot;handleBindApplication mProviders=&quot;</span> + mProviders);  <br>  <br>  <span class="hljs-type">Object</span> <span class="hljs-variable">boundApplication</span> <span class="hljs-operator">=</span> BRActivityThread.get(SandBoxCore.mainThread()).mBoundApplication();  <br>  <br>  <span class="hljs-type">Context</span> <span class="hljs-variable">packageContext</span> <span class="hljs-operator">=</span> createPackageContext(applicationInfo);  <br>  <span class="hljs-type">Object</span> <span class="hljs-variable">loadedApk</span> <span class="hljs-operator">=</span> BRContextImpl.get(packageContext).mPackageInfo();  <br>  BRLoadedApk.get(loadedApk)._set_mSecurityViolation(<span class="hljs-literal">false</span>);  <br>  <span class="hljs-comment">// fix applicationInfo  </span><br>  BRLoadedApk.get(loadedApk)._set_mApplicationInfo(applicationInfo);  <br>  <br>  <span class="hljs-type">int</span> <span class="hljs-variable">targetSdkVersion</span> <span class="hljs-operator">=</span> applicationInfo.targetSdkVersion;  <br>  <span class="hljs-keyword">if</span> (targetSdkVersion &lt; Build.VERSION_CODES.GINGERBREAD) &#123;  <br>    StrictMode.<span class="hljs-type">ThreadPolicy</span> <span class="hljs-variable">newPolicy</span> <span class="hljs-operator">=</span>  <br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMode</span>.ThreadPolicy.Builder(StrictMode.getThreadPolicy()).permitNetwork().build();  <br>    StrictMode.setThreadPolicy(newPolicy);  <br>  &#125;  <br>  <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;  <br>    <span class="hljs-keyword">if</span> (targetSdkVersion &lt; Build.VERSION_CODES.N) &#123;  <br>      StrictModeCompat.disableDeathOnFileUriExposure();  <br>    &#125;  <br>  &#125;  <br>  <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) &#123;  <br>    WebView.setDataDirectorySuffix(getUserId() + <span class="hljs-string">&quot;:&quot;</span> + packageName + <span class="hljs-string">&quot;:&quot;</span> + processName);  <br>  &#125;  <br>  <br>  VirtualRuntime.setupRuntime(processName, applicationInfo);  <br>  <br>  BRVMRuntime.get(BRVMRuntime.get().getRuntime())  <br>      .setTargetSdkVersion(applicationInfo.targetSdkVersion);  <br>  <span class="hljs-keyword">if</span> (BuildCompat.isS()) &#123;  <br>    BRCompatibility.get().setTargetSdkVersion(applicationInfo.targetSdkVersion);  <br>  &#125;  <br>  <br>  NativeCore.init(Build.VERSION.SDK_INT);  <br>  <span class="hljs-keyword">assert</span> packageContext != <span class="hljs-literal">null</span>;  <br>  IOCore.get().enableRedirect(packageContext);  <br>  <br>  <span class="hljs-type">AppBindData</span> <span class="hljs-variable">bindData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppBindData</span>();  <br>  bindData.appInfo = applicationInfo;  <br>  bindData.processName = processName;  <br>  bindData.info = loadedApk;  <br>  bindData.providers = mProviders;  <br>  <br>  <span class="hljs-type">ActivityThreadAppBindDataContext</span> <span class="hljs-variable">activityThreadAppBindData</span> <span class="hljs-operator">=</span>  <br>      BRActivityThreadAppBindData.get(boundApplication);  <br>  activityThreadAppBindData._set_instrumentationName(  <br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(bindData.appInfo.packageName, Instrumentation.class.getName()));  <br>  activityThreadAppBindData._set_appInfo(bindData.appInfo);  <br>  activityThreadAppBindData._set_info(bindData.info);  <br>  activityThreadAppBindData._set_processName(bindData.processName);  <br>  activityThreadAppBindData._set_providers(bindData.providers);  <br>  <br>  mBoundApplication = bindData;  <br>  <br>  <span class="hljs-comment">// ssl适配  </span><br>  <span class="hljs-keyword">if</span> (BRNetworkSecurityConfigProvider.getRealClass() != <span class="hljs-literal">null</span>) &#123;  <br>    Security.removeProvider(<span class="hljs-string">&quot;AndroidNSSP&quot;</span>);  <br>    BRNetworkSecurityConfigProvider.get().install(packageContext);  <br>  &#125;  <br>  Application application;  <br>  <span class="hljs-keyword">try</span> &#123;  <br>    onBeforeCreateApplication(packageName, processName, packageContext);  <br>    <span class="hljs-keyword">if</span> (BuildCompat.isT())&#123;  <br>      BEnvironment.getAllDex(packageName).forEach(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Consumer</span>&lt;String&gt;() &#123;  <br>        <span class="hljs-meta">@Override</span>  <br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">accept</span><span class="hljs-params">(String s)</span> &#123;  <br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(s).setReadOnly();  <br>        &#125;  <br>      &#125;);  <br>    &#125;  <br>    application = BRLoadedApk.get(loadedApk).makeApplication(<span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);  <br>    mInitialApplication = application;  <br>    BRActivityThread.get(SandBoxCore.mainThread())._set_mInitialApplication(mInitialApplication);  <br>    ContextCompat.fix(  <br>        (Context) BRActivityThread.get(SandBoxCore.mainThread()).getSystemContext());  <br>    ContextCompat.fix(mInitialApplication);<br></code></pre></td></tr></table></figure>

<p>函数一样很长，总结一下内容：</p>
<ol>
<li>获取 APK 信息 <code>packageInfo</code> </li>
<li>修改  <code>LoadedApk</code> 中的 <code>mSecurityViolation</code> 和 <code>mApplicationInfo</code> 为目标应用</li>
<li>设置进程名和命令行中的参数名为目标函数 <code>VirtualRuntime.setupRuntime</code></li>
<li>设置 <code>TargetSdkVersion</code></li>
<li>初始化 Blackbox 自己的 sdk 动态库 <code>NativeCore.init</code></li>
<li>路径重定向 <code>IOCore.get().enableRedirect</code> </li>
<li>调用 <code>makeApplication</code>  以构建子程序包的 <code>Application</code> 对象，并且替换原来通过 Host Stub 生成的 <code>mInitialApplication</code>。注意，这个时候新生成的 <code>LoadedApk</code> 代表了目标应用，其中的很多资源路径全都被替换为目标应用的路径了，加载资源时将会从被替换后的路径去查找。</li>
<li>注册 Providers</li>
<li>通过 <code>callApplicationOnCreate</code> 调用 <code>Application</code> 下的 <code>OnCreate</code> ，这会创建或初始化对应的上下文、<code>Instrumentation</code>、<code>Application</code>，目标应用生命周期开始</li>
<li>初始化 seccomp，这是 Blackbox 后续提供的新功能，Virtualbox 是没有这个的 <code>NativeCore.init_seccomp</code></li>
</ol>
<p>在 <code>handleBindApplication</code> 完成后我们回到 <code>handleLaunchActivity</code> 继续往下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span>  <br>    BRIActivityManager.get(BRActivityManagerNative.get().getDefault())  <br>        .getTaskForActivity(token, <span class="hljs-literal">false</span>);  <br>SandBoxCore.getBActivityManager()  <br>    .onActivityCreated(taskId, token, stubRecord.mActivityRecord);<br></code></pre></td></tr></table></figure>

<p>这里有一个 <code>onActivityCreated</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onActivityCreated</span><span class="hljs-params">(  </span><br><span class="hljs-params">    ProcessRecord processRecord, <span class="hljs-type">int</span> taskId, IBinder token, ActivityRecord record)</span> &#123;  <br>  <span class="hljs-keyword">synchronized</span> (mLaunchingActivities) &#123;  <br>    mLaunchingActivities.remove(record);  <br>    mHandler.removeMessages(LAUNCH_TIME_OUT, record);  <br>  &#125;  <br>  <span class="hljs-keyword">synchronized</span> (mTasks) &#123;  <br>    synchronizeTasks();  <br>    <span class="hljs-type">TaskRecord</span> <span class="hljs-variable">taskRecord</span> <span class="hljs-operator">=</span> mTasks.get(taskId);  <br>    <span class="hljs-keyword">if</span> (taskRecord == <span class="hljs-literal">null</span>) &#123;  <br>      taskRecord =  <br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskRecord</span>(taskId, record.userId, ComponentUtils.getTaskAffinity(record.info));  <br>      taskRecord.rootIntent = record.intent;  <br>      mTasks.put(taskId, taskRecord);  <br>    &#125;  <br>    record.token = token;  <br>    record.processRecord = processRecord;  <br>    record.task = taskRecord;  <br>    taskRecord.addTopActivity(record);  <br>    Log.d(TAG, <span class="hljs-string">&quot;onActivityCreated : &quot;</span> + record.component.toString());  <br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>将 Activity 指定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">LaunchActivityItemContext</span> <span class="hljs-variable">launchActivityItemContext</span> <span class="hljs-operator">=</span> BRLaunchActivityItem.get(r); <br>launchActivityItemContext._set_mIntent(stubRecord.mTarget);  <br>launchActivityItemContext._set_mInfo(activityInfo);<br></code></pre></td></tr></table></figure>

<p>最后将 <code>mIntent</code> 和 <code>mInfo</code> 替换成目标应用。</p>
<p>这个函数从这一步结束后会返回一个 false，之前一直没注意到，但实际上当其返回 false 的时候，会回到原函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Message msg)</span> &#123;  <br>  <span class="hljs-keyword">if</span> (!mBeing.getAndSet(<span class="hljs-literal">true</span>)) &#123;  <br>    <span class="hljs-keyword">try</span> &#123;  <br>      <span class="hljs-keyword">if</span> (BuildCompat.isPie()) &#123;  <br>        <span class="hljs-keyword">if</span> (msg.what == BRActivityThreadH.get().EXECUTE_TRANSACTION()) &#123;  <br>          <span class="hljs-keyword">final</span> <span class="hljs-type">Boolean</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> handleLaunchActivity(msg);  <br>          <span class="hljs-keyword">if</span> (a != <span class="hljs-literal">null</span> &amp;&amp; a) &#123;  <br>            getH().sendMessageAtFrontOfQueue(Message.obtain(msg));  <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <br>          &#125;  <br>        &#125;  <br>      &#125; <span class="hljs-keyword">else</span> &#123;  <br>        <span class="hljs-keyword">if</span> (msg.what == BRActivityThreadH.get().LAUNCH_ACTIVITY()) &#123;  <br>          <span class="hljs-keyword">final</span> <span class="hljs-type">Boolean</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> handleLaunchActivity(msg);  <br>          <span class="hljs-keyword">if</span> (a != <span class="hljs-literal">null</span> &amp;&amp; a) &#123;  <br>            getH().sendMessageAtFrontOfQueue(Message.obtain(msg));  <br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <br>          &#125;  <br>        &#125;  <br>      &#125;  <br>      <span class="hljs-keyword">if</span> (msg.what == BRActivityThreadH.get().CREATE_SERVICE()) &#123;  <br>        <span class="hljs-keyword">return</span> handleCreateService(msg.obj);  <br>      &#125;  <br>      <span class="hljs-keyword">if</span> (mOtherCallback != <span class="hljs-literal">null</span>) &#123;  <br>        <span class="hljs-keyword">return</span> mOtherCallback.handleMessage(msg);  <br>      &#125;  <br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <br>    &#125; <span class="hljs-keyword">finally</span> &#123;  <br>      mBeing.set(<span class="hljs-literal">false</span>);  <br>    &#125;  <br>  &#125;  <br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>当 <code>handleLaunchActivity</code> 返回 false 后，程序继续往下执行 <code>mOtherCallback.handleMessage</code> ，这个 <code>mOtherCallback</code> 就是原本的那个处理对象，通过它来调用原本的那个 <code>handleLaunchActivity</code> 。</p>
<p>在原先的那个处理函数中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Activity <span class="hljs-title function_">handleLaunchActivity</span><span class="hljs-params">(ActivityClientRecord r,</span><br><span class="hljs-params">        PendingTransactionActions pendingActions, Intent customIntent)</span> &#123;  <br> 	<span class="hljs-comment">// 在创建Activity之前初始化</span><br>    <span class="hljs-keyword">if</span> (ThreadedRenderer.sRendererEnabled<br>            &amp;&amp; (r.activityInfo.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="hljs-number">0</span>) &#123;<br>        HardwareRenderer.preload();<br>    &#125;<br>    <span class="hljs-comment">// 获取WMS服务，初始化WindowManager</span><br>    WindowManagerGlobal.initialize();<br>    <span class="hljs-comment">// GraphicsEnvironment提示一个activity正在进程上启动</span><br>    GraphicsEnvironment.hintActivityLaunch();<br>    <span class="hljs-comment">// 启动Activity，调用ActivityThread#performLaunchActivity()</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Activity</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> performLaunchActivity(r, customIntent); <br>    <span class="hljs-keyword">return</span> a;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意这里的 <code>ActivityClientRecord</code> 被传进了 <code>performLaunchActivity</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Activity <span class="hljs-title function_">performLaunchActivity</span><span class="hljs-params">(ActivityClientRecord r, Intent customIntent)</span> &#123;<br>    ......<br>            <span class="hljs-type">Activity</span> <span class="hljs-variable">activity</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 重点* 1. 通过Instrumentation 反射创建 Activity</span><br>                java.lang.<span class="hljs-type">ClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> appContext.getClassLoader();<br>                activity = mInstrumentation.newActivity(<br>                        cl, component.getClassName(), r.intent);<br>                ......<br>            &#125;<br>            <span class="hljs-keyword">try</span> &#123;<br>                ......<br>                <span class="hljs-comment">// 重点* 2. 执行 attach 流程</span><br>                activity.attach(appContext, <span class="hljs-built_in">this</span>, getInstrumentation(), r.token,r.ident, app, r.intent, r.activityInfo, title, r.parent,r.embeddedID, r.lastNonConfigurationInstances, config,r.referrer, r.voiceInteractor, window, r.activityConfigCallback,r.assistToken, r.shareableActivityToken);<br>                <span class="hljs-keyword">if</span> (r.isPersistable()) &#123;<br>                    mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    重点* <span class="hljs-number">3.</span> OnCreate流程<br>                    mInstrumentation.callActivityOnCreate(activity, r.state);<br>                &#125;<br>                <span class="hljs-comment">// 设置状态为 ON_CREATE（1）</span><br>                r.setState(ON_CREATE);<br>            &#125; ......<br>    ......<br>&#125;<br></code></pre></td></tr></table></figure>
<p>.<br>由于我们预先已经把相关的资源路径全部替换成目标应用了，这里会创建目标应用的内存实例对象，获取的 classloader 也都是指向目标应用的路径，使用它们创建 <code>Activity</code> 并最终调用 <code>callActivityOnCreate</code>。以及目标的相关 dex 和动态库也都在这里被加载进内存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Instrumentation</span> &#123;<br>    <span class="hljs-keyword">public</span> Activity <span class="hljs-title function_">newActivity</span><span class="hljs-params">(ClassLoader cl, String className,</span><br><span class="hljs-params">                                Intent intent)</span><br>            <span class="hljs-keyword">throws</span> InstantiationException, IllegalAccessException,<br>            ClassNotFoundException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">pkg</span> <span class="hljs-operator">=</span> intent != <span class="hljs-literal">null</span> &amp;&amp; intent.getComponent() != <span class="hljs-literal">null</span><br>                ? intent.getComponent().getPackageName() : <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">return</span> getFactory(pkg).instantiateActivity(cl, className, intent);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppComponentFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">android</span>.app.AppComponentFactory &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-meta">@NonNull</span> Activity <span class="hljs-title function_">instantiateActivityCompat</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> ClassLoader cl,</span><br><span class="hljs-params">                                                       <span class="hljs-meta">@NonNull</span> String className, <span class="hljs-meta">@Nullable</span> Intent intent)</span><br>            <span class="hljs-keyword">throws</span> InstantiationException, IllegalAccessException, ClassNotFoundException &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 通过mClassLoader 调用loadClass加载的。</span><br>            <span class="hljs-keyword">return</span> (Activity) cl.loadClass(className).getDeclaredConstructor().newInstance();<br>        &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException | NoSuchMethodException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Couldn&#x27;t call constructor&quot;</span>, e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>另外，<code>AppInstrumentation</code> 把这个函数做了个 Hook：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">callActivityOnCreate</span><span class="hljs-params">(  </span><br><span class="hljs-params">    Activity activity, Bundle icicle, PersistableBundle persistentState)</span> &#123;  <br>  mBaseInstrumentation.callActivityOnCreate(activity, icicle, persistentState);  <br>  <span class="hljs-keyword">for</span> (AppLifecycleCallback appLifecycleCallback : SandBoxCore.get().getAppLifecycleCallbacks()) &#123;  <br>    appLifecycleCallback.onActivityCreated(activity, icicle);  <br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>mBaseInstrumentation.callActivityOnCreate</code> 会调用原生的 <code>callActivityOnCreate</code> ，这个里面会去调用 <code>Activity</code> 的 <code>OnCreate</code>。</p>
<h2 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h2><p>最后贴一份流程图，来自于 <a target="_blank" rel="noopener" href="https://www.jianshu.com/u/2a88bf20e37c">alen17</a></p>
<p class='item-img' data-src='/images/virtualappquickreview/virtualapp%E5%8A%A0%E8%BD%BD%E5%BA%94%E7%94%A8/startActivityFromLauch.svg'><img src="/images/virtualappquickreview/virtualapp%E5%8A%A0%E8%BD%BD%E5%BA%94%E7%94%A8/startActivityFromLauch.svg"></p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ganyao939543405/article/details/76177392">https://blog.csdn.net/ganyao939543405/article/details/76177392</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/151010577">https://zhuanlan.zhihu.com/p/151010577</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/revercc/p/16813435.html">https://www.cnblogs.com/revercc/p/16813435.html</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f95fd575a57c">https://www.jianshu.com/p/f95fd575a57c</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2026/05/24/VirtualApp%E5%8E%9F%E7%90%86%E9%80%9F%E8%A7%88%20-%20%E5%AE%B9%E5%99%A8%E5%86%85%20Service%20%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">← Next VirtualApp原理速览 - 容器内 Service 启动流程</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2026/05/24/VirtualApp%E5%8E%9F%E7%90%86%E9%80%9F%E8%A7%88%20-%20Activity%20%E5%8E%9F%E7%94%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">VirtualApp原理速览 - Activity 原生启动流程 Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/6.png" alt="Logo"></a><h1 id="Dr"><a href="TokameinE">TokameinE</a></h1><div id="description"><p></p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/ErodedElk"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" target="_blank" rel="noopener" href="https://space.bilibili.com/1782544616"><i class="fa-brands fa-bilibili" alt="BiliBili"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%86%85-APP-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">容器内 APP 启动流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%82%B9%E5%87%BB%E5%90%AF%E5%8A%A8%E5%BA%94%E7%94%A8%E6%97%B6%E5%8F%91%E7%94%9F%E4%BA%86%E5%95%A5"><span class="toc-number">2.1.</span> <span class="toc-text">点击启动应用时发生了啥</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%82%A3%E4%BA%9B%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E5%A6%82%E4%BD%95%E8%A2%AB-Hook"><span class="toc-number">2.2.</span> <span class="toc-text">那些系统服务如何被 Hook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BActivityManagerService-startActivity-%E5%A6%82%E4%BD%95%E5%90%AF%E5%8A%A8%E5%BA%94%E7%94%A8"><span class="toc-number">2.3.</span> <span class="toc-text">BActivityManagerService.startActivity 如何启动应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">2.4.</span> <span class="toc-text">流程图</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">3.</span> <span class="toc-text">参考文章</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>