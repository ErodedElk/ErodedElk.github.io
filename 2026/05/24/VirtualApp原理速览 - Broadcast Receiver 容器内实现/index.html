<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>VirtualApp原理速览 - Broadcast Receiver 容器内实现 | TokameinE - 雨声淅淅沥沥，犬吠永不止息</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: Bender;
 src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
 font-family: BenderLight;
 src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/91110244_p0.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>VirtualApp原理速览 - Broadcast Receiver 容器内实现</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2026-05-23T22:41:16.000Z" id="date"> 2026-05-24</time></div></span><br><span>Last Update: <div class="control"><time datetime="2025-05-24T03:31:58.368Z" id="updated"> 2025-05-24</time></div></span></div></div><hr><div id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Broadcast Receiver 的容器内实现跟 Service 和 Activity 一样，都是需要提前在 Manifest 中声明才能够调用的，因此对于 VirtualApp 这种容器，就需要提供一种能够在容器内实现的操作。</p>
<p>对于写在 Manifest 中注册的 Broadcast Receiver 在应用启动时会静态注册，而这条途径现在不行了，因此我们需要考虑在容器内应用启动时<strong>动态注册</strong>它的那些 Broadcast Receiver。</p>
<h1 id="Broadcast-Receiver-容器内实现"><a href="#Broadcast-Receiver-容器内实现" class="headerlink" title="Broadcast Receiver 容器内实现"></a>Broadcast Receiver 容器内实现</h1><h2 id="Receiver-实现"><a href="#Receiver-实现" class="headerlink" title="Receiver 实现"></a>Receiver 实现</h2><p>首先我们来看其创建的时机：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">BActivityManagerService</span><span class="hljs-params">()</span> &#123;  <br>  mBroadcastManager = BroadcastManager.startSystem(<span class="hljs-built_in">this</span>, mPms);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>VirtualApp 在创建 <code>BActivityManagerService</code> 时会附带着把 <code>BroadcastManager</code> 一起创建：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> BroadcastManager <span class="hljs-title function_">startSystem</span><span class="hljs-params">(  </span><br><span class="hljs-params">    BActivityManagerService ams, BPackageManagerService pms)</span> &#123;  <br>  <span class="hljs-keyword">if</span> (sBroadcastManager == <span class="hljs-literal">null</span>) &#123;  <br>    <span class="hljs-keyword">synchronized</span> (BroadcastManager.class) &#123;  <br>      <span class="hljs-keyword">if</span> (sBroadcastManager == <span class="hljs-literal">null</span>) &#123;  <br>        sBroadcastManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastManager</span>(ams, pms);  <br>      &#125;  <br>    &#125;  <br>  &#125;  <br>  <span class="hljs-keyword">return</span> sBroadcastManager;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后在 <code>BActivityManagerService</code> 调用 <code>systemReady</code> 的时候会触发 <code>BroadcastManager.startup</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">systemReady</span><span class="hljs-params">()</span> &#123;  <br>  mBroadcastManager.startup();  <br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startup</span><span class="hljs-params">()</span> &#123;  <br>  mPms.addPackageMonitor(<span class="hljs-built_in">this</span>);  <br>  List&lt;BPackageSettings&gt; bPackageSettings = mPms.getBPackageSettings();  <br>  <span class="hljs-keyword">for</span> (BPackageSettings bPackageSetting : bPackageSettings) &#123;  <br>    <span class="hljs-type">BPackage</span> <span class="hljs-variable">bPackage</span> <span class="hljs-operator">=</span> bPackageSetting.pkg;  <br>    registerPackage(bPackage);  <br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里在遍历整个 VirtualApp 已经安装过的所有应用，然后对每个包都调用一次 <code>registerPackage</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SuppressLint(&quot;NewApi&quot;)</span>  <br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerPackage</span><span class="hljs-params">(BPackage bPackage)</span> &#123;  <br>  <span class="hljs-keyword">synchronized</span> (mReceivers) &#123;  <br>    Slog.d(TAG, <span class="hljs-string">&quot;register: &quot;</span> + bPackage.packageName  + <span class="hljs-string">&quot;, size: &quot;</span> + bPackage.receivers.size());  <br>    <span class="hljs-keyword">for</span> (BPackage.Activity receiver : bPackage.receivers)  &#123;  <br>      List&lt;BPackage.ActivityIntentInfo&gt; intents = receiver.intents;  <br>      <span class="hljs-keyword">for</span> (BPackage.ActivityIntentInfo intent : intents) &#123;  <br>        <span class="hljs-comment">// 新增功能1：类型转换获取IntentFilter  </span><br>        BPackage.<span class="hljs-type">IntentInfo</span> <span class="hljs-variable">intentInfo</span> <span class="hljs-operator">=</span> (BPackage.IntentInfo) intent;  <br>        <span class="hljs-type">IntentFilter</span> <span class="hljs-variable">intentFilter</span> <span class="hljs-operator">=</span> intentInfo.intentFilter;  <br>        <span class="hljs-comment">// 新增功能2：黑名单Action处理  </span><br>        <span class="hljs-keyword">if</span> (intentFilter != <span class="hljs-literal">null</span>) &#123;  <br>          <span class="hljs-type">int</span> <span class="hljs-variable">countActions</span> <span class="hljs-operator">=</span> intentFilter.countActions();  <br>          <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; countActions; i++) &#123;  <br>            <span class="hljs-type">String</span> <span class="hljs-variable">action</span> <span class="hljs-operator">=</span> intentFilter.getAction(i);  <br>            <span class="hljs-keyword">if</span> (isBlackAction(action)) &#123;  <br>              intentFilter.addAction(proxySystemAction(action));  <br>            &#125;  <br>          &#125;  <br>        &#125;  <br>        <span class="hljs-type">ProxyBroadcastReceiver</span> <span class="hljs-variable">proxyBroadcastReceiver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyBroadcastReceiver</span>();  <br>        <span class="hljs-comment">// 新增功能3：系统版本判断逻辑  </span><br>        <span class="hljs-keyword">if</span> (BuildCompat.isT())  &#123;  <br>          SandBoxCore.getContext().registerReceiver(proxyBroadcastReceiver,  intentFilter, <span class="hljs-number">2</span>);  <br>        &#125; <span class="hljs-keyword">else</span> &#123;  <br>          SandBoxCore.getContext().registerReceiver(proxyBroadcastReceiver,  intentFilter);  <br>        &#125;  <br>  <br>        addReceiver(bPackage.packageName,  proxyBroadcastReceiver);  <br>      &#125;  <br>    &#125;  <br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>首先获取包里所有需要注册的 receivers，然后往下遍历去判断 action 是否为 BlackAction：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBlackAction</span><span class="hljs-params">(String str)</span> &#123;  <br>  <span class="hljs-keyword">return</span> SYSTEM_ACTIONS.contains(str);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里的 <code>SYSTEM_ACTIONS</code> 包括了这些：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ACTION_BOOT_COMPLETED</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;android.intent.action.BOOT_COMPLETED&quot;</span>;  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ACTION_CHECKIN_NOW</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.google.android.gms.permission.CHECKIN_NOW&quot;</span>;  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ACTION_CHECKIN_NOW_SERVER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;android.server.checkin.CHECKIN_NOW&quot;</span>;  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ACTION_MODE_CHANGED</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;android.location.MODE_CHANGED&quot;</span>;  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ACTION_PROVIDERS_CHANGED</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;android.location.PROVIDERS_CHANGED&quot;</span>;  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ACTION_SIM_STATE_CHANGED</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;android.intent.action.SIM_STATE_CHANGED&quot;</span>;<br><span class="hljs-keyword">static</span> &#123;  <br>  SYSTEM_ACTIONS.add(<span class="hljs-string">&quot;android.accounts.LOGIN_ACCOUNTS_CHANGED&quot;</span>);  <br>  SYSTEM_ACTIONS.add(ACTION_BOOT_COMPLETED);  <br>  SYSTEM_ACTIONS.add(ACTION_CHECKIN_NOW);  <br>  SYSTEM_ACTIONS.add(ACTION_CHECKIN_NOW_SERVER);  <br>  SYSTEM_ACTIONS.add(ACTION_MODE_CHANGED);  <br>  SYSTEM_ACTIONS.add(ACTION_PROVIDERS_CHANGED);  <br>  SYSTEM_ACTIONS.add(ACTION_SIM_STATE_CHANGED);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果属于上述的这些 action，那就需要额外加一层代理把它们替换掉：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">proxySystemAction</span><span class="hljs-params">(String str)</span> &#123;  <br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;fake.black.&quot;</span> + str;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>最后再调用 <code>registerReceiver</code> 动态注册这些：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (BuildCompat.isT())  &#123;  <br>  SandBoxCore.getContext().registerReceiver(proxyBroadcastReceiver,  intentFilter, <span class="hljs-number">2</span>);  <br>&#125; <span class="hljs-keyword">else</span> &#123;  <br>  SandBoxCore.getContext().registerReceiver(proxyBroadcastReceiver,  intentFilter);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>最后调用 <code>addReceiver</code> 把这个包的那些 receiver 放入 Hash 表里做个映射就算是注册完成了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addReceiver</span><span class="hljs-params">(String packageName, BroadcastReceiver receiver)</span> &#123;  <br>  List&lt;BroadcastReceiver&gt; broadcastReceivers = mReceivers.get(packageName);  <br>  <span class="hljs-keyword">if</span> (broadcastReceivers == <span class="hljs-literal">null</span>) &#123;  <br>    broadcastReceivers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();  <br>    mReceivers.put(packageName, broadcastReceivers);  <br>  &#125;  <br>  broadcastReceivers.add(receiver);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>看起来好像一下子就结束了？总结一下流程就是：把容器内的那些包的每个 Receiver 都拿出来，然后把它们的 IntentFilter 用 VitualApp 自己注册一个一样的，这样就能让 VitualApp 来代管这些收到的 Message 了。</p>
<p>那么问题来了，VitualApp 代管了这些 Message 谁来处理呢？注意到当时注册的时候用到了一个 <code>ProxyBroadcastReceiver</code> 对象。</p>
<p>此处用到的 <code>ProxyBroadcastReceiver</code> 重载了 <code>onReceive</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(Context context, Intent intent)</span> &#123;  <br>  intent.setExtrasClassLoader(context.getClassLoader());  <br>  <span class="hljs-type">ProxyBroadcastRecord</span> <span class="hljs-variable">record</span> <span class="hljs-operator">=</span> ProxyBroadcastRecord.create(intent);  <br>  <span class="hljs-keyword">if</span> (record.mIntent == <span class="hljs-literal">null</span>) &#123;  <br>    <span class="hljs-keyword">return</span>;  <br>  &#125;  <br>  <span class="hljs-type">PendingResult</span> <span class="hljs-variable">pendingResult</span> <span class="hljs-operator">=</span> goAsync();  <br>  <span class="hljs-keyword">try</span> &#123;  <br>    SandBoxCore.getBActivityManager()  <br>        .scheduleBroadcastReceiver(  <br>            record.mIntent, <span class="hljs-keyword">new</span> <span class="hljs-title class_">PendingResultData</span>(pendingResult), record.mUserId);  <br>  &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;  <br>    pendingResult.finish();  <br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看出，当 VirtualApp 收到 Message 时会往下调用 <code>scheduleBroadcastReceiver</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleBroadcastReceiver</span><span class="hljs-params">(  </span><br><span class="hljs-params">    Intent intent, PendingResultData pendingResultData, <span class="hljs-type">int</span> userId)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;  <br>    <span class="hljs-comment">// 提取 ResolveInfo</span><br>  List&lt;ResolveInfo&gt; resolves =  <br>      BPackageManagerService.get().queryBroadcastReceivers(intent, GET_META_DATA, <span class="hljs-literal">null</span>, userId);  <br>  <br>  <span class="hljs-keyword">if</span> (resolves.isEmpty()) &#123;  <br>    pendingResultData.build().finish();  <br>    Slog.d(TAG, <span class="hljs-string">&quot;scheduleBroadcastReceiver empty&quot;</span>);  <br>    <span class="hljs-keyword">return</span>;  <br>  &#125;  <br>  mBroadcastManager.sendBroadcast(pendingResultData);  <br>  <span class="hljs-keyword">for</span> (ResolveInfo resolve : resolves) &#123;  <br>    <span class="hljs-type">ProcessRecord</span> <span class="hljs-variable">processRecord</span> <span class="hljs-operator">=</span>  <br>        BProcessManagerService.get()  <br>            .findProcessRecord(  <br>                resolve.activityInfo.packageName, resolve.activityInfo.processName, userId);  <br>    <span class="hljs-keyword">if</span> (processRecord != <span class="hljs-literal">null</span>) &#123;  <br>      <span class="hljs-type">ReceiverData</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReceiverData</span>();  <br>      data.intent = intent;  <br>      data.activityInfo = resolve.activityInfo;  <br>      data.data = pendingResultData;  <br>      <span class="hljs-comment">// 调度 ReceiverData</span><br>      processRecord.bActivityThread.scheduleReceiver(data);  <br>    &#125;  <br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>功能也很明显，根据传来的 <code>Intent</code> 去找到对应应用的 <code>ProcessRecord</code> 对象，并通过 <code>scheduleReceiver</code> 来向它们传递 <code>Intent</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleReceiver</span><span class="hljs-params">(ReceiverData data)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;  <br>  <span class="hljs-keyword">if</span> (!isInit()) &#123;  <br>    bindApplication();  <br>  &#125;  <br>  mH.post(  <br>      () -&gt; &#123;  <br>        <span class="hljs-type">BroadcastReceiver</span> <span class="hljs-variable">mReceiver</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;  <br>        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> data.intent;  <br>        <span class="hljs-type">ActivityInfo</span> <span class="hljs-variable">activityInfo</span> <span class="hljs-operator">=</span> data.activityInfo;  <br>        BroadcastReceiver.<span class="hljs-type">PendingResult</span> <span class="hljs-variable">pendingResult</span> <span class="hljs-operator">=</span> data.data.build();  <br>  <br>        <span class="hljs-keyword">try</span> &#123;  <br>          <span class="hljs-type">Context</span> <span class="hljs-variable">baseContext</span> <span class="hljs-operator">=</span> mInitialApplication.getBaseContext();  <br>          <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> baseContext.getClassLoader();  <br>          intent.setExtrasClassLoader(classLoader);  <br>  <br>          mReceiver = (BroadcastReceiver) classLoader.loadClass(activityInfo.name).newInstance();  <br>          BRBroadcastReceiver.get(mReceiver).setPendingResult(pendingResult);  <br>          mReceiver.onReceive(baseContext, intent);  <br>          BroadcastReceiver.<span class="hljs-type">PendingResult</span> <span class="hljs-variable">finish</span> <span class="hljs-operator">=</span>  <br>              BRBroadcastReceiver.get(mReceiver).getPendingResult();  <br>          <span class="hljs-keyword">if</span> (finish != <span class="hljs-literal">null</span>) &#123;  <br>            finish.finish();  <br>          &#125;  <br>          SandBoxCore.getBActivityManager().finishBroadcast(data.data);  <br>        &#125; <span class="hljs-keyword">catch</span> (Throwable throwable) &#123;  <br>          throwable.printStackTrace();  <br>          Slog.e(TAG, <span class="hljs-string">&quot;Error receiving broadcast &quot;</span> + intent + <span class="hljs-string">&quot; in &quot;</span> + mReceiver);  <br>        &#125;  <br>      &#125;);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里就很明显了，通过上述的信息来找到目标应用中的处理函数，通过 <code>loadClass</code> 来加载对应的代码，最后调用它的 <code>onReceive</code> 来让真正的处理函数处理这个消息。</p>
<p>代码过程中一直有个 <code>pendingResultData</code> 在通过 <code>sendBroadcast</code> 发送：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">mBroadcastManager.sendBroadcast(pendingResultData); <br></code></pre></td></tr></table></figure>

<p>主要是提供一个超时兜底，当广播超时时候会通知一个 PendingResult 表示结束，告诉发送方广播结束了。</p>
<h2 id="Sender-的实现"><a href="#Sender-的实现" class="headerlink" title="Sender 的实现"></a>Sender 的实现</h2><p>除了接受部分需要这样适配，由容器内应用发送广播的过程同样也需要做些调整。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ProxyMethod(&quot;broadcastIntent&quot;)</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BroadcastIntent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MethodHook</span> &#123;  <br>  <span class="hljs-meta">@Override</span>  <br>  <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">hook</span><span class="hljs-params">(Object who, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;  <br>    <span class="hljs-type">int</span> <span class="hljs-variable">intentIndex</span> <span class="hljs-operator">=</span> getIntentIndex(args);  <br>    <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> (Intent) args[intentIndex];  <br>    <span class="hljs-type">String</span> <span class="hljs-variable">resolvedType</span> <span class="hljs-operator">=</span> (String) args[intentIndex + <span class="hljs-number">1</span>];  <br>    <span class="hljs-type">Intent</span> <span class="hljs-variable">proxyIntent</span> <span class="hljs-operator">=</span>  <br>        SandBoxCore.getBActivityManager()  <br>            .sendBroadcast(intent, resolvedType, BActivityThread.getUserId());  <br>    <span class="hljs-keyword">if</span> (proxyIntent != <span class="hljs-literal">null</span>) &#123;  <br>      proxyIntent.setExtrasClassLoader(AppInstrumentation.get().getDelegateAppClassLoader());  <br>      ProxyBroadcastRecord.saveStub(proxyIntent, intent, BActivityThread.getUserId());  <br>      args[intentIndex] = proxyIntent;  <br>    &#125;  <br>    <span class="hljs-comment">// ignore permission  </span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) &#123;  <br>      <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> args[i];  <br>      <span class="hljs-keyword">if</span> (o <span class="hljs-keyword">instanceof</span> String[]) &#123;  <br>        args[i] = <span class="hljs-literal">null</span>;  <br>      &#125;  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> method.invoke(who, args);  <br>  &#125;  <br>  <br>  <span class="hljs-type">int</span> <span class="hljs-title function_">getIntentIndex</span><span class="hljs-params">(Object[] args)</span> &#123;  <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) &#123;  <br>      <span class="hljs-type">Object</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> args[i];  <br>      <span class="hljs-keyword">if</span> (arg <span class="hljs-keyword">instanceof</span> Intent) &#123;  <br>        <span class="hljs-keyword">return</span> i;  <br>      &#125;  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;  <br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>首先是通过 sendBroadcast 把真正需要发送的 Intent 包装起来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> Intent <span class="hljs-title function_">sendBroadcast</span><span class="hljs-params">(Intent intent, String resolvedType, <span class="hljs-type">int</span> userId)</span>  <br>    <span class="hljs-keyword">throws</span> RemoteException &#123;  <br>  List&lt;ResolveInfo&gt; resolves =  <br>      BPackageManagerService.get()  <br>          .queryBroadcastReceivers(intent, GET_META_DATA, resolvedType, userId);  <br>  <br>  <span class="hljs-keyword">for</span> (ResolveInfo resolve : resolves) &#123;  <br>    <span class="hljs-type">ProcessRecord</span> <span class="hljs-variable">processRecord</span> <span class="hljs-operator">=</span>  <br>        BProcessManagerService.get()  <br>            .findProcessRecord(  <br>                resolve.activityInfo.packageName, resolve.activityInfo.processName, userId);  <br>    <span class="hljs-keyword">if</span> (processRecord == <span class="hljs-literal">null</span>) &#123;  <br>      <span class="hljs-keyword">continue</span>;  <br>    &#125;  <br>    <span class="hljs-keyword">try</span> &#123;  <br>      processRecord.bActivityThread.bindApplication();  <br>    &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;  <br>      e.printStackTrace();  <br>    &#125;  <br>  &#125;  <br>  <span class="hljs-type">Intent</span> <span class="hljs-variable">shadow</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>();  <br>  shadow.setPackage(SandBoxCore.getHostPkg());  <br>  shadow.setComponent(<span class="hljs-literal">null</span>);  <br>  shadow.setAction(intent.getAction());  <br>  <span class="hljs-keyword">return</span> shadow;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>将内部应用发送的 <code>Intent</code> 伪造成由 VirtualApp 发送的 <code>proxyIntent</code> ，然后再调用原生的发送函数把这个广播重新播出去。</p>
<p>不过如果这个发出去的广播最终还是由容器内的应用去处理，那之前注册好的那些 <code>Receiver</code> 就会接收到这些消息然后处理了。后续流程就跟前文一致了。</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ganyao939543405/article/details/76229480">https://blog.csdn.net/ganyao939543405/article/details/76229480</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2026/05/24/VirtualApp%E5%8E%9F%E7%90%86%E9%80%9F%E8%A7%88%20-%20%E8%B7%AF%E5%BE%84%E9%87%8D%E5%AE%9A%E5%90%91%E5%92%8C%20Xposed%20%E6%B3%A8%E5%85%A5%E6%97%B6%E6%9C%BA%E5%88%86%E6%9E%90/">← Next VirtualApp原理速览 - 路径重定向和 Xposed 注入时机分析</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2026/05/24/VirtualApp%E5%8E%9F%E7%90%86%E9%80%9F%E8%A7%88%20-%20Content%20Provider%20%E5%AE%B9%E5%99%A8%E5%86%85%E5%AE%9E%E7%8E%B0/">VirtualApp原理速览 - Content Provider 容器内实现 Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/6.png" alt="Logo"></a><h1 id="Dr"><a href="TokameinE">TokameinE</a></h1><div id="description"><p></p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/ErodedElk"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" target="_blank" rel="noopener" href="https://space.bilibili.com/1782544616"><i class="fa-brands fa-bilibili" alt="BiliBili"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Broadcast-Receiver-%E5%AE%B9%E5%99%A8%E5%86%85%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">Broadcast Receiver 容器内实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Receiver-%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.1.</span> <span class="toc-text">Receiver 实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sender-%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.2.</span> <span class="toc-text">Sender 的实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">3.</span> <span class="toc-text">参考文章</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>