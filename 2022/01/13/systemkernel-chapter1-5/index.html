<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>《操作系统真象还原》chapter1-5笔记与总结 | TokameinE - 雨声淅淅沥沥，犬吠永不止息</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - $1 行","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: Bender;
 src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
 font-family: BenderLight;
 src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/91110244_p0.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>《操作系统真象还原》chapter1-5笔记与总结</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2022-01-13T15:47:39.000Z" id="date"> 2022-01-13</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2024-12-29T04:50:35.012Z" id="updated"> 2024-12-29</time></div></span></div></div><hr><div id="post-content"><hr>
<h2 id="引题：操作系统是如何被启动的？"><a href="#引题：操作系统是如何被启动的？" class="headerlink" title="引题：操作系统是如何被启动的？"></a><strong>引题：操作系统是如何被启动的？</strong></h2><p>主板接电以后，内嵌在主板上的ROM中的BIOS会将 0盘0道1扇区 中的MBR(Main Boot Record)读取到内存中一个固定的位置，然后自动跳转到该位置(0x7c00)，之后由MBR取代BIOS接管系统。此时，系统处于“实模式”，此时只能使用寄存器的低16位。</p>
<p>但MBR最大只能有一个扇区(512字节)，可做的事情极其有限，因此MBR只从硬盘读取Loader到内存(读取位置也是约定好的)，同时再跳转到Loader，由其取代MBR接管系统。</p>
<p>(至于读到哪里，实际上无所谓，只要最开始做好约定，让其能够跳转达到即可)</p>
<p>Loader则能够做到所有初始化工作。进入保护模式、加载内核、启动分页等工作。</p>
<p>MBR主引导记录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">; 主引导程序<br>;-----------------------------------------------<br>%include &quot;boot.inc&quot;<br>SECTION MBR vstart=0x7c00<br>;起始于0x7c00<br>;如下为初始段寄存器,cs在加载时会被置为代码段地址<br>;0xb800对应了显存,对该内存写就相当于将内容打印在显示屏上<br>    mov ax, cs<br>    mov ds, ax<br>    mov es, ax<br>    mov ss, ax<br>    mov fs, ax<br>    mov sp, 0x7c00<br>    mov ax, 0xb800<br>    mov gs, ax<br><br>; 清屏<br>;---------------------------------------------------<br>    mov ax, 0600h<br>    mov bx, 0700h<br>    mov cx, 0<br>    mov dx, 184fh<br>    int 10h<br><br>    ; 显示&quot;1 MBR&quot;<br>    mov byte [gs:0x00], &#x27;1&#x27;<br>    mov byte [gs:0x01], 0xA4<br><br>    mov byte [gs:0x02], &#x27; &#x27;<br>    mov byte [gs:0x03], 0xA4<br><br>    mov byte [gs:0x04], &#x27;M&#x27;<br>    mov byte [gs:0x05], 0xA4<br><br>    mov byte [gs:0x06], &#x27;B&#x27;<br>    mov byte [gs:0x07], 0xA4<br><br>    mov byte [gs:0x08], &#x27;A&#x27;<br>    mov byte [gs:0x09], 0xA4<br><br>    mov eax, LOADER_START_SECTOR<br>    mov bx, LOADER_BASE_ADDR<br><br>    ; 读取4个扇区<br>    mov cx, 4<br>    call rd_disk_m_16<br><br>    ; 直接跳到loader的起始代码执行<br>    jmp LOADER_BASE_ADDR + 0x300<br><br>;-----------------------------------------------------------<br>; 读取磁盘的n个扇区，用于加载loader<br>; eax保存从硬盘读取到的数据的保存地址，ebx为起始扇区，cx为读取的扇区数<br>rd_disk_m_16:<br>;-----------------------------------------------------------<br><br>    mov esi, eax<br>    mov di, cx<br><br>    mov dx, 0x1f2<br>    mov al, cl<br>    out dx, al<br><br>    mov eax, esi<br><br>    mov dx, 0x1f3<br>    out dx, al<br><br>    mov cl, 8<br>    shr eax, cl<br>    mov dx, 0x1f4<br>    out dx, al<br><br>    shr eax, cl<br>    mov dx, 0x1f5<br>    out dx, al<br><br>    shr eax, cl<br>    and al, 0x0f<br>    or al, 0xe0<br>    mov dx, 0x1f6<br>    out dx, al<br><br>    mov dx, 0x1f7<br>    mov al, 0x20<br>    out dx, al<br><br>.not_ready:<br>    nop<br>    in al, dx<br>    and al, 0x88<br>    cmp al, 0x08<br>    jnz .not_ready<br><br>    mov ax, di<br>    mov dx, 256<br>    mul dx<br>    mov cx, ax<br>    mov dx, 0x1f0<br><br>.go_on_read:<br>    in ax, dx<br>    mov [bx], ax<br>    add bx, 2<br>    loop .go_on_read<br>    ret<br><br>    times 510-($-$$) db 0<br>    db 0x55, 0xaa<br></code></pre></td></tr></table></figure>

<p>Loader：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">%include &quot;boot.inc&quot;<br><br>section loader vstart=LOADER_BASE_ADDR<br>LOADER_STACK_TOP equ LOADER_BASE_ADDR<br><br>; 这里其实就是GDT的起始地址，第一个描述符为空<br>GDT_BASE: dd 0x00000000<br>          dd 0x00000000<br><br>; 代码段描述符，一个dd为4字节，段描述符为8字节，上面为低4字节<br>CODE_DESC: dd 0x0000FFFF<br>           dd DESC_CODE_HIGH4<br><br>; 栈段描述符，和数据段共用<br>DATA_STACK_DESC: dd 0x0000FFFF<br>                 dd DESC_DATA_HIGH4<br><br>; 显卡段，非平坦<br>VIDEO_DESC: dd 0x80000007<br>            dd DESC_VIDEO_HIGH4<br><br>GDT_SIZE equ $ - GDT_BASE<br>GDT_LIMIT equ GDT_SIZE - 1<br>times 120 dd 0<br>SELECTOR_CODE equ (0x0001 &lt;&lt; 3) + TI_GDT + RPL0<br>SELECTOR_DATA equ (0x0002 &lt;&lt; 3) + TI_GDT + RPL0<br>SELECTOR_VIDEO equ (0x0003 &lt;&lt; 3) + TI_GDT + RPL0<br><br>; 内存大小，单位字节，此处的内存地址是0xb00<br>total_memory_bytes dd 0<br><br>gdt_ptr dw GDT_LIMIT<br>        dd GDT_BASE<br><br>ards_buf times 244 db 0<br>ards_nr dw 0<br><br>loader_start: <br><br>    xor ebx, ebx<br>    mov edx, 0x534d4150<br>    mov di, ards_buf<br><br>.e820_mem_get_loop:<br>    mov eax, 0x0000e820<br>    mov ecx, 20<br>    int 0x15<br><br>    jc .e820_mem_get_failed<br><br>    add di, cx<br>    inc word [ards_nr]<br>    cmp ebx, 0<br>    jnz .e820_mem_get_loop<br><br>    mov cx, [ards_nr]<br>    mov ebx, ards_buf<br>    xor edx, edx<br><br>.find_max_mem_area:<br>    mov eax, [ebx]<br>    add eax, [ebx + 8]<br>    add ebx, 20<br>    cmp edx, eax<br>    jge .next_ards<br>    mov edx, eax<br><br>.next_ards:<br>    loop .find_max_mem_area<br>    jmp .mem_get_ok<br><br>.e820_mem_get_failed:<br>    mov byte [gs:0], &#x27;f&#x27;<br>    mov byte [gs:2], &#x27;a&#x27;<br>    mov byte [gs:4], &#x27;i&#x27;<br>    mov byte [gs:6], &#x27;l&#x27;<br>    mov byte [gs:8], &#x27;e&#x27;<br>    mov byte [gs:10], &#x27;d&#x27;<br>    ; 内存检测失败，不再继续向下执行<br>    jmp $<br><br>.mem_get_ok:<br>    mov [total_memory_bytes], edx<br><br>    ; 开始进入保护模式<br>    ; 打开A20地址线<br>    in al, 0x92<br>    or al, 00000010B<br>    out 0x92, al<br><br>    ; 加载gdt<br>    lgdt [gdt_ptr]<br><br>    ; cr0第0位置1<br>    mov eax, cr0<br>    or eax, 0x00000001<br>    mov cr0, eax<br><br>    ; 刷新流水线<br>    jmp dword SELECTOR_CODE:p_mode_start<br><br>[bits 32]<br>p_mode_start:<br>    mov ax, SELECTOR_DATA<br>    mov ds, ax<br><br>    mov es, ax<br>    mov ss, ax<br><br>    mov esp, LOADER_STACK_TOP<br>    mov ax, SELECTOR_VIDEO<br>    mov gs, ax<br><br>    ; 加载kernel<br>    mov eax, KERNEL_START_SECTOR<br>    mov ebx, KERNEL_BIN_BASE_ADDR<br>    mov ecx, 200<br><br>    call rd_disk_m_32<br><br>    call setup_page<br><br>    ; 保存gdt表<br>    sgdt [gdt_ptr]<br><br>    ; 重新设置gdt描述符， 使虚拟地址指向内核的第一个页表<br>    mov ebx, [gdt_ptr + 2]<br>    or dword [ebx + 0x18 + 4], 0xc0000000<br>    add dword [gdt_ptr + 2], 0xc0000000<br><br>    add esp, 0xc0000000<br><br>    ; 页目录基地址寄存器<br>    mov eax, PAGE_DIR_TABLE_POS<br>    mov cr3, eax<br><br>    ; 打开分页<br>    mov eax, cr0<br>    or eax, 0x80000000<br>    mov cr0, eax<br><br>    lgdt [gdt_ptr]<br><br>    ; 初始化kernel<br>    jmp SELECTOR_CODE:enter_kernel<br><br>    enter_kernel:<br>        call kernel_init<br>        mov esp, 0xc009f000<br>        jmp KERNEL_ENTRY_POINT<br><br>    jmp $<br><br>; 创建页目录以及页表<br>setup_page:<br>    ; 页目录表占据4KB空间，清零之<br>    mov ecx, 4096<br>    mov esi, 0<br>.clear_page_dir:   <br>    mov byte [PAGE_DIR_TABLE_POS + esi], 0<br>    inc esi<br>    loop .clear_page_dir<br><br>; 创建页目录表(PDE)<br>.create_pde:<br>    mov eax, PAGE_DIR_TABLE_POS<br>    ; 0x1000为4KB，加上页目录表起始地址便是第一个页表的地址<br>    add eax, 0x1000<br>    mov ebx, eax<br><br>    ; 设置页目录项属性<br>    or eax, PG_US_U  PG_RW_W  PG_P<br>    ; 设置第一个页目录项<br>    mov [PAGE_DIR_TABLE_POS], eax<br>    ; 第768(内核空间的第一个)个页目录项，与第一个相同，这样第一个和768个都指向低端4MB空间<br>    mov [PAGE_DIR_TABLE_POS + 0xc00], eax<br>    ; 最后一个表项指向自己，用于访问页目录本身<br>    sub eax, 0x1000<br>    mov [PAGE_DIR_TABLE_POS + 4092], eax<br><br>; 创建页表<br>    mov ecx, 256<br>    mov esi, 0<br>    mov edx, PG_US_U  PG_RW_W  PG_P<br>.create_pte:<br>    mov [ebx + esi * 4], edx<br>    add edx, 4096<br>    inc esi<br>    loop .create_pte<br><br>; 创建内核的其它PDE<br>    mov eax, PAGE_DIR_TABLE_POS<br>    add eax, 0x2000<br>    or eax, PG_US_U  PG_RW_W  PG_P<br>    mov ebx, PAGE_DIR_TABLE_POS<br>    mov ecx, 254<br>    mov esi, 769<br>.create_kernel_pde:<br>    mov [ebx + esi * 4], eax<br>    inc esi<br>    add eax, 0x1000<br>    loop .create_kernel_pde<br>    ret<br><br>; 保护模式的硬盘读取函数<br>rd_disk_m_32:<br><br>    mov esi, eax<br>    mov di, cx<br><br>    mov dx, 0x1f2<br>    mov al, cl<br>    out dx, al<br><br>    mov eax, esi<br><br>    mov dx, 0x1f3<br>    out dx, al<br><br>    mov cl, 8<br>    shr eax, cl<br>    mov dx, 0x1f4<br>    out dx, al<br><br>    shr eax, cl<br>    mov dx, 0x1f5<br>    out dx, al<br><br>    shr eax, cl<br>    and al, 0x0f<br>    or al, 0xe0<br>    mov dx, 0x1f6<br>    out dx, al<br><br>    mov dx, 0x1f7<br>    mov al, 0x20<br>    out dx, al<br><br>.not_ready:<br>    nop<br>    in al, dx<br>    and al, 0x88<br>    cmp al, 0x08<br>    jnz .not_ready<br><br>    mov ax, di<br>    mov dx, 256<br>    mul dx<br>    mov cx, ax<br>    mov dx, 0x1f0<br><br>.go_on_read:<br>    in ax, dx<br>    mov [bx], ax<br>    add bx, 2<br>    loop .go_on_read<br>    ret<br><br>kernel_init:<br>    xor eax, eax<br>    xor ebx, ebx<br>    xor ecx, ecx<br>    xor edx, edx<br><br>    mov dx, [KERNEL_BIN_BASE_ADDR + 42]<br>    mov ebx, [KERNEL_BIN_BASE_ADDR + 28]<br><br>    add ebx, KERNEL_BIN_BASE_ADDR<br>    mov cx, [KERNEL_BIN_BASE_ADDR + 44]<br><br>.each_segment:<br>    cmp byte [ebx], PT_NULL<br>    je .PTNULL<br><br>    ; 准备mem_cpy参数<br>    push dword [ebx + 16]<br>    mov eax, [ebx + 4]<br>    add eax, KERNEL_BIN_BASE_ADDR<br>    push eax<br>    push dword [ebx + 8]<br><br>    call mem_cpy<br>    add esp, 12<br><br>.PTNULL:<br>    add ebx, edx<br>    loop .each_segment<br>    ret<br><br>mem_cpy:<br>    cld<br>    push ebp<br>    mov ebp, esp<br>    push ecx<br><br>    mov edi, [ebp + 8]<br>    mov esi, [ebp + 12]<br>    mov ecx, [ebp + 16]<br>    rep movsb<br><br>    pop ecx<br>    pop ebp<br>    ret<br></code></pre></td></tr></table></figure>

<p>实模式下的地址拓展于今日而言似乎并没有太大意义了，随着寄存器和总线位数拓宽，不再需要像DOS时代那样仅使用1MB的内存了，因此这里不做记录，只需要记住其寻址最大值是0xffff:0xffff(0x10ffef)即可。</p>
<p>但内存的寻址方式和进入保护模式以后的段寄存器的用途却十分耐人寻味，一言蔽之即为“描述符–&gt;&gt;内存”</p>
<p><strong>GDT(Global Descriptor Table)：全局描述符表(段描述符表)</strong></p>
<p>该表用于储存一系列逻辑门、内存段的地址。</p>
<p>其第一项默认留空，称之为哑描述符。之所以这样规定，似是为了防止在未初始化选择子时违规访问到该描述符，于是索性就对其留空，让无意的访问直接错误。</p>
<p>而专门有一个寄存器GDT Register(48bit)用于加载该表的地址，使用R0专用的指令 <strong>lgdt</strong> 加载，通过 <strong>sgdt</strong> 保存。(我有点怀疑，之所以只有48bit是因为Intel芯片只有48根总线，支持内存只有2^48 BYTE，不过目前64位系统中，这个寄存器又达到79bit了，但目前没有确信)</p>
<p>其结构如下：</p>
<p class='item-img' data-src='https://cdn.jsdelivr.net/gh/ErodedElk/blogPic/img/202201132345123.png'><img src="https://cdn.jsdelivr.net/gh/ErodedElk/blogPic/img/202201132345123.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">// base: 基址<br>// limit: 寻址最大范围 tells the maximum addressable unit<br>// flags: 标志位<br>// access: 访问权限<br>struct gdt_entry &#123;<br>    uint16_t limit_low;<br>    uint16_t base_low;<br>    uint8_t base_middle;<br>    uint8_t access;<br>    unsigned limit_high: 4;<br>    unsigned flags: 4;<br>    uint8_t base_high;<br>&#125; __attribute__((packed));<br></code></pre></td></tr></table></figure>

<p>除此之外，我暂时不对GDT做过多深入</p>
<p><strong>A20(A20GATE)：特殊总线的控制端口</strong></p>
<p>实则对应第21根总线的控制端口。在80286时代，被使用的总线为0~19，但内存只有1M-0x100000，大于该部分是地址会被回绕。但打通A20(第21根总线)之后，硬件就知道应该拓展地址了，而不应该继续回绕。对应到32位的现代芯片，当A20被开启(置1)以后，处理器将不再把16位以上的地址回绕。（体现为：将0x92端口低位置1）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">in al, 0x92<br>or al, 00000010B<br>out 0x92, al<br></code></pre></td></tr></table></figure>

<p><strong>CR0 Register：</strong></p>
<p>处理器控制位图。不过多深究，仅记录PE(Protection Enable)：置1则标识进入保护模式。之后，CPU将以4字节为单位读取指令。</p>
<p class='item-img' data-src='https://cdn.jsdelivr.net/gh/ErodedElk/blogPic/img/202201132344227.jfif'><img src="https://cdn.jsdelivr.net/gh/ErodedElk/blogPic/img/202201132344227.jfif"></p>
<h2 id="分页机制："><a href="#分页机制：" class="headerlink" title="分页机制："></a><strong>分页机制：</strong></h2><p>分页总的能够概况成一句话：<strong>“32位地址能够表示2^32空间”</strong>。</p>
<p>似乎没什么特殊的，但当时读完整章之后，我最大的感想就是这句。</p>
<p>保护模式下，可寻址范围扩大到 4G ，共32位，但出于安全考虑，我们不应该让内存能够被 <strong>“平坦地访问”</strong> 。所谓平坦，指的是整个内存的地址空间连续，从0~4G可以直接通过地址的加减来访问对应内存；但只要系统会被用户使用，就应该避免内核数据能够被用户直接读写。显然，“平坦模式”下(也就是从加电直到分页之前)，我们没办法直接实现这个功能。</p>
<p>因此需要引入“内存分段(页)”，对于权限低的人，只允许他访问限定好的页，而对于最高权限的内核，则允许它访问整个内存。对于“操作系统占用内存高地址的1GB，用户占用低地址3GB”的设想也是因此得以实现的。可以看出，这个1GB和3GB已经指的是“虚拟地址”了，但这里的虚拟地址又和每个进程都有的“虚拟地址空间”不是同一个东西，后者是进程独立的，而前者则属于操作系统自身。</p>
<p>概念如此，具体表现在：<strong>对32位地址的分割</strong></p>
<p>首先，按照每页4K来划分内存，4G&#x2F;4K&#x3D;2^20，意味着如果对每一页都使用一个索引去表示，需要 1MB * 4&#x3D;4MB 的内存。但这个肯定是不允许的，因为占用实在太大了，因此我们可以再做一份二级页表(此处称之为“页目录表”(PDE：Page Directory Entry))，该表也按照4K分页，则4MB&#x2F;4K&#x3D;2^10，则页目录表只占用 1KB * 4&#x3D;4KB 大小(1024条目)。</p>
<p>假设现在，我们容许为此耗费4KB，那么就不需要再继续分页了，过度的分页对导致效率降低。PDE的目的是为了索引页表，共1024个条目(Entry)，每个PDE的条目都会指向一个页表，而一张页表对应1K * 4KB &#x3D; 4MB 内存。</p>
<p>因此，只需要划出页目录表的后256个条目供内核使用，就能够界定这1GB空间，而只要禁止用户去访问这部分页目录，那么用户程序自然就没办法直接访问内核数据了。</p>
<p>显然的是，索引1024个条目不需要32位，10位足够了，所以我们完全可以留出一些内容提供额外的信息(上文所述的属性)，比如访问权限等(但这是后话，并不是本章的重点，以下仅给出结构而不详细说明)。(另外一个事实是，如果您读到这里都没觉得奇怪，就说明您已经接受了一个条目占用32位的事实了，不过事实确实如此，也说明这并没有反直觉)</p>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/2020090101064593.png'><img src="https://img-blog.csdnimg.cn/2020090101064593.png"></p>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/2020090101064277.png'><img src="https://img-blog.csdnimg.cn/2020090101064277.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">mov eax, PAGE_DIR_TABLE_POS<br>; 0x1000为4KB，加上页目录表起始地址便是第一个页表的地址<br>add eax, 0x1000<br>mov ebx, eax<br>or eax, PG_US_U  PG_RW_W  PG_P<br>; 设置第一个页目录项<br>mov [PAGE_DIR_TABLE_POS], eax<br>; 第768(内核空间的第一个)个页目录项，与第一个相同，这样第一个和768个都指向低端4MB空间<br>mov [PAGE_DIR_TABLE_POS + 0xc00], eax<br>; 最后一个表项指向自己，用于访问页目录本身<br>sub eax, 0x1000<br>mov [PAGE_DIR_TABLE_POS + 4092], eax<br></code></pre></td></tr></table></figure>

<p>第768(内核空间的第一个)个页目录项之所以要和第一项相同，是为了保证分页之后的Loader程序的虚拟地址和物理地址一致。因为Loader也算是内核程序，应该保证它在虚拟地址的高1GB内，所以要把自己这一页放到768项(0xc000000对应的就是768页目录所标识的页表)</p>
<p>在设置完内核页表以后，调整esp到虚拟地址空间，修改GDT指向虚拟地址的对应位置，将页目录表的地址存入cr3 Register(该寄存器专门用于此功能)，置cr0 Register的PG位为1。加载 GDT，从此开启了内核的分页，往后的地址将全都使用虚拟地址替代物理地址。</p>
<p>显然，当下的“虚拟地址”是由硬件和操作系统共同完成的，它不同于多进程下每个进程独立的“虚拟地址空间”，后者理应是由操作系统单独提供的能力(暂时还没看到后面，但就目前我个人猜测，认为理应如此)。</p>
<p>然后只需要从硬盘读取内核到0xc0000000，然后跳转到_start函数即可由内核接管以后的工作。且因为自此之后，MBR，Loader等均不再工作，直接在内存中覆盖掉也完全无妨。另外，开启虚拟地址功能以后，所有的思考都应该直接通过虚拟地址完成，不再需要进行物理地址的计算和转换，因为处理器会完成这一切。</p>
<p>此时的内核已经加载到内存，接下来根据ELF的文件头来获取相关信息以后，将内核按照节区(Section)划分复制到虚拟地址对应的位置后直接用长跳转刷新流水线后达到内核的第一条指令。</p>
<p><strong>如上内容的流程图：</strong></p>
<p class='item-img' data-src='https://cdn.jsdelivr.net/gh/ErodedElk/blogPic/img/202201132347962.png'><img src="https://cdn.jsdelivr.net/gh/ErodedElk/blogPic/img/202201132347962.png"></p>
<h2 id="特权级："><a href="#特权级：" class="headerlink" title="特权级："></a><strong>特权级：</strong></h2><p>首先需要涉及TSS(Task State Segment)结构：</p>
<p class='item-img' data-src='https://cdn.jsdelivr.net/gh/ErodedElk/blogPic/img/202201132346074.png'><img src="https://cdn.jsdelivr.net/gh/ErodedElk/blogPic/img/202201132346074.png"></p>
<p>这是一个针对任务的结构体，每个任务都会拥有一个TSS结构体(这个“任务”将在以后成为进程)。</p>
<p>SS代表栈段寄存器，用以储存不同等级下的栈基址，分别有R0，R1，R2这三个等级；至于R3，因为R3向高权限区域访问时会将自己的SS入栈；而高权限区域从来不需要向R3“主动跳转”，因此不需要SS3(“主动”指的是类似中断、call等，ret等指令我称之为被动跳转)。</p>
<p>不过就要提到上述的GDT以及下文涉及的门描述符了。其结构如下图。</p>
<p class='item-img' data-src='https://cdn.jsdelivr.net/gh/ErodedElk/blogPic/img/202201132226236.png'><img src="https://cdn.jsdelivr.net/gh/ErodedElk/blogPic/img/202201132226236.png"></p>
<p class='item-img' data-src='https://cdn.jsdelivr.net/gh/ErodedElk/blogPic/img/202201132345123.png'><img src="https://cdn.jsdelivr.net/gh/ErodedElk/blogPic/img/202201132345123.png"></p>
<p>门</p>
<p>type值</p>
<p>存在位置</p>
<p>用法</p>
<p>任务门</p>
<p>0101</p>
<p>GDT、LDT、IDT</p>
<p>与TSS配合实现任务切换，不过大多数操作系统都不这么玩</p>
<p>中断门</p>
<p>1110</p>
<p>IDT</p>
<p>进入中断后屏蔽中断（eflags的IF位置0），linux利用此实现系统调用，int 0x80</p>
<p>陷阱门</p>
<p>1111</p>
<p>IDT</p>
<p>进入中断后不屏蔽中断</p>
<p>调用门</p>
<p>1100</p>
<p>GDT、LDT</p>
<p>用户用call或jmp指令从用户进程进入0特权级</p>
<p>GDT(Global Descriptor Table)除了一般的段描述符外，还储存各类门描述符。</p>
<p>(但也可能从LDT(局部描述符)中寻找，但原理是一样的)</p>
<p>一个门描述符中包含了对应的例程选择子和例程偏移量，像该门跳转的过程同一般的jmp相近，但特别的是，需要经过<strong>处理器</strong>的权限检查。</p>
<p>必须明确的是：</p>
<p>描述符 (Descriptor)：用以描述一个段的属性</p>
<p>选择子(Selector)：用以访问内存</p>
<p>因此描述符规定了访问该内存所需的权限，而选择子都表明了访问者拥有的权限。</p>
<p>每个描述符中的DPL(Descriptor Privilege Level)标识该描述符所拥有的权级，03对应R0R3的权限。接下来分为两个情况：</p>
<p><strong>请求数据：</strong></p>
<p>处理器对比当前CPL(Current Privilege Level)和目标段选择子中的DPL(Descriptor Privilege Level)，若CPL&lt;&#x3D;DPL，则允许访问。</p>
<p>因此对于R3下的程序，如果尝试读取内核数据，就会因为CPL大于DPL而被阻止。</p>
<p>CPL即为当前CS和SS寄存器<strong>选择子</strong>中的RPL(Request Privilege Level)，意味请求特权级。</p>
<ul>
<li><strong>检查时机</strong>：特权级检查会发生在往 <strong>数据段寄存器</strong> 中加载 <strong>段选择子</strong> 的时候，数据段寄存器包括 DS 和附加段寄存器 ES、FS、GS，如</li>
</ul>
<blockquote>
<p>mov ds,ax</p>
</blockquote>
<ul>
<li><strong>检查条件</strong>：<strong>CPL &lt;&#x3D; 目标数据段DPL</strong> &amp;&amp; <strong>RPL &lt;&#x3D; 目标数据段DPL</strong> （只能高特权级的指令访问地特权级的数据）</li>
</ul>
<p><strong>跳转执行：</strong></p>
<p>倘若程序企图直接从R3跳转到R0权限执行，就需要通过门进行了。但情况还是要分为两种，跳转目标是&#x2F;非一致代码段。</p>
<blockquote>
<p>call 内核选择子</p>
</blockquote>
<ul>
<li><strong>检查条件</strong><ul>
<li>无门结构且目标为非一致代码段：<strong>CPL &#x3D; RPL &#x3D; 目标代码段DPL</strong></li>
<li>无门结构且目标为一致代码段：<strong>CPL &gt;&#x3D; 目标数据段DPL</strong> &amp;&amp; <strong>RPL &gt;&#x3D; 目标数据段DPL</strong></li>
<li>有门结构：<strong>DPL_GATE &gt;&#x3D; CPL &gt;&#x3D; DPL_CODE</strong> &amp;&amp; <strong>RPL &lt;&#x3D; DPL_GATE</strong>（从低特权级跳到高特权级需要通过门）</li>
</ul>
</li>
</ul>
<p>转移前的栈结构如下：</p>
<p class='item-img' data-src='https://cdn.jsdelivr.net/gh/ErodedElk/blogPic/img/202201132315193.png'><img src="https://cdn.jsdelivr.net/gh/ErodedElk/blogPic/img/202201132315193.png"></p>
<p>同时，当SS切换到高权级的时，会自动将这些内容复制到新的栈中。最后会通过iret或retf指令返回到R3</p>
<p>RPL意味着“请求者”的权限等级，而非“承包商”的。</p>
<p>思考这样一个情况：</p>
<ol>
<li>用户程序发出读取硬盘调用请求，操作系统接收，进入内核(CPL&#x3D;0&#x2F;RPL&#x3D;3)</li>
<li>操作系统执行调用，将数据写入缓冲区(CPL&#x3D;0&#x2F;RPL&#x3D;3)</li>
</ol>
<p>倘若缓冲区位于R3段，那么DPL&#x3D;3，能够正常写；但倘若缓冲区位于R0，那么DPL&#x3D;0，应该被阻止。RPL相当于发出调用请求的用户程序，而CPL则相当于执行请求的“承包商”，不能因为“当前权限允许就去执行”，还需要判断“发起人是否有足够的权力这样做”。</p>
<p>至于RPL是在什么时候被写换的，内核态时，RPL为什么不会是0？</p>
<p>首先，Selector是由操作系统提供的，在提供该Selector时会将RPL改为用户的CPL，因此用户手中的Selector对应的RPL必定会是3。</p>
<p>然后，CPL是在用户程序加载时由操作系统设定的，并且操作系统规定，处于R3的权限下不能将CS段中的低两位降低，所以用户的CPL必定为3，且不由用户控制。</p>
<p>最后，在用户需要提交自己的选择子时，不论用户能否伪造它，只要用户无法伪造CS 寄存器，它就无法修改自己提交的选择子。因为只要用户提交选择子，操作系统就会用CPL来替换选择子中的RPL，而该选择子的RPL意味着请求以后的RPL。</p>
<p>这两个耦合的键值加上操作系统的强权，硬是把权限限死了……</p>
<p>另外，当调用门完成调用之后，需要从R0切换回R3，只需要把栈中的数据恢复即可。但值得注意的是，DS、ES、FS、GS等寄存器的值如果不属于返回目标对应的DPL区域，会直接被置0，以防止数据泄露。在之后的运行过程中，如果需要调用该寄存器，就会触发处理器异常，然后调用到对应的处理函数去。</p>
<p>至于本章最后的I&#x2F;O特权级，我个人认为作为了解性知识即可，便不再过多赘述了。</p>
<p>.</p>
<p>.</p>
<p>.</p>
<p>插画ID：93302401</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2022/01/31/fs-register/">← 下一篇 FS寄存器 和 段寄存器线索</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2022/01/04/sctf2021-gadget/">SCTF2021——gadget报告 上一篇 →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="文章目录">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/6.png" alt="Logo"></a><h1 id="Dr"><a href="TokameinE">TokameinE</a></h1><div id="description"><p></p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/ErodedElk"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" target="_blank" rel="noopener" href="https://space.bilibili.com/1782544616"><i class="fa-brands fa-bilibili" alt="BiliBili"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>目录</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E9%A2%98%EF%BC%9A%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%98%AF%E5%A6%82%E4%BD%95%E8%A2%AB%E5%90%AF%E5%8A%A8%E7%9A%84%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">引题：操作系统是如何被启动的？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E6%9C%BA%E5%88%B6%EF%BC%9A"><span class="toc-number">2.</span> <span class="toc-text">分页机制：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%9D%83%E7%BA%A7%EF%BC%9A"><span class="toc-number">3.</span> <span class="toc-text">特权级：</span></a></li></ol></div></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> 主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>