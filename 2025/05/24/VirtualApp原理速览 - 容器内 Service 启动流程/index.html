<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>VirtualApp原理速览 - 容器内 Service 启动流程 | TokameinE - 雨声淅淅沥沥，犬吠永不止息</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: Bender;
 src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
 font-family: BenderLight;
 src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/91110244_p0.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>VirtualApp原理速览 - 容器内 Service 启动流程</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2025-05-23T20:41:16.000Z" id="date"> 2025-05-24</time></div></span><br><span>Last Update: <div class="control"><time datetime="2025-05-27T14:47:35.036Z" id="updated"> 2025-05-27</time></div></span></div></div><hr><div id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在前文中我们分析了 VirtualApp 如何在容器内启动目标应用，但一个完整的 APP 除了它本身的代码外，它还有可能创建自己的服务。于是我想要试图了解它是否有在这个过程中做些什么。</p>
<p>与 Activity 不同的是，Service 的生命周期是代码手动管理的，光是这样就能省略掉很多复杂的流程。不过同 Activity 一样，想要创建 Service 仍然需要在 Manifest 中提前占好坑位，通过一些 Hook 等方式实现替换。</p>
<h1 id="容器内-Service-启动流程"><a href="#容器内-Service-启动流程" class="headerlink" title="容器内 Service 启动流程"></a>容器内 Service 启动流程</h1><h2 id="原生-Service-的创建流程"><a href="#原生-Service-的创建流程" class="headerlink" title="原生 Service 的创建流程"></a>原生 Service 的创建流程</h2><p>先贴一张大致的流程图吧，这里直接引用了 gityuan 大佬的博客内容，原文可在参考文章里找到。</p>
<p class='item-img' data-src='/images/virtualappquickreview/Service%E5%AE%B9%E5%99%A8%E5%86%85%E5%AE%9E%E7%8E%B0/ServiceCreate.png'><img src="/images/virtualappquickreview/Service%E5%AE%B9%E5%99%A8%E5%86%85%E5%AE%9E%E7%8E%B0/ServiceCreate.png"></p>
<ol>
<li>Process A 进程采用 Binder IPC 向 system_server 进程发起 startService 请求；</li>
<li>system_server 进程接收到请求后，向 zygote 进程发送创建进程的请求；</li>
<li>zygote 进程 fork 出新的子进程 Remote Service 进程；</li>
<li>Remote Service 进程，通过 Binder IPC 向 sytem_server 进程发起 attachApplication 请求；</li>
<li>system_server 进程在收到请求后，进行一系列准备工作后，再通过 binder IPC 向 remote Service 进程发送 scheduleCreateService 请求；</li>
<li>Remote Service 进程的binder线程在收到请求后，通过 handler 向主线程发送 CREATE_SERVICE 消息；</li>
<li>主线程在收到 Message 后，通过发射机制创建目标 Service，并回调 Service.onCreate() 方法。</li>
</ol>
<p>嗯，相比 Activity 要简单多了。一言蔽之就是，进程调用 <code>startService</code> 让 AMS 给这个服务创建个新进程，然后再去调用这个服务中的初始化函数。</p>
<h2 id="VirtualApp-环境中的兼容-startService"><a href="#VirtualApp-环境中的兼容-startService" class="headerlink" title="VirtualApp 环境中的兼容 startService"></a>VirtualApp 环境中的兼容 startService</h2><blockquote>
<p>网上查了一些 <code>VirtualApp</code> 关于 Service 的实现，但当我在 Blackbox 中对照时发现，似乎后者的实现不太一样，这里我只写出我自己的理解。</p>
</blockquote>
<p>从 <code>startService</code> 函数开始：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ProxyMethod(&quot;startService&quot;)</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StartService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MethodHook</span> &#123;  <br>  <span class="hljs-meta">@Override</span>  <br>  <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">hook</span><span class="hljs-params">(Object who, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;  <br>    <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> (Intent) args[<span class="hljs-number">1</span>];  <br>    <span class="hljs-type">String</span> <span class="hljs-variable">resolvedType</span> <span class="hljs-operator">=</span> (String) args[<span class="hljs-number">2</span>];  <br>    <span class="hljs-type">ResolveInfo</span> <span class="hljs-variable">resolveInfo</span> <span class="hljs-operator">=</span>  <br>        SandBoxCore.getBPackageManager()  <br>            .resolveService(intent, <span class="hljs-number">0</span>, resolvedType, BActivityThread.getUserId());  <br>    <span class="hljs-keyword">if</span> (resolveInfo == <span class="hljs-literal">null</span>) &#123;  <br>      <span class="hljs-keyword">return</span> method.invoke(who, args);  <br>    &#125;  <br>  <br>    <span class="hljs-type">int</span> <span class="hljs-variable">requireForegroundIndex</span> <span class="hljs-operator">=</span> getRequireForeground();  <br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">requireForeground</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;  <br>    <span class="hljs-keyword">if</span> (requireForegroundIndex != -<span class="hljs-number">1</span>) &#123;  <br>      requireForeground = (<span class="hljs-type">boolean</span>) args[requireForegroundIndex];  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> SandBoxCore.getBActivityManager()  <br>        .startService(intent, resolvedType, requireForeground, BActivityThread.getUserId());  <br>  &#125;  <br>  <br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getRequireForeground</span><span class="hljs-params">()</span> &#123;  <br>    <span class="hljs-keyword">if</span> (BuildCompat.isOreo()) &#123;  <br>      <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;  <br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>函数本身没做什么事，主要还是向下调用 <code>BActivityManagerService.startService</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> ComponentName <span class="hljs-title function_">startService</span><span class="hljs-params">(  </span><br><span class="hljs-params">    Intent intent, String resolvedType, <span class="hljs-type">boolean</span> requireForeground, <span class="hljs-type">int</span> userId)</span> &#123;  <br>  <span class="hljs-type">UserSpace</span> <span class="hljs-variable">userSpace</span> <span class="hljs-operator">=</span> getOrCreateSpaceLocked(userId);  <br>  <span class="hljs-keyword">synchronized</span> (userSpace.mActiveServices) &#123;  <br>    userSpace.mActiveServices.startService(intent, resolvedType, requireForeground, userId);  <br>  &#125;  <br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>为用户创建 <code>userSpace</code> ，然后再往下调用 <code>ActiveServices.startService</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startService</span><span class="hljs-params">(  </span><br><span class="hljs-params">    Intent intent, String resolvedType, <span class="hljs-type">boolean</span> requireForeground, <span class="hljs-type">int</span> userId)</span> &#123;  <br>  <span class="hljs-type">ResolveInfo</span> <span class="hljs-variable">resolveInfo</span> <span class="hljs-operator">=</span> resolveService(intent, resolvedType, userId);  <br>  <span class="hljs-keyword">if</span> (resolveInfo == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;  <br>  <span class="hljs-comment">//            throw new RuntimeException(&quot;resolveService service exception&quot;);  </span><br>  <span class="hljs-type">ServiceInfo</span> <span class="hljs-variable">serviceInfo</span> <span class="hljs-operator">=</span> resolveInfo.serviceInfo;  <br>  <span class="hljs-type">ProcessRecord</span> <span class="hljs-variable">processRecord</span> <span class="hljs-operator">=</span>  <br>      BProcessManagerService.get()  <br>          .startProcessLocked(  <br>              serviceInfo.packageName,  <br>              serviceInfo.processName,  <br>              userId,  <br>              -<span class="hljs-number">1</span>,  <br>              Binder.getCallingPid());  <br>  <span class="hljs-keyword">if</span> (processRecord == <span class="hljs-literal">null</span>) &#123;  <br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Unable to create &quot;</span> + serviceInfo.name);  <br>  &#125;  <br>  <span class="hljs-type">RunningServiceRecord</span> <span class="hljs-variable">runningServiceRecord</span> <span class="hljs-operator">=</span> getOrCreateRunningServiceRecord(intent);  <br>  runningServiceRecord.mServiceInfo = serviceInfo;  <br>  <br>  runningServiceRecord.getAndIncrementStartId();  <br>  <span class="hljs-keyword">final</span> <span class="hljs-type">Intent</span> <span class="hljs-variable">stubServiceIntent</span> <span class="hljs-operator">=</span>  <br>      createStubServiceIntent(intent, serviceInfo, processRecord, runningServiceRecord);  <br>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(  <br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;  <br>            <span class="hljs-meta">@Override</span>  <br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;  <br>              <span class="hljs-keyword">try</span> &#123;  <br>                SandBoxCore.getContext().startService(stubServiceIntent);  <br>              &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;  <br>                e.printStackTrace();  <br>              &#125;  <br>            &#125;  <br>          &#125;)  <br>      .start();  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>先通过 <code>resolveService</code> 来获取到需要启动的 Service 的相关信息，接下来调用 <code>createStubServiceIntent</code> 来伪造 <code>Intent</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Intent <span class="hljs-title function_">createStubServiceIntent</span><span class="hljs-params">(  </span><br><span class="hljs-params">    Intent targetIntent,  </span><br><span class="hljs-params">    ServiceInfo serviceInfo,  </span><br><span class="hljs-params">    ProcessRecord processRecord,  </span><br><span class="hljs-params">    RunningServiceRecord runningServiceRecord)</span> &#123;  <br>  <span class="hljs-type">Intent</span> <span class="hljs-variable">stub</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>();  <br>  <span class="hljs-type">ComponentName</span> <span class="hljs-variable">stubComp</span> <span class="hljs-operator">=</span>  <br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(  <br>          SandBoxCore.getHostPkg(), ProxyManifest.getProxyService(processRecord.bpid));  <br>  stub.setComponent(stubComp);  <br>  stub.setAction(UUID.randomUUID().toString());  <br>  ProxyServiceRecord.saveStub(  <br>      stub,  <br>      targetIntent,  <br>      serviceInfo,  <br>      runningServiceRecord,  <br>      processRecord.userId,  <br>      runningServiceRecord.mStartId.get());  <br>  <span class="hljs-keyword">return</span> stub;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里会将 <code>Intent</code> 替换成提前在 <code>Manifest</code> 中占坑好的 <code>ProxyService$Pn</code>，最后调用原生的 <code>startService</code> 去启动这个 <code>ProxyService</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">SandBoxCore.getContext().startService(stubServiceIntent);<br></code></pre></td></tr></table></figure>

<p>于是乎流程就回到了正常的启动过程中去，但注意，这样一来，启动的不就是 <code>ProxyService</code> 了吗？</p>
<p>在上面的流程中可以知道，当 AMS 完成创建的相关步骤后会主动给主线程发 <code>CREATE_SERVICE</code> 的消息，而在被 Hook 了的主线程中会调用 <code>handleCreateService</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">handleCreateService</span><span class="hljs-params">(Object data)</span> &#123;  <br>  <span class="hljs-keyword">if</span> (BActivityThread.getAppConfig() != <span class="hljs-literal">null</span>) &#123;  <br>    <span class="hljs-type">String</span> <span class="hljs-variable">appPackageName</span> <span class="hljs-operator">=</span> BActivityThread.getAppPackageName();  <br>    <span class="hljs-keyword">assert</span> appPackageName != <span class="hljs-literal">null</span>;  <br>  <br>    <span class="hljs-type">ServiceInfo</span> <span class="hljs-variable">serviceInfo</span> <span class="hljs-operator">=</span> BRActivityThreadCreateServiceData.get(data).info();  <br>    <span class="hljs-keyword">if</span> (!serviceInfo.name.equals(ProxyManifest.getProxyService(BActivityThread.getAppPid()))  <br>        &amp;&amp; !serviceInfo.name.equals(  <br>            ProxyManifest.getProxyJobService(BActivityThread.getAppPid()))) &#123;  <br>      Slog.d(TAG, <span class="hljs-string">&quot;handleCreateService: &quot;</span> + data);  <br>      <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>();  <br>      intent.setComponent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(appPackageName, serviceInfo.name));  <br>      SandBoxCore.getBActivityManager()  <br>          .startService(intent, <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>, BActivityThread.getUserId());  <br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <br>    &#125;  <br>  &#125;  <br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <br>&#125;<br><br><span class="hljs-keyword">public</span> ComponentName <span class="hljs-title function_">startService</span><span class="hljs-params">(  </span><br><span class="hljs-params">    Intent intent, String resolvedType, <span class="hljs-type">boolean</span> requireForeground, <span class="hljs-type">int</span> userId)</span> &#123;  <br>  <span class="hljs-keyword">try</span> &#123;  <br>    <span class="hljs-keyword">return</span> getService().startService(intent, resolvedType, requireForeground, userId);  <br>  &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;  <br>    e.printStackTrace();  <br>  &#125;  <br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果创建的目标不是 <code>ProxyJobService</code> 或 <code>ProxyService</code> 的话就会往下调用，但这里我们创建的目标就是 <code>ProxyService</code>，因此这里返回 false 后会调用原生的那个处理函数真正创建这个 Service 。</p>
<p>而在正常的创建流程中，最后会向下调用这个 <code>Service</code> 的 <code>OnCreate</code> 和 <code>onStartCommand</code>，其中后者这个函数是在服务每次启动时都会调用的，因此通过 Hook 它来实现替换服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">onStartCommand</span><span class="hljs-params">(Intent intent, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> startId)</span> &#123;  <br>  AppServiceDispatcher.get().onStartCommand(intent, flags, startId);  <br>  <span class="hljs-keyword">return</span> START_NOT_STICKY;  <br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">onStartCommand</span><span class="hljs-params">(Intent proxyIntent, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> startId)</span> &#123;  <br>  <span class="hljs-type">ProxyServiceRecord</span> <span class="hljs-variable">stubRecord</span> <span class="hljs-operator">=</span> ProxyServiceRecord.create(proxyIntent);  <br>  <span class="hljs-keyword">if</span> (stubRecord.mServiceIntent == <span class="hljs-literal">null</span> || stubRecord.mServiceInfo == <span class="hljs-literal">null</span>) &#123;  <br>    <span class="hljs-keyword">return</span> START_NOT_STICKY;  <br>  &#125;  <br>  <br>  <span class="hljs-comment">//        Log.d(TAG, &quot;onStartCommand: &quot; + component.toString());  </span><br>  <span class="hljs-type">Service</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> getOrCreateService(stubRecord);  <br>  <span class="hljs-keyword">if</span> (service == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> START_NOT_STICKY;  <br>  stubRecord.mServiceIntent.setExtrasClassLoader(service.getClassLoader());  <br>  <span class="hljs-type">ServiceRecord</span> <span class="hljs-variable">record</span> <span class="hljs-operator">=</span> findRecord(stubRecord.mServiceIntent);  <br>  record.setStartId(stubRecord.mStartId);  <br>  <span class="hljs-keyword">try</span> &#123;  <br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> service.onStartCommand(stubRecord.mServiceIntent, flags, stubRecord.mStartId);  <br>    SandBoxCore.getBActivityManager().onStartCommand(proxyIntent, stubRecord.mUserId);  <br>    <span class="hljs-keyword">return</span> i;  <br>  &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;  <br>    e.printStackTrace();  <br>  &#125;  <br>  <span class="hljs-keyword">return</span> START_NOT_STICKY;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>在下面这个 <code>onStartCommand</code> 里去加载真正的目标服务相关的代码和对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Service <span class="hljs-title function_">getOrCreateService</span><span class="hljs-params">(ProxyServiceRecord proxyServiceRecord)</span> &#123;  <br>  <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> proxyServiceRecord.mServiceIntent;  <br>  <span class="hljs-type">ServiceInfo</span> <span class="hljs-variable">serviceInfo</span> <span class="hljs-operator">=</span> proxyServiceRecord.mServiceInfo;  <br>  <span class="hljs-type">IBinder</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> proxyServiceRecord.mToken;  <br>  <br>  <span class="hljs-type">ServiceRecord</span> <span class="hljs-variable">record</span> <span class="hljs-operator">=</span> findRecord(intent);  <br>  <span class="hljs-keyword">if</span> (record != <span class="hljs-literal">null</span> &amp;&amp; record.getService() != <span class="hljs-literal">null</span>) &#123;  <br>    <span class="hljs-keyword">return</span> record.getService();  <br>  &#125;  <br>  <span class="hljs-type">Service</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> BActivityThread.currentActivityThread().createService(serviceInfo, token);  <br>  <span class="hljs-keyword">if</span> (service == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <br>  record = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceRecord</span>();  <br>  record.setService(service);  <br>  mService.put(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>.FilterComparison(intent), record);  <br>  <span class="hljs-keyword">return</span> service;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>重点关注调用的 <code>createService</code> 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Service <span class="hljs-title function_">createService</span><span class="hljs-params">(ServiceInfo serviceInfo, IBinder token)</span> &#123;  <br>  <span class="hljs-keyword">if</span> (!BActivityThread.currentActivityThread().isInit()) &#123;  <br>    BActivityThread.currentActivityThread()  <br>        .bindApplication(serviceInfo.packageName, serviceInfo.processName);  <br>  &#125;  <br>  <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> BRLoadedApk.get(mBoundApplication.info).getClassLoader();  <br>  Service service;  <br>  <span class="hljs-keyword">try</span> &#123;  <br>    service = (Service) classLoader.loadClass(serviceInfo.name).newInstance();  <br>  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;  <br>    e.printStackTrace();  <br>    Slog.e(TAG, <span class="hljs-string">&quot;Unable to instantiate service &quot;</span> + serviceInfo.name + <span class="hljs-string">&quot;: &quot;</span> + e.toString());  <br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <br>  &#125;<br></code></pre></td></tr></table></figure>

<p>可以看到，程序在这里将服务的代码加载进内存并构建为 Service 对象。</p>
<p>最后再调用它本身的 <code>onStartCommand</code> 函数收个尾：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> service.onStartCommand(stubRecord.mServiceIntent, flags, stubRecord.mStartId);<br></code></pre></td></tr></table></figure>

<h2 id="VirtualApp-环境中的兼容-bindService"><a href="#VirtualApp-环境中的兼容-bindService" class="headerlink" title="VirtualApp 环境中的兼容 bindService"></a>VirtualApp 环境中的兼容 bindService</h2><p>启动服务还有另外一种通过 <code>bindService</code> 实现的方法，不过同前面的方法并没有太大变化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ProxyMethod(&quot;bindService&quot;)</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BindService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MethodHook</span> &#123;  <br>  <br>  <span class="hljs-meta">@Override</span>  <br>  <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">hook</span><span class="hljs-params">(Object who, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;  <br>    <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> (Intent) args[<span class="hljs-number">2</span>];  <br>    <span class="hljs-keyword">if</span> (BuildCompat.isT() &amp;&amp; intent != <span class="hljs-literal">null</span>) &#123;  <br>      <span class="hljs-comment">// bindwebview 的 服务 不需要代理 , 类似还需要添加其他机型的适配  </span><br>      <span class="hljs-type">ComponentName</span> <span class="hljs-variable">componentName</span> <span class="hljs-operator">=</span> intent.getComponent();  <br>      <span class="hljs-keyword">if</span> (componentName != <span class="hljs-literal">null</span>) &#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">webviewClass</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;org.chromium.content.app.SandboxedProcessService0&quot;</span>;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">webviewPackage</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.huawei.webview&quot;</span>;  <br>        <span class="hljs-keyword">if</span> (webviewClass.equals(componentName.getClassName())  <br>            &amp;&amp; webviewPackage.equals(componentName.getPackageName())) &#123;  <br>          <span class="hljs-keyword">return</span> method.invoke(who, args);  <br>        &#125;  <br>      &#125;  <br>    &#125;  <br>    <span class="hljs-keyword">if</span> (intent != <span class="hljs-literal">null</span>) &#123;  <br>      <span class="hljs-type">ComponentName</span> <span class="hljs-variable">componentName</span> <span class="hljs-operator">=</span> intent.getComponent();  <br>      <span class="hljs-keyword">if</span> (componentName != <span class="hljs-literal">null</span>) &#123;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">screenOrientationServiceClass</span> <span class="hljs-operator">=</span>  <br>            <span class="hljs-string">&quot;com.hello.sandbox.ui.screen.ScreenOrientationService&quot;</span>;  <br>        <span class="hljs-type">String</span> <span class="hljs-variable">miheappPackage</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.hello.miheapp&quot;</span>;  <br>        <span class="hljs-keyword">if</span> (screenOrientationServiceClass.equals(componentName.getClassName())  <br>            &amp;&amp; miheappPackage.equals(componentName.getPackageName())) &#123;  <br>          <span class="hljs-keyword">return</span> method.invoke(who, args);  <br>        &#125;  <br>      &#125;  <br>    &#125;  <br>    <span class="hljs-type">String</span> <span class="hljs-variable">resolvedType</span> <span class="hljs-operator">=</span> (String) args[<span class="hljs-number">3</span>];  <br>    <span class="hljs-type">IServiceConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> (IServiceConnection) args[<span class="hljs-number">4</span>];  <br>  <br>    <span class="hljs-type">int</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> intent.getIntExtra(<span class="hljs-string">&quot;_B_|_UserId&quot;</span>, -<span class="hljs-number">1</span>);  <br>    userId = userId == -<span class="hljs-number">1</span> ? BActivityThread.getUserId() : userId;  <br>    <span class="hljs-type">ResolveInfo</span> <span class="hljs-variable">resolveInfo</span> <span class="hljs-operator">=</span>  <br>        SandBoxCore.getBPackageManager().resolveService(intent, <span class="hljs-number">0</span>, resolvedType, userId);  <br>    <span class="hljs-keyword">if</span> (resolveInfo != <span class="hljs-literal">null</span> || AppSystemEnv.isOpenPackage(intent.getComponent())) &#123;  <br>      <span class="hljs-type">Intent</span> <span class="hljs-variable">proxyIntent</span> <span class="hljs-operator">=</span>  <br>          SandBoxCore.getBActivityManager()  <br>              .bindService(  <br>                  intent,  <br>                  connection == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : connection.asBinder(),  <br>                  resolvedType,  <br>                  userId);  <br>      <span class="hljs-keyword">if</span> (connection != <span class="hljs-literal">null</span>) &#123;  <br>        <span class="hljs-keyword">if</span> (intent.getComponent() == <span class="hljs-literal">null</span> &amp;&amp; resolveInfo != <span class="hljs-literal">null</span>) &#123;  <br>          intent.setComponent(  <br>              <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(  <br>                  resolveInfo.serviceInfo.packageName, resolveInfo.serviceInfo.name));  <br>        &#125;  <br>        <span class="hljs-type">IServiceConnection</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> ServiceConnectionDelegate.createProxy(connection, intent);  <br>        args[<span class="hljs-number">4</span>] = proxy;  <br>  <br>        WeakReference&lt;?&gt; weakReference =  <br>            BRLoadedApkServiceDispatcherInnerConnection.get(connection).mDispatcher();  <br>        <span class="hljs-keyword">if</span> (weakReference != <span class="hljs-literal">null</span>) &#123;  <br>          BRLoadedApkServiceDispatcher.get(weakReference.get())._set_mConnection(proxy);  <br>        &#125;  <br>      &#125;  <br>      <span class="hljs-keyword">if</span> (proxyIntent != <span class="hljs-literal">null</span>) &#123;  <br>        args[<span class="hljs-number">2</span>] = proxyIntent;  <br>        <span class="hljs-keyword">return</span> method.invoke(who, args);  <br>      &#125;  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <br>  &#125;  <br>  <br>  <span class="hljs-meta">@Override</span>  <br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnable</span><span class="hljs-params">()</span> &#123;  <br>    <span class="hljs-keyword">return</span> SandBoxCore.get().isBlackProcess() || SandBoxCore.get().isServerProcess();  <br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>函数执行过程中主要关注下面这个函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Intent <span class="hljs-title function_">bindService</span><span class="hljs-params">(Intent intent, <span class="hljs-keyword">final</span> IBinder binder, String resolvedType, <span class="hljs-type">int</span> userId)</span> &#123;  <br>  <span class="hljs-type">ResolveInfo</span> <span class="hljs-variable">resolveInfo</span> <span class="hljs-operator">=</span> resolveService(intent, resolvedType, userId);  <br>  <span class="hljs-keyword">if</span> (resolveInfo == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> intent;  <br>  <span class="hljs-type">ServiceInfo</span> <span class="hljs-variable">serviceInfo</span> <span class="hljs-operator">=</span> resolveInfo.serviceInfo;  <br>  <span class="hljs-type">ProcessRecord</span> <span class="hljs-variable">processRecord</span> <span class="hljs-operator">=</span>  <br>      BProcessManagerService.get()  <br>          .startProcessLocked(  <br>              serviceInfo.packageName,  <br>              serviceInfo.processName,  <br>              userId,  <br>              -<span class="hljs-number">1</span>,  <br>              Binder.getCallingPid());  <br>  <br>  <span class="hljs-keyword">if</span> (processRecord == <span class="hljs-literal">null</span>) &#123;  <br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Unable to create &quot;</span> + serviceInfo.name);  <br>  &#125;  <br>  <br>  RunningServiceRecord runningServiceRecord;  <br>  <span class="hljs-keyword">synchronized</span> (mRunningServiceRecords) &#123;  <br>    runningServiceRecord = getOrCreateRunningServiceRecord(intent);  <br>    runningServiceRecord.mServiceInfo = serviceInfo;  <br>  <br>    <span class="hljs-keyword">if</span> (binder != <span class="hljs-literal">null</span>) &#123;  <br>      <span class="hljs-type">ConnectedServiceRecord</span> <span class="hljs-variable">connectedService</span> <span class="hljs-operator">=</span> mConnectedServices.get(binder);  <br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">isBound</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;  <br>      <span class="hljs-keyword">if</span> (connectedService != <span class="hljs-literal">null</span>) &#123;  <br>        isBound = <span class="hljs-literal">true</span>;  <br>      &#125; <span class="hljs-keyword">else</span> &#123;  <br>        connectedService = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectedServiceRecord</span>();  <br>        <span class="hljs-keyword">try</span> &#123;  <br>          binder.linkToDeath(  <br>              <span class="hljs-keyword">new</span> <span class="hljs-title class_">IBinder</span>.DeathRecipient() &#123;  <br>                <span class="hljs-meta">@Override</span>  <br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">binderDied</span><span class="hljs-params">()</span> &#123;  <br>                  binder.unlinkToDeath(<span class="hljs-built_in">this</span>, <span class="hljs-number">0</span>);  <br>                  mConnectedServices.remove(binder);  <br>                &#125;  <br>              &#125;,  <br>              <span class="hljs-number">0</span>);  <br>        &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;  <br>          e.printStackTrace();  <br>        &#125;  <br>        connectedService.mIBinder = binder;  <br>        connectedService.mIntent = intent;  <br>        mConnectedServices.put(binder, connectedService);  <br>      &#125;  <br>  <br>      <span class="hljs-keyword">if</span> (!isBound) &#123;  <br>        runningServiceRecord.incrementBindCountAndGet();  <br>      &#125;  <br>      runningServiceRecord.mConnectedServiceRecord = connectedService;  <br>    &#125;  <br>  &#125;  <br>  <span class="hljs-keyword">return</span> createStubServiceIntent(intent, serviceInfo, processRecord, runningServiceRecord);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>startProcessLocked</code> 函数相信已经不陌生了，就是之前 Activity 时用到的那个，然后最后仍然是执行 <code>createStubServiceIntent</code> 来创建一个用来启动 <code>ProxyService</code> 的 <code>Intent</code>。</p>
<p>然后最后调用的是原生的那个 bindService：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">return</span> method.invoke(who, args);<br></code></pre></td></tr></table></figure>

<p>然后在创建的服务完成以后会主动调用 <code>onBind</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Nullable</span>  <br><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent intent)</span> &#123;  <br>  <span class="hljs-keyword">return</span> AppServiceDispatcher.get().onBind(intent);  <br>&#125;<br><br><span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">onBind</span><span class="hljs-params">(Intent proxyIntent)</span> &#123;  <br>  <span class="hljs-type">ProxyServiceRecord</span> <span class="hljs-variable">serviceRecord</span> <span class="hljs-operator">=</span> ProxyServiceRecord.create(proxyIntent);  <br>  <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> serviceRecord.mServiceIntent;  <br>  <span class="hljs-type">ServiceInfo</span> <span class="hljs-variable">serviceInfo</span> <span class="hljs-operator">=</span> serviceRecord.mServiceInfo;  <br>  <br>  <span class="hljs-keyword">if</span> (intent == <span class="hljs-literal">null</span> || serviceInfo == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <br>  <br>  <span class="hljs-comment">//        Log.d(TAG, &quot;onBind: &quot; + component.toString());  </span><br>  <br>  <span class="hljs-type">Service</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> getOrCreateService(serviceRecord);  <br>  <span class="hljs-keyword">if</span> (service == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <br>  intent.setExtrasClassLoader(service.getClassLoader());  <br>  <br>  <span class="hljs-type">ServiceRecord</span> <span class="hljs-variable">record</span> <span class="hljs-operator">=</span> findRecord(intent);  <br>  record.incrementAndGetBindCount(intent);  <br>  <span class="hljs-keyword">if</span> (record.hasBinder(intent)) &#123;  <br>    <span class="hljs-keyword">if</span> (record.isRebind()) &#123;  <br>      service.onRebind(intent);  <br>      record.setRebind(<span class="hljs-literal">false</span>);  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> record.getBinder(intent);  <br>  &#125;  <br>  <br>  <span class="hljs-keyword">try</span> &#123;  <br>    <span class="hljs-type">IBinder</span> <span class="hljs-variable">iBinder</span> <span class="hljs-operator">=</span> service.onBind(intent);  <br>    record.addBinder(intent, iBinder);  <br>    <span class="hljs-keyword">return</span> iBinder;  <br>  &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;  <br>    e.printStackTrace();  <br>  &#125;  <br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到也是一样在这个时候去加载真正的目标代码并启动该服务的。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这套流程跟网上搜到的很多资料有些不同，笔者查到的很多资料都表示直接调用 <code>scheduleCreateService</code> 去创建对应服务，而不再经过原生的 AMS 。但在阅读 Blackbox 的代码后我们可以发现实际情况并非如此，启动 Service 跟启动 Activity 有很多地方很相似，它们同样需要提前占坑，并以类似伪造 Intent 的方式去启动对应的目标，然后通过 Hook 的方式来替换真正的目标。</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a target="_blank" rel="noopener" href="https://gityuan.com/2016/03/06/start-service/">https://gityuan.com/2016/03/06/start-service/</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_26460841/article/details/118441738">https://blog.csdn.net/qq_26460841/article/details/118441738</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2025/05/24/VirtualApp%E5%8E%9F%E7%90%86%E9%80%9F%E8%A7%88%20-%20Content%20Provider%20%E5%AE%B9%E5%99%A8%E5%86%85%E5%AE%9E%E7%8E%B0/">← Next VirtualApp原理速览 - Content Provider 容器内实现</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2025/05/24/VirtualApp%E5%8E%9F%E7%90%86%E9%80%9F%E8%A7%88%20-%20%E5%AE%B9%E5%99%A8%E5%86%85%20APP%20%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">VirtualApp原理速览 - 容器内 APP 启动流程 Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/6.png" alt="Logo"></a><h1 id="Dr"><a href="TokameinE">TokameinE</a></h1><div id="description"><p></p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/ErodedElk"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" target="_blank" rel="noopener" href="https://space.bilibili.com/1782544616"><i class="fa-brands fa-bilibili" alt="BiliBili"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%86%85-Service-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">2.</span> <span class="toc-text">容器内 Service 启动流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%94%9F-Service-%E7%9A%84%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">原生 Service 的创建流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VirtualApp-%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%85%BC%E5%AE%B9-startService"><span class="toc-number">2.2.</span> <span class="toc-text">VirtualApp 环境中的兼容 startService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VirtualApp-%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%85%BC%E5%AE%B9-bindService"><span class="toc-number">2.3.</span> <span class="toc-text">VirtualApp 环境中的兼容 bindService</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">2.4.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">3.</span> <span class="toc-text">参考文章</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>