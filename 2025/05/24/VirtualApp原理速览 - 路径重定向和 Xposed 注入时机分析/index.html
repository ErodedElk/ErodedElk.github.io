<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>VirtualApp原理速览 - 路径重定向和 Xposed 注入时机分析 | TokameinE - 雨声淅淅沥沥，犬吠永不止息</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: Bender;
 src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
 font-family: BenderLight;
 src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/91110244_p0.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>VirtualApp原理速览 - 路径重定向和 Xposed 注入时机分析</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2025-05-23T23:41:16.000Z" id="date"> 2025-05-24</time></div></span><br><span>Last Update: <div class="control"><time datetime="2025-05-27T14:47:24.094Z" id="updated"> 2025-05-27</time></div></span></div></div><hr><div id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在过完了四大组件的容器内实现后，最后我们打算着重看看之前只是模糊提了几句的重定向问题，看看容器是如何把相关的资源和路径进行重定向的。</p>
<h1 id="路径重定向和-Xposed-注入时机分析"><a href="#路径重定向和-Xposed-注入时机分析" class="headerlink" title="路径重定向和 Xposed 注入时机分析"></a>路径重定向和 Xposed 注入时机分析</h1><p>在之前分析 Activity 时有这么一行代码用来支持路径的重定向：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">IOCore.get().enableRedirect(packageContext);<br></code></pre></td></tr></table></figure>

<p>代码注释中可以看到，应用本身的资源其实已经通过 Application 完成重定向了，但是仍有一些通过硬编码路径来访问文件的情况，为了避免这类访问引发崩溃，因此需要把它们重定向到新路径：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 由于正常情况Application已完成重定向，以下重定向是怕代码写死。  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">enableRedirect</span><span class="hljs-params">(Context context)</span> &#123;  <br>  Map&lt;String, String&gt; rule = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();  <br>  <span class="hljs-type">String</span> <span class="hljs-variable">packageName</span> <span class="hljs-operator">=</span> context.getPackageName();  <br>  <br>  <span class="hljs-keyword">try</span> &#123;  <br>    <span class="hljs-type">ApplicationInfo</span> <span class="hljs-variable">packageInfo</span> <span class="hljs-operator">=</span>  <br>        SandBoxCore.getBPackageManager()  <br>            .getApplicationInfo(  <br>                packageName, PackageManager.GET_META_DATA, BActivityThread.getUserId());  <br>    <span class="hljs-type">int</span> <span class="hljs-variable">systemUserId</span> <span class="hljs-operator">=</span> SandBoxCore.getHostUserId();  <br>    rule.put(String.format(<span class="hljs-string">&quot;/data/data/%s/lib&quot;</span>, packageName), packageInfo.nativeLibraryDir);  <br>    rule.put(  <br>        String.format(<span class="hljs-string">&quot;/data/user/%d/%s/lib&quot;</span>, systemUserId, packageName),  <br>        packageInfo.nativeLibraryDir);  <br>  <br>    rule.put(String.format(<span class="hljs-string">&quot;/data/data/%s&quot;</span>, packageName), packageInfo.dataDir);  <br>    rule.put(String.format(<span class="hljs-string">&quot;/data/user/%d/%s&quot;</span>, systemUserId, packageName), packageInfo.dataDir);  <br>  <br>    <span class="hljs-keyword">if</span> (SandBoxCore.getContext().getExternalCacheDir() != <span class="hljs-literal">null</span>  <br>        &amp;&amp; context.getExternalCacheDir() != <span class="hljs-literal">null</span>) &#123;  <br>      <span class="hljs-type">File</span> <span class="hljs-variable">external</span> <span class="hljs-operator">=</span> BEnvironment.getExternalUserDir(BActivityThread.getUserId());  <br>      <span class="hljs-comment">// sdcard  </span><br>      <span class="hljs-type">File</span> <span class="hljs-variable">sdcardAndroidFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;/sdcard/Android&quot;</span>);  <br>      <span class="hljs-type">String</span> <span class="hljs-variable">androidDir</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;/storage/emulated/%d/Android&quot;</span>, systemUserId);  <br>      <span class="hljs-keyword">if</span> (!sdcardAndroidFile.exists()) &#123;  <br>        sdcardAndroidFile = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(androidDir);  <br>      &#125;  <br>      <span class="hljs-keyword">if</span> (sdcardAndroidFile.exists()) &#123;  <br>        File[] childDirs = sdcardAndroidFile.listFiles(pathname -&gt; pathname.isDirectory());  <br>        <span class="hljs-keyword">if</span> (childDirs != <span class="hljs-literal">null</span>) &#123;  <br>          <span class="hljs-keyword">for</span> (File childDir : childDirs) &#123;  <br>            Log.d(TAG, childDir.getAbsolutePath());  <br>            rule.put(  <br>                <span class="hljs-string">&quot;/sdcard/Android/&quot;</span> + childDir.getName(),  <br>                external.getAbsolutePath() + <span class="hljs-string">&quot;/Android/&quot;</span> + childDir.getName());  <br>            rule.put(  <br>                androidDir + <span class="hljs-string">&quot;/&quot;</span> + childDir.getName(),  <br>                external.getAbsolutePath() + <span class="hljs-string">&quot;/Android/&quot;</span> + childDir.getName());  <br>          &#125;  <br>        &#125; <span class="hljs-keyword">else</span> &#123;  <br>          rule.put(<span class="hljs-string">&quot;/sdcard/Android&quot;</span>, external.getAbsolutePath() + <span class="hljs-string">&quot;/Android&quot;</span>);  <br>          rule.put(androidDir, external.getAbsolutePath() + <span class="hljs-string">&quot;/Android&quot;</span>);  <br>        &#125;  <br>      &#125; <span class="hljs-keyword">else</span> &#123;  <br>        rule.put(<span class="hljs-string">&quot;/sdcard/Android&quot;</span>, external.getAbsolutePath());  <br>        rule.put(androidDir, external.getAbsolutePath());  <br>      &#125;  <br>    &#125;  <br>    <span class="hljs-keyword">if</span> (SandBoxCore.get().isHideRoot()) &#123;  <br>      hideRoot(rule);  <br>    &#125;  <br>    proc(rule);  <br>  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;  <br>    e.printStackTrace();  <br>  &#125;  <br>  <span class="hljs-keyword">for</span> (String key : rule.keySet()) &#123;  <br>    get().addRedirect(key, rule.get(key));  <br>  &#125;  <br>  NativeCore.enableIO();  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>总的来说，先初始化了一些重定向规则，包括：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">rule.put(String.format(<span class="hljs-string">&quot;/data/data/%s/lib&quot;</span>, packageName), packageInfo.nativeLibraryDir);<br>rule.put(  <br>    String.format(<span class="hljs-string">&quot;/data/user/%d/%s/lib&quot;</span>, systemUserId, packageName),  <br>    packageInfo.nativeLibraryDir);<br>rule.put(String.format(<span class="hljs-string">&quot;/data/data/%s&quot;</span>, packageName), packageInfo.dataDir);  <br>rule.put(String.format(<span class="hljs-string">&quot;/data/user/%d/%s&quot;</span>, systemUserId, packageName), packageInfo.dataDir);<br>rule.put(  <br>    <span class="hljs-string">&quot;/sdcard/Android/&quot;</span> + childDir.getName(),  <br>    external.getAbsolutePath() + <span class="hljs-string">&quot;/Android/&quot;</span> + childDir.getName());  <br>rule.put(  <br>    androidDir + <span class="hljs-string">&quot;/&quot;</span> + childDir.getName(),  <br>    external.getAbsolutePath() + <span class="hljs-string">&quot;/Android/&quot;</span> + childDir.getName());<br></code></pre></td></tr></table></figure>

<p>除此之位还有对进程路径的重定向：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">proc</span><span class="hljs-params">(Map&lt;String, String&gt; rule)</span> &#123;  <br>  <span class="hljs-type">int</span> <span class="hljs-variable">appPid</span> <span class="hljs-operator">=</span> BActivityThread.getAppPid();  <br>  <span class="hljs-type">int</span> <span class="hljs-variable">pid</span> <span class="hljs-operator">=</span> Process.myPid();  <br>  <span class="hljs-type">String</span> <span class="hljs-variable">selfProc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/proc/self/&quot;</span>;  <br>  <span class="hljs-type">String</span> <span class="hljs-variable">proc</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/proc/&quot;</span> + pid + <span class="hljs-string">&quot;/&quot;</span>;  <br>  <br>  <span class="hljs-type">String</span> <span class="hljs-variable">cmdline</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(BEnvironment.getProcDir(appPid), <span class="hljs-string">&quot;cmdline&quot;</span>).getAbsolutePath();  <br>  rule.put(proc + <span class="hljs-string">&quot;cmdline&quot;</span>, cmdline);  <br>  rule.put(selfProc + <span class="hljs-string">&quot;cmdline&quot;</span>, cmdline);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>相当于把对这些路径的访问全部过滤成后面的那个参数，然后再把它们注入到 Native 层去：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addRedirect</span><span class="hljs-params">(String origPath, String redirectPath)</span> &#123;  <br>  <span class="hljs-keyword">if</span> (TextUtils.isEmpty(origPath)  <br>      || TextUtils.isEmpty(redirectPath)  <br>      || mRedirectMap.get(origPath) != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;  <br>  <span class="hljs-comment">// Add the key to TrieTree  </span><br>  mTrieTree.add(origPath);  <br>  mRedirectMap.put(origPath, redirectPath);  <br>  <span class="hljs-type">File</span> <span class="hljs-variable">redirectFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(redirectPath);  <br>  <span class="hljs-keyword">if</span> (!redirectFile.exists()) &#123;  <br>    FileUtils.mkdirs(redirectPath);  <br>  &#125;  <br>  NativeCore.addIORule(origPath, redirectPath);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>最后激活一下这些规则：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">enableIO</span><span class="hljs-params">(JNIEnv *env, jclass clazz)</span> &#123;  <br>    IO::init(env);  <br>    nativeHook(env);  <br>&#125;<br><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">nativeHook</span><span class="hljs-params">(JNIEnv *env)</span> &#123;  <br>    BaseHook::init(env);  <br>    UnixFileSystemHook::init(env);  <br>    VMClassLoaderHook::init(env);  <br><span class="hljs-comment">//    RuntimeHook::init(env);  </span><br>    BinderHook::init(env);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到，容器对三个对象做了重定向，分别是文件系统、ClassLoader 以及 Binder。</p>
<h2 id="文件系统-Hook"><a href="#文件系统-Hook" class="headerlink" title="文件系统 Hook"></a>文件系统 Hook</h2><p>我们从文件系统看起：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> UnixFileSystemHook::init(JNIEnv *env) &#123;  <br>  const <span class="hljs-type">char</span> *className = <span class="hljs-string">&quot;java/io/UnixFileSystem&quot;</span>;  <br>  JniHook::HookJniFun(env,  <br>                      className,  <br>                      <span class="hljs-string">&quot;canonicalize0&quot;</span>,  <br>                      <span class="hljs-string">&quot;(Ljava/lang/String;)Ljava/lang/String;&quot;</span>,  <br>                      (<span class="hljs-keyword">void</span> *) new_canonicalize0,  <br>                      (<span class="hljs-keyword">void</span> **) (&amp;orig_canonicalize0),  <br>                      <span class="hljs-literal">false</span>);  <br>  JniHook::HookJniFun(env,  <br>                      className,  <br>                      <span class="hljs-string">&quot;getBooleanAttributes0&quot;</span>,  <br>                      <span class="hljs-string">&quot;(Ljava/lang/String;)I&quot;</span>,  <br>                      (<span class="hljs-keyword">void</span> *) new_getBooleanAttributes0,  <br>                      (<span class="hljs-keyword">void</span> **) (&amp;orig_getBooleanAttributes0),  <br>                      <span class="hljs-literal">false</span>);  <br>  JniHook::HookJniFun(env,  <br>                      className,  <br>                      <span class="hljs-string">&quot;getLastModifiedTime0&quot;</span>,  <br>                      <span class="hljs-string">&quot;(Ljava/io/File;)J&quot;</span>,  <br>                      (<span class="hljs-keyword">void</span> *) new_getLastModifiedTime0,  <br>                      (<span class="hljs-keyword">void</span> **) (&amp;orig_getLastModifiedTime0),  <br>                      <span class="hljs-literal">false</span>);  <br>  JniHook::HookJniFun(env,  <br>                      className,  <br>                      <span class="hljs-string">&quot;setPermission0&quot;</span>,  <br>                      <span class="hljs-string">&quot;(Ljava/io/File;IZZ)Z&quot;</span>,  <br>                      (<span class="hljs-keyword">void</span> *) new_setPermission0,  <br>                      (<span class="hljs-keyword">void</span> **) (&amp;orig_setPermission0),  <br>                      <span class="hljs-literal">false</span>);  <br>  JniHook::HookJniFun(env,  <br>                      className,  <br>                      <span class="hljs-string">&quot;createFileExclusively0&quot;</span>,  <br>                      <span class="hljs-string">&quot;(Ljava/lang/String;)Z&quot;</span>,  <br>                      (<span class="hljs-keyword">void</span> *) new_createFileExclusively0,  <br>                      (<span class="hljs-keyword">void</span> **) (&amp;orig_createFileExclusively0),  <br>                      <span class="hljs-literal">false</span>);  <br>  JniHook::HookJniFun(env,  <br>                      className,  <br>                      <span class="hljs-string">&quot;list0&quot;</span>,  <br>                      <span class="hljs-string">&quot;(Ljava/io/File;)[Ljava/lang/String;&quot;</span>,  <br>                      (<span class="hljs-keyword">void</span> *) new_list0,  <br>                      (<span class="hljs-keyword">void</span> **) (&amp;orig_list0),  <br>                      <span class="hljs-literal">false</span>);  <br>  JniHook::HookJniFun(env,  <br>                      className,  <br>                      <span class="hljs-string">&quot;createDirectory0&quot;</span>,  <br>                      <span class="hljs-string">&quot;(Ljava/io/File;)Z&quot;</span>,  <br>                      (<span class="hljs-keyword">void</span> *) new_createDirectory0,  <br>                      (<span class="hljs-keyword">void</span> **) (&amp;orig_createDirectory0),  <br>                      <span class="hljs-literal">false</span>);  <br>  JniHook::HookJniFun(env,  <br>                      className,  <br>                      <span class="hljs-string">&quot;setLastModifiedTime0&quot;</span>,  <br>                      <span class="hljs-string">&quot;(Ljava/io/File;J)Z&quot;</span>,  <br>                      (<span class="hljs-keyword">void</span> *) new_setLastModifiedTime0,  <br>                      (<span class="hljs-keyword">void</span> **) (&amp;orig_setLastModifiedTime0),  <br>                      <span class="hljs-literal">false</span>);  <br>  JniHook::HookJniFun(env,  <br>                      className,  <br>                      <span class="hljs-string">&quot;setReadOnly0&quot;</span>,  <br>                      <span class="hljs-string">&quot;(Ljava/io/File;)Z&quot;</span>,  <br>                      (<span class="hljs-keyword">void</span> *) new_setReadOnly0,  <br>                      (<span class="hljs-keyword">void</span> **) (&amp;orig_setReadOnly0),  <br>                      <span class="hljs-literal">false</span>);  <br>  JniHook::HookJniFun(env,  <br>                      className,  <br>                      <span class="hljs-string">&quot;getSpace0&quot;</span>,  <br>                      <span class="hljs-string">&quot;(Ljava/io/File;I)J&quot;</span>,  <br>                      (<span class="hljs-keyword">void</span> *) new_getSpace0,  <br>                      (<span class="hljs-keyword">void</span> **) (&amp;orig_getSpace0),  <br>                      <span class="hljs-literal">false</span>);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到主要就是对这些函数做了 Hook，以及 Hook 的方式也很朴素：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span>  </span><br><span class="hljs-function"><span class="hljs-title">JniHook::HookJniFun</span><span class="hljs-params">(JNIEnv *env,  </span></span><br><span class="hljs-params"><span class="hljs-function">                    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *class_name,  </span></span><br><span class="hljs-params"><span class="hljs-function">                    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *method_name,  </span></span><br><span class="hljs-params"><span class="hljs-function">                    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *sign,  </span></span><br><span class="hljs-params"><span class="hljs-function">                    <span class="hljs-type">void</span> *new_fun,  </span></span><br><span class="hljs-params"><span class="hljs-function">                    <span class="hljs-type">void</span> **orig_fun,  </span></span><br><span class="hljs-params"><span class="hljs-function">                    <span class="hljs-type">bool</span> is_static)</span> </span>&#123;  <br>  <span class="hljs-keyword">if</span> (HookEnv.art_method_native_offset == <span class="hljs-number">0</span>) &#123;  <br>    <span class="hljs-keyword">return</span>;  <br>  &#125;  <br>  jclass clazz = env-&gt;<span class="hljs-built_in">FindClass</span>(class_name);  <br>  <span class="hljs-keyword">if</span> (!clazz) &#123;  <br>    <span class="hljs-built_in">ALOGD</span>(<span class="hljs-string">&quot;findClass fail: %s %s&quot;</span>, class_name, method_name);  <br>    env-&gt;<span class="hljs-built_in">ExceptionClear</span>();  <br>    <span class="hljs-keyword">return</span>;  <br>  &#125;  <br>  jmethodID method = <span class="hljs-literal">nullptr</span>;  <br>  <span class="hljs-keyword">if</span> (is_static) &#123;  <br>    method = env-&gt;<span class="hljs-built_in">GetStaticMethodID</span>(clazz, method_name, sign);  <br>  &#125; <span class="hljs-keyword">else</span> &#123;  <br>    method = env-&gt;<span class="hljs-built_in">GetMethodID</span>(clazz, method_name, sign);  <br>  &#125;  <br>  <span class="hljs-keyword">if</span> (!method) &#123;  <br>    env-&gt;<span class="hljs-built_in">ExceptionClear</span>();  <br>    <span class="hljs-built_in">ALOGD</span>(<span class="hljs-string">&quot;get method id fail: %s %s&quot;</span>, class_name, method_name);  <br>    <span class="hljs-keyword">return</span>;  <br>  &#125;  <br>  JNINativeMethod gMethods[] = &#123;  <br>      &#123;method_name, sign, (<span class="hljs-type">void</span> *) new_fun&#125;,  <br>  &#125;;  <br>  <br>  <span class="hljs-keyword">auto</span> artMethod =  <br>      <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uintptr_t</span> *&gt;(<span class="hljs-built_in">GetArtMethod</span>(env, clazz, method));  <br>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CheckFlags</span>(artMethod)) &#123;  <br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;check flags error. class：%s, method：%s&quot;</span>, class_name, method_name);  <br>    <span class="hljs-keyword">return</span>;  <br>  &#125;  <br>  *orig_fun =  <br>      <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> *&gt;(artMethod[HookEnv.art_method_native_offset]);  <br>  <span class="hljs-keyword">if</span> (env-&gt;<span class="hljs-built_in">RegisterNatives</span>(clazz, gMethods, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;  <br>    <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;jni hook error. class：%s, method：%s&quot;</span>, class_name, method_name);  <br>    <span class="hljs-keyword">return</span>;  <br>  &#125;  <br>  <span class="hljs-comment">// FastNative  </span><br>  <span class="hljs-keyword">if</span> (HookEnv.api_level == __ANDROID_API_O__  <br>      || HookEnv.api_level == __ANDROID_API_O_MR1__) &#123;  <br>    <span class="hljs-built_in">AddAccessFlag</span>((<span class="hljs-type">char</span> *) artMethod, kAccFastNative);  <br>  &#125;  <br>  <span class="hljs-built_in">ALOGD</span>(<span class="hljs-string">&quot;register class：%s, method：%s success!&quot;</span>, class_name, method_name);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>先用 GetStaticMethodID 或 GetMethodID 来获取原始函数的位置，然后把它回填到 orig_fun 中，最后调用 RegisterNatives 用新函数注册进去，替换结束。</p>
<p>而新函数基本上都是这样实现的：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">HOOK_JNI</span>(jboolean, getSpace0, JNIEnv *env, jobject obj, jobject file, jint t) &#123;  <br>  jobject redirect = IO::<span class="hljs-built_in">redirectPath</span>(env, file);  <br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">orig_getSpace0</span>(env, obj, redirect, t);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>先过滤一遍路径，然后调用原函数。过滤流程最终会调用这个函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">const <span class="hljs-type">char</span> *IO::redirectPath(const <span class="hljs-type">char</span> *__path) &#123;  <br>  list&lt;IO::RelocateInfo&gt;::iterator iterator;  <br>  <span class="hljs-keyword">for</span> (iterator = relocate_rule.begin(); iterator != relocate_rule.end(); ++iterator) &#123;  <br>    IO::<span class="hljs-type">RelocateInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> *iterator;  <br>    <span class="hljs-keyword">if</span> (strstr(__path, info.targetPath) &amp;&amp; !strstr(__path, <span class="hljs-string">&quot;/sandbox/&quot;</span>)) &#123;  <br>      <span class="hljs-type">char</span> *ret = replace(__path, info.targetPath, info.relocatePath);  <br>      ALOGD(<span class="hljs-string">&quot;redirectPath %s  =&gt; %s&quot;</span>, __path, ret);  <br>      <span class="hljs-keyword">return</span> ret;  <br>    &#125;  <br>  &#125;  <br>  <span class="hljs-keyword">return</span> __path;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>就是遍历一下找到合适的规则然后根据规则做替换，没啥别的内容了。不过这里有一个疑问，看起来程序并没有对 open、stat 之类的 libc 函数做 Hook，那如果后续有硬编码写死去调用 open 的情况是不是就会出错呢？</p>
<p>同样的，除此之外还有很多各种各样的函数被调用时参数中都会附带路径，这些函数不需要一起过滤吗？以及同时过滤这么多函数也很容易被检查发现也是一个问题。或许后续需要完善。</p>
<h2 id="ClassLoader-Hook"><a href="#ClassLoader-Hook" class="headerlink" title="ClassLoader Hook"></a>ClassLoader Hook</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> VMClassLoaderHook::init(JNIEnv *env) &#123;  <br>    const <span class="hljs-type">char</span> *className = <span class="hljs-string">&quot;java/lang/VMClassLoader&quot;</span>;  <br>    JniHook::HookJniFun(env, className, <span class="hljs-string">&quot;findLoadedClass&quot;</span>, <span class="hljs-string">&quot;(Ljava/lang/ClassLoader;Ljava/lang/String;)Ljava/lang/Class;&quot;</span>,  <br>                        (<span class="hljs-keyword">void</span> *) new_findLoadedClass,  <br>                        (<span class="hljs-keyword">void</span> **) (&amp;orig_findLoadedClass), <span class="hljs-literal">true</span>);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>挺朴素的，跟前文的方式是一样的，只是目标改成了 <code>findLoadedClass</code> 函数。</p>
<p>新函数的实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java">HOOK_JNI(jobject, findLoadedClass, JNIEnv *env, jobject obj, jobject class_loader, jstring name) &#123;  <br>    const <span class="hljs-type">char</span> * nameC = env-&gt;GetStringUTFChars(name, JNI_FALSE);  <br><span class="hljs-comment">//     ALOGD(&quot;findLoadedClass: %s&quot;, nameC);  </span><br>    <span class="hljs-keyword">if</span> (hideXposedClass) &#123;  <br>        <span class="hljs-keyword">if</span> (strstr(nameC, <span class="hljs-string">&quot;de/robv/android/xposed/&quot;</span>) ||  <br>            strstr(nameC, <span class="hljs-string">&quot;me/weishu/epic&quot;</span>) ||  <br>            strstr(nameC, <span class="hljs-string">&quot;me/weishu/exposed&quot;</span>) ||  <br>            strstr(nameC, <span class="hljs-string">&quot;de.robv.android&quot;</span>) ||  <br>            strstr(nameC, <span class="hljs-string">&quot;me.weishu.epic&quot;</span>) ||  <br>            strstr(nameC, <span class="hljs-string">&quot;me.weishu.exposed&quot;</span>)) &#123;  <br>            env-&gt;ReleaseStringUTFChars(name, nameC);  <br>            <span class="hljs-keyword">return</span> nullptr;  <br>        &#125;  <br>    &#125;  <br>    <span class="hljs-type">jobject</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> orig_findLoadedClass(env, obj, class_loader, name);  <br>    env-&gt;ReleaseStringUTFChars(name, nameC);  <br>    <span class="hljs-keyword">return</span> result;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到其实是在做一些过滤，把一些不希望被发现的 Class 过滤掉。</p>
<h2 id="Binder-Hook"><a href="#Binder-Hook" class="headerlink" title="Binder Hook"></a>Binder Hook</h2><p>同上，这次的目标是 getCallingUid 函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">BinderHook::init</span><span class="hljs-params">(JNIEnv *env)</span> </span>&#123;  <br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *clazz = <span class="hljs-string">&quot;android/os/Binder&quot;</span>;  <br>    JniHook::<span class="hljs-built_in">HookJniFun</span>(env, clazz, <span class="hljs-string">&quot;getCallingUid&quot;</span>, <span class="hljs-string">&quot;()I&quot;</span>, (<span class="hljs-type">void</span> *) new_getCallingUid,  <br>                        (<span class="hljs-type">void</span> **) (&amp;orig_getCallingUid), <span class="hljs-literal">true</span>);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>最终会先调用一遍原生函数，然后再用下面这个函数做处理：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c++">@<span class="hljs-function">Keep  </span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">getCallingUid</span><span class="hljs-params">(<span class="hljs-type">int</span> origCallingUid)</span> </span>&#123;  <br>  <span class="hljs-comment">// 系统uid  </span><br>  <span class="hljs-keyword">if</span> (origCallingUid &gt; <span class="hljs-number">0</span> &amp;&amp; origCallingUid &lt; Process.FIRST_APPLICATION_UID) <span class="hljs-keyword">return</span> origCallingUid;  <br>  <span class="hljs-comment">// 非用户应用  </span><br>  <span class="hljs-keyword">if</span> (origCallingUid &gt; Process.LAST_APPLICATION_UID) <span class="hljs-keyword">return</span> origCallingUid;  <br>  <br>  <span class="hljs-keyword">if</span> (origCallingUid == SandBoxCore.<span class="hljs-built_in">getHostUid</span>()) &#123;  <br>    <span class="hljs-keyword">return</span> BActivityThread.<span class="hljs-built_in">getCallingBUid</span>();  <br>  &#125;  <br>  <span class="hljs-keyword">return</span> origCallingUid;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果是系统 UID 或不是用户应用的话就直接返回原本的值，而如果返回的结果是容器的 Uid ，那就要过滤一下替换成容器内目标应用的 Uid 了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCallingBUid</span><span class="hljs-params">()</span> &#123;  <br>  <span class="hljs-keyword">return</span> getAppConfig() == <span class="hljs-literal">null</span> ? SandBoxCore.getHostUid() : getAppConfig().callingBUid;  <br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="seccomp-Hook"><a href="#seccomp-Hook" class="headerlink" title="seccomp Hook"></a>seccomp Hook</h2><p>除此之位，Blackbox 还基于 seccomp 实现了对系统调用的 Hook：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">init_seccomp</span><span class="hljs-params">(JNIEnv *env, jclass clazz)</span> &#123;  <br>    struct sock_filter filter[] = &#123;  <br>            BPF_STMT(BPF_LD | BPF_W | BPF_ABS, offsetof(struct seccomp_data, nr)),  <br>            BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K, __NR_openat, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>),  <br>            BPF_STMT(BPF_LD | BPF_W | BPF_ABS, offsetof(struct seccomp_data, args[<span class="hljs-number">4</span>])),  <br>            BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K, SECMAGIC, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),  <br>            BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_ALLOW),  <br>            BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_TRAP)  <br>    &#125;;  <br>  <br>    struct sock_fprog prog;  <br>    prog.filter = filter;  <br>    prog.len = (unsigned <span class="hljs-type">short</span>) (sizeof(filter) / sizeof(filter[<span class="hljs-number">0</span>]));  <br>  <br>    struct sigaction sa;  <br>    sigset_t sigset;  <br>    sigfillset(&amp;sigset);  <br>    sa.sa_sigaction = sig_callback;  <br>    sa.sa_mask = sigset;  <br>    sa.sa_flags = SA_SIGINFO;  <br>  <br>    <span class="hljs-keyword">if</span> (sigaction(SIGSYS, &amp;sa, NULL) == -<span class="hljs-number">1</span>) &#123;  <br>        <span class="hljs-keyword">return</span>;  <br>    &#125;  <br>    <span class="hljs-keyword">if</span> (prctl(PR_SET_NO_NEW_PRIVS, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>) == -<span class="hljs-number">1</span>) &#123;  <br>        <span class="hljs-keyword">return</span>;  <br>    &#125;  <br>    <span class="hljs-keyword">if</span> (prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &amp;prog) == -<span class="hljs-number">1</span>) &#123;  <br>        <span class="hljs-keyword">return</span>;  <br>    &#125;  <br>    ALOGE(<span class="hljs-string">&quot;InitCvmSeccomp Successes&quot;</span>);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>触发上述的过滤条件时，会通过信号来回调：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">sig_callback</span><span class="hljs-params">(<span class="hljs-type">int</span> signo, siginfo_t *info, <span class="hljs-keyword">void</span> *data)</span>&#123;  <br>    <span class="hljs-type">int</span> <span class="hljs-variable">my_signo</span> <span class="hljs-operator">=</span> info-&gt;si_signo;  <br>    unsigned <span class="hljs-type">long</span> syscall_number;  <br>    unsigned <span class="hljs-type">long</span> SYSARG_1, SYSARG_2, SYSARG_3, SYSARG_4, SYSARG_5, SYSARG_6;  <br>#<span class="hljs-keyword">if</span> <span class="hljs-title function_">defined</span><span class="hljs-params">(__aarch64__)</span>  <br>    syscall_number = ((ucontext_t *) data)-&gt;uc_mcontext.regs[<span class="hljs-number">8</span>];  <br>    SYSARG_1 = ((ucontext_t *) data)-&gt;uc_mcontext.regs[<span class="hljs-number">0</span>];    SYSARG_2 = ((ucontext_t *) data)-&gt;uc_mcontext.regs[<span class="hljs-number">1</span>];    SYSARG_3 = ((ucontext_t *) data)-&gt;uc_mcontext.regs[<span class="hljs-number">2</span>];    SYSARG_4 = ((ucontext_t *) data)-&gt;uc_mcontext.regs[<span class="hljs-number">3</span>];    SYSARG_5 = ((ucontext_t *) data)-&gt;uc_mcontext.regs[<span class="hljs-number">4</span>];    SYSARG_6 = ((ucontext_t *) data)-&gt;uc_mcontext.regs[<span class="hljs-number">5</span>];#elif <span class="hljs-title function_">defined</span><span class="hljs-params">(__arm__)</span>  <br>    syscall_number = ((ucontext_t *) data)-&gt;uc_mcontext.arm_r7;  <br>    SYSARG_1 = ((ucontext_t *) data)-&gt;uc_mcontext.arm_r0;  <br>    SYSARG_2 = ((ucontext_t *) data)-&gt;uc_mcontext.arm_r1;  <br>    SYSARG_3 = ((ucontext_t *) data)-&gt;uc_mcontext.arm_r2;  <br>    SYSARG_4 = ((ucontext_t *) data)-&gt;uc_mcontext.arm_r3;  <br>    SYSARG_5 = ((ucontext_t *) data)-&gt;uc_mcontext.arm_r4;  <br>    SYSARG_6 = ((ucontext_t *) data)-&gt;uc_mcontext.arm_r5;  <br>#<span class="hljs-keyword">else</span>  <br>#error <span class="hljs-string">&quot;Unsupported architecture&quot;</span>  <br>#endif  <br>    <span class="hljs-title function_">switch</span> <span class="hljs-params">(syscall_number)</span> &#123;  <br>        <span class="hljs-keyword">case</span> __NR_openat:&#123;  <br>            <span class="hljs-type">int</span> <span class="hljs-variable">fd</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) SYSARG_1;  <br>            const <span class="hljs-type">char</span> *pathname = (const <span class="hljs-type">char</span> *) SYSARG_2;  <br>            <span class="hljs-type">int</span> <span class="hljs-variable">flags</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) SYSARG_3;  <br>            <span class="hljs-type">int</span> <span class="hljs-variable">mode</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) SYSARG_4;  <br>            ALOGE(<span class="hljs-string">&quot;测试%s&quot;</span>,pathname);  <br>#<span class="hljs-keyword">if</span> <span class="hljs-title function_">defined</span><span class="hljs-params">(__aarch64__)</span>  <br>            ((ucontext_t *) data)-&gt;uc_mcontext.regs[<span class="hljs-number">0</span>] = (uint64_t)fd;  <br>            ((ucontext_t *) data)-&gt;uc_mcontext.regs[<span class="hljs-number">1</span>] = (uint64_t)pathname;            ((ucontext_t *) data)-&gt;uc_mcontext.regs[<span class="hljs-number">2</span>] = (uint64_t)flags;            ((ucontext_t *) data)-&gt;uc_mcontext.regs[<span class="hljs-number">3</span>] = (uint64_t)mode;#elif <span class="hljs-title function_">defined</span><span class="hljs-params">(__arm__)</span>  <br>            ((ucontext_t *) data)-&gt;uc_mcontext.arm_r0 = (uint32_t)fd;  <br>            ((ucontext_t *) data)-&gt;uc_mcontext.arm_r1 = (uint32_t)pathname;  <br>            ((ucontext_t *) data)-&gt;uc_mcontext.arm_r2 = (uint32_t)flags;  <br>            ((ucontext_t *) data)-&gt;uc_mcontext.arm_r3 = (uint32_t)mode;  <br>#endif  <br>#<span class="hljs-keyword">if</span> <span class="hljs-title function_">defined</span><span class="hljs-params">(__aarch64__)</span>  <br>            ((ucontext_t *) data)-&gt;uc_mcontext.regs[<span class="hljs-number">0</span>] = OriSyscall(__NR_openat, fd, (uint64_t)pathname, flags, mode, SECMAGIC, SECMAGIC);  <br>#elif <span class="hljs-title function_">defined</span><span class="hljs-params">(__arm__)</span>  <br>            ((ucontext_t *) data)-&gt;uc_mcontext.arm_r0 = OriSyscall(__NR_openat, fd, (uint32_t)pathname, flags, mode, SECMAGIC, SECMAGIC);  <br>#endif  <br>            <span class="hljs-keyword">break</span>;  <br>        &#125;  <br>        <span class="hljs-keyword">default</span>:  <br>            <span class="hljs-keyword">break</span>;  <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到，在这类对 openat 的系统调用做了拦截，不过目前还并没有做什么过滤，未来应该会有更好的支持。</p>
<h2 id="Xposed-支持"><a href="#Xposed-支持" class="headerlink" title="Xposed 支持"></a>Xposed 支持</h2><p>算是最后一个笔者好奇的点。笔者之前并没有使用过 Xposed 的经历，因此对相关的内容其实不是很了解。通过网上的一些资料了解到，Xposed 是通过修改 app_process 的方式向进程里注入代码实现的，而这些操作需要它能够对 zygote 实现 Hook，那么对于 VirtualApp 来说要如何支持呢？</p>
<p>入口从创建应用时的 <code>newApplication</code> 开始：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">public</span> Application <span class="hljs-title function_">newApplication</span><span class="hljs-params">(ClassLoader cl, String className, Context context)</span>  <br>    <span class="hljs-keyword">throws</span> InstantiationException, IllegalAccessException, ClassNotFoundException &#123;  <br>  ContextCompat.fix(context);  <br>  fixSharedLibraryLoaders(cl);  <br>  BActivityThread.currentActivityThread().loadXposed(context);  <br>  delegateAppClassLoader = context.getClassLoader();  <br>  <span class="hljs-keyword">if</span> (RomUtil.isHuawei()) &#123;  <br>    hookHwEnvironment$UserEnvironment();  <br>  &#125;  <br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.newApplication(cl, className, context);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>因为之前创建启动 <code>Activity</code> 时已经用 <code>AppInstrumentation</code> 替换掉了 <code>Instrumentation</code> ，而在正常的创建流程中会调用该对象的 <code>newApplication</code> 函数，而 Xposed 的注入就发生在这个时机。这个时候应用对应的进程已经创建好了，后续就是等待绑定的流程了，而应用还尚且没有开始运行，因此算是合适的时机之一。</p>
<p>可以看到代码中在此刻加载了 Xposed，然后再带调用原生的 <code>newApplication</code> 恢复创建流程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadXposed</span><span class="hljs-params">(Context context)</span> &#123;  <br>  <span class="hljs-type">String</span> <span class="hljs-variable">vPackageName</span> <span class="hljs-operator">=</span> getAppPackageName();  <br>  <span class="hljs-type">String</span> <span class="hljs-variable">vProcessName</span> <span class="hljs-operator">=</span> getAppProcessName();  <br>  <span class="hljs-keyword">if</span> (!TextUtils.isEmpty(vPackageName)  <br>      &amp;&amp; !TextUtils.isEmpty(vProcessName)  <br>      &amp;&amp; BXposedManager.get().isXPEnable()) &#123;  <br>    <span class="hljs-keyword">assert</span> vPackageName != <span class="hljs-literal">null</span>;  <br>    <span class="hljs-keyword">assert</span> vProcessName != <span class="hljs-literal">null</span>;  <br>  <br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isFirstApplication</span> <span class="hljs-operator">=</span> vPackageName.equals(vProcessName);  <br>  <br>    List&lt;InstalledModule&gt; installedModules = BXposedManager.get().getInstalledModules();  <br>    <span class="hljs-keyword">for</span> (InstalledModule installedModule : installedModules) &#123;  <br>      <span class="hljs-keyword">if</span> (!installedModule.enable) &#123;  <br>        <span class="hljs-keyword">continue</span>;  <br>      &#125;  <br>      <span class="hljs-keyword">try</span> &#123;  <br>        PineXposed.loadModule(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(installedModule.getApplication().sourceDir));  <br>      &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;  <br>        e.printStackTrace();  <br>      &#125;  <br>    &#125;  <br>    <span class="hljs-keyword">try</span> &#123;  <br>      PineXposed.onPackageLoad(  <br>          vPackageName,  <br>          vProcessName,  <br>          context.getApplicationInfo(),  <br>          isFirstApplication,  <br>          context.getClassLoader());  <br>    &#125; <span class="hljs-keyword">catch</span> (Throwable ignored) &#123;  <br>    &#125;  <br>  &#125;  <br>  <span class="hljs-keyword">if</span> (SandBoxCore.get().isHideXposed()) &#123;  <br>    NativeCore.hideXposed();  <br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>代码中遍历了容器内安装的所有模块，并通过 <code>PineXposed.loadModule</code> 来加载，这似乎是一个框架的内部实现，翻到了作者的原文笔记。里面提到的说是直接套了 SandHook 的 API ，继续往下翻似乎就是 SandVXposed ，不过最后也没咋找到我想看的，于是只好自己翻起其他的资料对照着源码试着啃啃看了。</p>
<p>首先是加载 Xposed 的相关代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java">  <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;assets/xposed_init&quot;</span>;  <br>  <span class="hljs-keyword">if</span> (mcl <span class="hljs-keyword">instanceof</span> ModuleClassLoader) &#123;  <br>    <span class="hljs-comment">// Fast and provided more error info  </span><br>    <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> ((ModuleClassLoader) mcl).findResource(filename);  <br>    initIs = url != <span class="hljs-literal">null</span> ? url.openStream() : <span class="hljs-literal">null</span>;  <br>  &#125; <span class="hljs-keyword">else</span> &#123;  <br>    initIs = mcl.getResourceAsStream(filename);  <br>  &#125;  <br>  <span class="hljs-keyword">if</span> (initIs == <span class="hljs-literal">null</span>) &#123;  <br>    Log.e(TAG, <span class="hljs-string">&quot;  Failed to load module &quot;</span> + modulePath);  <br>    Log.e(TAG, <span class="hljs-string">&quot;  assets/xposed_init not found in the module APK&quot;</span>);  <br>    <span class="hljs-keyword">return</span>;  <br>  &#125;  <br>&#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;  <br>  Log.e(TAG, <span class="hljs-string">&quot;  Failed to load module &quot;</span> + modulePath);  <br>  Log.e(TAG, <span class="hljs-string">&quot;  Cannot open assets/xposed_init in the module APK&quot;</span>, e);  <br>  <span class="hljs-keyword">return</span>;  <br>&#125;<br>  <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">xposedInitReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(initIs));<br></code></pre></td></tr></table></figure>

<p>然后从资源里读取代码然后加载：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Class&lt;?&gt; c = mcl.loadClass(className);<br></code></pre></td></tr></table></figure>

<p>然后下面有一个初始化 Xposed 的操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">((IXposedHookZygoteInit) callback).initZygote(param);<br></code></pre></td></tr></table></figure>

<p>起初还以为是要注入 Zygote ，但是没有 root 也不能注入才对，翻了下源代码似乎是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs java">   <span class="hljs-meta">@Override</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initZygote</span><span class="hljs-params">(StartupParam startupParam)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>       hookXposedFrameworkApi(startupParam);<br>   &#125;<br><br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 用于分析第三方 XP 模块采用了哪些钩子，主要用于模块包体比较大，</span><br><span class="hljs-comment">    * 做了加固或者混淆做得比较彻底的场景</span><br><span class="hljs-comment">    * &lt;p&gt;</span><br><span class="hljs-comment">    * 钩子的目标类和方法名，可在 Xposed Installer 的日志中查看</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hookXposedFrameworkApi</span><span class="hljs-params">(StartupParam param)</span> &#123;<br>       hookXpFindAndHookMethod();<br>       hookXpFindAndHookConstructor();<br>       hookXpHookAllMethods();<br>       hookXpHookAllConstructors();<br>    &#125;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hookXpFindAndHookMethod</span><span class="hljs-params">()</span> &#123;  <br>  <span class="hljs-keyword">try</span> &#123;  <br>    <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> XposedHelpers.findClass(  <br>            <span class="hljs-string">&quot;de.robv.android.xposed.XposedHelpers&quot;</span>,  <br>            HookUtils.class.getClassLoader());  <br>    XposedHelpers.findAndHookMethod(cls, <span class="hljs-string">&quot;findAndHookMethod&quot;</span>,  <br>            Class.class, String.class, Object[].class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">XC_MethodHook</span>() &#123;  <br>              <span class="hljs-meta">@Override</span>  <br>              <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable &#123;  <br>                <span class="hljs-built_in">super</span>.beforeHookedMethod(param);  <br>                XposedBridge.log(<span class="hljs-string">&quot;findAndHookMethod: cls = &quot;</span> + param.args[<span class="hljs-number">0</span>]  <br>                        + <span class="hljs-string">&quot;, method = &quot;</span> + param.args[<span class="hljs-number">1</span>]);  <br>              &#125;  <br>            &#125;);  <br>  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;  <br>    XposedBridge.log(e);  <br>  &#125;  <br>&#125;  <br>  <br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hookXpFindAndHookConstructor</span><span class="hljs-params">()</span> &#123;  <br>  <span class="hljs-keyword">try</span> &#123;  <br>    <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> XposedHelpers.findClass(  <br>            <span class="hljs-string">&quot;de.robv.android.xposed.XposedHelpers&quot;</span>,  <br>            HookUtils.class.getClassLoader());  <br>    XposedHelpers.findAndHookMethod(cls, <span class="hljs-string">&quot;findAndHookConstructor&quot;</span>,  <br>            Class.class, Object[].class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">XC_MethodHook</span>() &#123;  <br>              <span class="hljs-meta">@Override</span>  <br>              <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable &#123;  <br>                <span class="hljs-built_in">super</span>.beforeHookedMethod(param);  <br>                XposedBridge.log(<span class="hljs-string">&quot;findAndHookConstructor: cls = &quot;</span> + param.args[<span class="hljs-number">0</span>]);  <br>              &#125;  <br>            &#125;);  <br>  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;  <br>    XposedBridge.log(e);  <br>  &#125;  <br>&#125;  <br>  <br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hookXpHookAllMethods</span><span class="hljs-params">()</span> &#123;  <br>  <span class="hljs-keyword">try</span> &#123;  <br>    <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> XposedHelpers.findClass(  <br>            <span class="hljs-string">&quot;de.robv.android.xposed.XposedBridge&quot;</span>,  <br>            HookUtils.class.getClassLoader());  <br>    <span class="hljs-type">Class</span> <span class="hljs-variable">clsXC_MethodHook</span> <span class="hljs-operator">=</span> XposedHelpers.findClass(  <br>            <span class="hljs-string">&quot;de.robv.android.xposed.XC_MethodHook&quot;</span>, HookUtils.class.getClassLoader()  <br>    );  <br>    XposedHelpers.findAndHookMethod(cls, <span class="hljs-string">&quot;hookAllMethods&quot;</span>,  <br>            Class.class, String.class, clsXC_MethodHook, <span class="hljs-keyword">new</span> <span class="hljs-title class_">XC_MethodHook</span>() &#123;  <br>              <span class="hljs-meta">@Override</span>  <br>              <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable &#123;  <br>                <span class="hljs-built_in">super</span>.beforeHookedMethod(param);  <br>                XposedBridge.log(<span class="hljs-string">&quot;hookAllMethods: cls = &quot;</span> + param.args[<span class="hljs-number">0</span>]  <br>                        + <span class="hljs-string">&quot;, method = &quot;</span> + param.args[<span class="hljs-number">1</span>]);  <br>              &#125;  <br>            &#125;);  <br>  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;  <br>    XposedBridge.log(e);  <br>  &#125;  <br>&#125;  <br>  <br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hookXpHookAllConstructors</span><span class="hljs-params">()</span> &#123;  <br>  <span class="hljs-keyword">try</span> &#123;  <br>    <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> XposedHelpers.findClass(  <br>            <span class="hljs-string">&quot;de.robv.android.xposed.XposedBridge&quot;</span>,  <br>            HookUtils.class.getClassLoader());  <br>    <span class="hljs-type">Class</span> <span class="hljs-variable">clsXC_MethodHook</span> <span class="hljs-operator">=</span> XposedHelpers.findClass(  <br>            <span class="hljs-string">&quot;de.robv.android.xposed.XC_MethodHook&quot;</span>, HookUtils.class.getClassLoader()  <br>    );  <br>    XposedHelpers.findAndHookMethod(cls, <span class="hljs-string">&quot;hookAllConstructors&quot;</span>,  <br>            Class.class, clsXC_MethodHook, <span class="hljs-keyword">new</span> <span class="hljs-title class_">XC_MethodHook</span>() &#123;  <br>              <span class="hljs-meta">@Override</span>  <br>              <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable &#123;  <br>                <span class="hljs-built_in">super</span>.beforeHookedMethod(param);  <br>                XposedBridge.log(<span class="hljs-string">&quot;hookAllConstructors: cls = &quot;</span> + param.args[<span class="hljs-number">0</span>]);  <br>              &#125;  <br>            &#125;);  <br>  &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;  <br>    XposedBridge.log(e);  <br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>看起来似乎不是注入 Zygote ，只是对其中的一些方法做了 Hook，既然如此就不需要真的去注入 Zygote 了，只需要在加载应用时把调一下这个方法把它们拦截下来就行了。</p>
<p>完成 Hook 以后再加载对应模块：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">hookLoadPackage((IXposedHookLoadPackage) callback);<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hookLoadPackage</span><span class="hljs-params">(IXposedHookLoadPackage callback)</span> &#123;  <br>  sLoadedPackageCallbacks.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">XC_LoadPackage</span>.Wrapper(callback));  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个 <code>sLoadedPackageCallbacks</code> 只是暂存。在对每个模块做完上述操作以后，下面还有一段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;  <br>  PineXposed.onPackageLoad(  <br>      vPackageName,  <br>      vProcessName,  <br>      context.getApplicationInfo(),  <br>      isFirstApplication,  <br>      context.getClassLoader());  <br>&#125; <span class="hljs-keyword">catch</span> (Throwable ignored) &#123;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>往下跟一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPackageLoad</span><span class="hljs-params">(  </span><br><span class="hljs-params">    String packageName,  </span><br><span class="hljs-params">    String processName,  </span><br><span class="hljs-params">    ApplicationInfo appInfo,  </span><br><span class="hljs-params">    <span class="hljs-type">boolean</span> isFirstApp,  </span><br><span class="hljs-params">    ClassLoader classLoader)</span> &#123;  <br>  XC_LoadPackage.<span class="hljs-type">LoadPackageParam</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span>  <br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">XC_LoadPackage</span>.LoadPackageParam(sLoadedPackageCallbacks);  <br>  param.packageName = packageName;  <br>  param.processName = processName;  <br>  param.appInfo = appInfo;  <br>  param.isFirstApplication = isFirstApp;  <br>  param.classLoader = classLoader;  <br>  XC_LoadPackage.callAll(param);  <br>&#125;<br><br><span class="hljs-comment">/** <span class="hljs-doctag">@hide</span> */</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">callAll</span><span class="hljs-params">(Param param)</span> &#123;  <br>  <span class="hljs-keyword">if</span> (param.callbacks == <span class="hljs-literal">null</span>)  <br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;This object was not created for use with callAll&quot;</span>);  <br>  <br>  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; param.callbacks.length; i++) &#123;  <br>    <span class="hljs-keyword">try</span> &#123;  <br>      ((XCallback) param.callbacks[i]).call(param);  <br>    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;  <br>      XposedBridge.log(t);  <br>    &#125;  <br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里最后会去调用 <code>XC_LoadPackage</code> 下的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/** <span class="hljs-doctag">@hide</span> */</span>  <br><span class="hljs-meta">@Override</span>  <br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">call</span><span class="hljs-params">(Param param)</span> <span class="hljs-keyword">throws</span> Throwable &#123;  <br>  <span class="hljs-keyword">if</span> (param <span class="hljs-keyword">instanceof</span> LoadPackageParam) handleLoadPackage((LoadPackageParam) param);  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>最后这个 <code>handleLoadPackage</code> 方法就会调用到模块里那个重载后的 <code>handleLoadPackage</code> 来实现模块功能的加载了。</p>
<p>不过这里有一点很奇怪的是，为什么需要每个模块都调用一遍 <code>initZygote</code> 呢？岂不是在重复 Hook 那些方法么？看起来似乎每次都把模块信息传进去了，但是好像没有用到这个信息，那又为什么需要每次都调用一遍呢？</p>
<p>没想明白，如果有大佬知道的话还请多多指教。</p>
<h1 id="重定向-Hook-总结和疑问"><a href="#重定向-Hook-总结和疑问" class="headerlink" title="重定向 Hook 总结和疑问"></a>重定向 Hook 总结和疑问</h1><p>在最后一部分我们可以看到，如果通过 Seccomp 对 open 等系统调用做拦截的话，应该上层的很多重定向都可以放掉了？毕竟不管上层用了什么函数，底层对文件的访问都是需要系统调用去支持的，从这个层面说，只要在系统调用层面把路径全部做好过滤，是不是上层的重定向可以直接删掉？</p>
<p>不过 Seccomp 这一策略首先支持的版本比较新，老设备肯定是没有的，以及另一方面是，检测 Seccomp 是不是较为简单呢？笔者目前对这些问题尚没有答案，还需要请教各位大佬。</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a target="_blank" rel="noopener" href="https://blog.canyie.top/2020/04/27/dynamic-hooking-framework-on-art/">https://blog.canyie.top/2020/04/27/dynamic-hooking-framework-on-art/</a><br><a target="_blank" rel="noopener" href="https://wufengxue.github.io/2019/11/01/get-3rd-xp-module-hookers.html">https://wufengxue.github.io/2019/11/01/get-3rd-xp-module-hookers.html</a><br><a target="_blank" rel="noopener" href="https://blog.canyie.top/2020/02/03/a-new-xposed-style-framework/">https://blog.canyie.top/2020/02/03/a-new-xposed-style-framework/</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages" style="justify-content: flex-end"><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2025/05/24/VirtualApp%E5%8E%9F%E7%90%86%E9%80%9F%E8%A7%88%20-%20Broadcast%20Receiver%20%E5%AE%B9%E5%99%A8%E5%86%85%E5%AE%9E%E7%8E%B0/">VirtualApp原理速览 - Broadcast Receiver 容器内实现 Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/6.png" alt="Logo"></a><h1 id="Dr"><a href="TokameinE">TokameinE</a></h1><div id="description"><p></p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/ErodedElk"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" target="_blank" rel="noopener" href="https://space.bilibili.com/1782544616"><i class="fa-brands fa-bilibili" alt="BiliBili"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B7%AF%E5%BE%84%E9%87%8D%E5%AE%9A%E5%90%91%E5%92%8C-Xposed-%E6%B3%A8%E5%85%A5%E6%97%B6%E6%9C%BA%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">路径重定向和 Xposed 注入时机分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F-Hook"><span class="toc-number">2.1.</span> <span class="toc-text">文件系统 Hook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ClassLoader-Hook"><span class="toc-number">2.2.</span> <span class="toc-text">ClassLoader Hook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Binder-Hook"><span class="toc-number">2.3.</span> <span class="toc-text">Binder Hook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#seccomp-Hook"><span class="toc-number">2.4.</span> <span class="toc-text">seccomp Hook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Xposed-%E6%94%AF%E6%8C%81"><span class="toc-number">2.5.</span> <span class="toc-text">Xposed 支持</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%87%8D%E5%AE%9A%E5%90%91-Hook-%E6%80%BB%E7%BB%93%E5%92%8C%E7%96%91%E9%97%AE"><span class="toc-number">3.</span> <span class="toc-text">重定向 Hook 总结和疑问</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">4.</span> <span class="toc-text">参考文章</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>