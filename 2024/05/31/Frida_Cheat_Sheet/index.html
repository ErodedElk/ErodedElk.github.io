<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Frida Cheat Sheet | TokameinE - 雨声淅淅沥沥，犬吠永不止息</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: Bender;
 src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
 font-family: BenderLight;
 src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/91110244_p0.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>Frida Cheat Sheet</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2024-05-31T03:20:03.000Z" id="date"> 2024-05-31</time></div></span><br><span>Last Update: <div class="control"><time datetime="2024-12-29T04:50:34.978Z" id="updated"> 2024-12-29</time></div></span></div></div><hr><div id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在动笔之前我其实还没想好该怎么写。比如这篇文章的内容是什么，我需要写到多详细，以及我所写作的目标是什么，读者读完后能收获什么，我全都没想好，在这么一种混沌的状态下，我开始动笔。</p>
<p>另外两个关于原理的文章：</p>
<blockquote>
<p>Frida-gum 源代码速通笔记: <a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-278423.htm">https://bbs.kanxue.com/thread-278423.htm</a><br>Frida-Core 源代码速通笔记: <a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-278533.htm">https://bbs.kanxue.com/thread-278533.htm</a></p>
</blockquote>
<p>本文主要还是关于使用，如果您对原理不感兴趣，只阅读本文即可。我希望它帮我实现的目的是，在我需要某个功能的时候能够直接通过本文的一些案例来完成。若未来有新的需求，希望能及时更新。</p>
<h1 id="Usage-Cheat-Sheet"><a href="#Usage-Cheat-Sheet" class="headerlink" title="Usage Cheat Sheet"></a>Usage Cheat Sheet</h1><p><strong>记录那些使用上的条目。</strong></p>
<h2 id="启动模式"><a href="#启动模式" class="headerlink" title="启动模式"></a>启动模式</h2><p><code>frida</code> 自带两种启动模式，分别是 <code>attach</code> 和 <code>spawn</code> 。前者是启动应用以后再接入 <code>frida</code> ，后者则是先启动 <code>frida</code> 再启动应用。二者各有不同的好处，比方说程序在启动时检查 <code>frida</code> 的话，则后来附加进去的 <code>frida</code> 是不会被发现的；而如果想要在程序启动时就钩取一些函数，则 <code>spawn</code> 模式能够在最早的时机生效。</p>
<p>通过 python 运行时的模板：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> frida<br><br><span class="hljs-comment"># 连接安卓机上的frida-server</span><br>device = frida.get_usb_device()<br><span class="hljs-comment"># 启动`demo02`这个app</span><br>pid = device.spawn([<span class="hljs-string">&quot;com.demo.demo02&quot;</span>])<br>device.resume(pid)<br>time.sleep(<span class="hljs-number">1</span>)<br>session = device.attach(pid)<br><span class="hljs-comment"># 加载s1.js脚本</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;s1.js&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    script = session.create_script(f.read())<br>script.load()<br><br><span class="hljs-comment"># 脚本会持续运行等待输入</span><br>raw_input()<br></code></pre></td></tr></table></figure>

<p>注意这里的 <code>device.resume</code> 函数，通过 <code>spawn</code> 启动的程序会在启动后立即暂停，而该函数则会恢复程序的执行。</p>
<p>如果我们希望以 attach 的方式进行连接，那么在脚本调用 <code>device.spawn</code> 函数后立即使用 <code>device.resume</code> 即可实现相同的操作；而如果我们希望以 spawn 模式进行工作，那么在 <code>device.spawn</code> 函数后则需要先完成 <code>script.load</code> ，然后再调用 <code>device.resume</code>。</p>
<h2 id="Windows-Platform"><a href="#Windows-Platform" class="headerlink" title="Windows Platform"></a>Windows Platform</h2><p><code>frida</code> 在 Windows 平台下也能用来钩一些 PE 文件，装好环境以后能直接这样用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">import</span> string<br>string.printable<br><span class="hljs-keyword">from</span> colorama <span class="hljs-keyword">import</span> init<br>init(autoreset=<span class="hljs-literal">True</span>)<br><span class="hljs-keyword">import</span> frida, sys     <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">on_message</span>(<span class="hljs-params">message, data</span>):<br>    <span class="hljs-keyword">global</span> new_number<br>    <span class="hljs-built_in">print</span>(message)<br>    <span class="hljs-keyword">if</span> message[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;send&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] &#123;0&#125;&quot;</span>.<span class="hljs-built_in">format</span>(message[<span class="hljs-string">&#x27;payload&#x27;</span>]))<br>        new_number = message[<span class="hljs-string">&#x27;payload&#x27;</span>]<br>    <span class="hljs-keyword">elif</span> message[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&quot;error&quot;</span>:<br>        <span class="hljs-built_in">print</span>(message[<span class="hljs-string">&quot;description&quot;</span>])<br>        <span class="hljs-built_in">print</span>(message[<span class="hljs-string">&quot;stack&quot;</span>])<br>        <span class="hljs-built_in">print</span>(message[<span class="hljs-string">&quot;fileName&quot;</span>],<span class="hljs-string">&quot;line:&quot;</span>,message[<span class="hljs-string">&quot;lineNumber&quot;</span>],<span class="hljs-string">&quot;colum:&quot;</span>,message[<span class="hljs-string">&quot;columnNumber&quot;</span>])<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(message)<br><br>jscode = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;test.js&quot;</span>,<span class="hljs-string">&quot;rb&quot;</span>).read().decode()<br>process = subprocess.Popen(<span class="hljs-string">&quot;demo.exe&quot;</span>,<br>                                stdin=subprocess.PIPE,<br>                                stdout=subprocess.PIPE,<br>                                stderr=subprocess.PIPE,bufsize=<span class="hljs-number">0</span><br>                                )<br>session = frida.attach(<span class="hljs-string">&quot;demo.exe&quot;</span>)<br>script = session.create_script(jscode)<br>script.on(<span class="hljs-string">&#x27;message&#x27;</span>, on_message)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] Start attach&#x27;</span>)<br>script.load()<br>process.stdin.write(<span class="hljs-string">&quot;data&quot;</span>)<br>output, error = process.communicate()<br><span class="hljs-built_in">print</span>(output)<br>process.terminate()<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> number=<span class="hljs-number">0</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>)<br>&#123;<br>    <span class="hljs-keyword">var</span> base =  <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findBaseAddress</span>(<span class="hljs-string">&quot;demo.exe&quot;</span>)<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(base)<br>    <span class="hljs-keyword">if</span>(base)&#123;<br>        <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(base.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x11F4C</span>), &#123;<br>            <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) &#123;<br>                <span class="hljs-keyword">if</span> (res==<span class="hljs-number">1</span>)<br>                &#123;<br>                    number+=<span class="hljs-number">1</span>;<br>                &#125;<br>                <span class="hljs-keyword">else</span>&#123;<br>                    <span class="hljs-title function_">send</span>(number);<br>                &#125;<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br><span class="hljs-title function_">setImmediate</span>(main);<br></code></pre></td></tr></table></figure>

<h2 id="Command-Line"><a href="#Command-Line" class="headerlink" title="Command Line"></a>Command Line</h2><p>利用 <code>frida-trace</code> 跟踪两个函数，同时以 spawn 模式启动该程序：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">frida-trace -U -i open -i strcmp -f com.android.chrome<br></code></pre></td></tr></table></figure>

<p>跟踪所有 <code>libcommonCrypto</code> 下的函数，这里是通配符：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">frida-trace -U -I <span class="hljs-string">&quot;libcommonCrypto*&quot;</span> -f com.toyopagroup.picaboo<br></code></pre></td></tr></table></figure>

<p>在 IOS 平台下用这样跟踪 OBJC 函数：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">frida-trace -U -m <span class="hljs-string">&quot;-[NSView drawRect:]&quot;</span> -f target<br></code></pre></td></tr></table></figure>

<p>跟踪类BitmapFactory中方法名中包含 native 的所有Java方法：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">frida-trace -U -j <span class="hljs-string">&#x27;*BitmapFactory*!*native*&#x27;</span> com.android.chrome<br></code></pre></td></tr></table></figure>

<blockquote>
<p>提一句：frida-trace 的原理实际上是会<strong>根据参数在当前目录下生成对应的 JavaScript 脚本</strong>，然后再用 frida 加载这份脚本实现跟踪。所以我们实际上可以先用这个方法把目标钩出来，然后魔改生成的脚本就能比较方便的实现自定义功能了。</p>
</blockquote>
<p>如果需要启用内置的 <strong>V8 引擎</strong>，也能通过这个参数启用：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">frida -U -f com.apple.calculator --runtime=v8 -l agent.js<br></code></pre></td></tr></table></figure>

<blockquote>
<p>但请注意，V8 引擎并不总是有效的，在某些平台的某些版本下，启用后会导致无法正常 hook</p>
</blockquote>
<p>如果我们希望在命令行模式下以启动命令的方式，却使用类似 attach 的办法，通过添加 <code>--no-pause</code> 参数可以避免程序在启动后被中断：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">frida -U --no-pause -l hookNative.js -f com.example.app<br></code></pre></td></tr></table></figure>
<h2 id="Remote-Frida-Server"><a href="#Remote-Frida-Server" class="headerlink" title="Remote Frida Server"></a>Remote Frida Server</h2><p>在一些使用网络进行通信的场景下，利用 frida-server 可以创建远程的调试环境：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">frida-server -l 0.0.0.0<br></code></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">frida-trace -H 192.168.1.3 -i <span class="hljs-string">&quot;open*&quot;</span><br></code></pre></td></tr></table></figure>



<h1 id="Code-Cheat-Sheet"><a href="#Code-Cheat-Sheet" class="headerlink" title="Code Cheat Sheet"></a>Code Cheat Sheet</h1><p><strong>记录那些代码的条目。</strong></p>
<h2 id="Script-Function"><a href="#Script-Function" class="headerlink" title="Script Function"></a>Script Function</h2><p>我们有这些函数可供使用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> inspect<br><span class="hljs-keyword">import</span> frida<br><span class="hljs-keyword">for</span> mb <span class="hljs-keyword">in</span> inspect.getmembers(frida, inspect.isfunction):<br>  <span class="hljs-built_in">print</span>(mb)<br><br>(<span class="hljs-string">&#x27;attach&#x27;</span>, &lt;function attach at <span class="hljs-number">0x000002A27AAC9318</span>&gt;)<br>(<span class="hljs-string">&#x27;enumerate_devices&#x27;</span>, &lt;function enumerate_devices at <span class="hljs-number">0x000002A27AAFAF78</span>&gt;)<br>(<span class="hljs-string">&#x27;get_device&#x27;</span>, &lt;function get_device at <span class="hljs-number">0x000002A27AAF64C8</span>&gt;)<br>(<span class="hljs-string">&#x27;get_device_manager&#x27;</span>, &lt;function get_device_manager at <span class="hljs-number">0x000002A27AA9D4C8</span>&gt;)<br>(<span class="hljs-string">&#x27;get_device_matching&#x27;</span>, &lt;function get_device_matching at <span class="hljs-number">0x000002A27AAF63A8</span>&gt;)<br>(<span class="hljs-string">&#x27;get_local_device&#x27;</span>, &lt;function get_local_device at <span class="hljs-number">0x000002A27AAE8F78</span>&gt;)<br>(<span class="hljs-string">&#x27;get_remote_device&#x27;</span>, &lt;function get_remote_device at <span class="hljs-number">0x000002A27AAE81F8</span>&gt;)<br>(<span class="hljs-string">&#x27;get_usb_device&#x27;</span>, &lt;function get_usb_device at <span class="hljs-number">0x000002A27AAF6558</span>&gt;)<br>(<span class="hljs-string">&#x27;inject_library_blob&#x27;</span>, &lt;function inject_library_blob at <span class="hljs-number">0x000002A27AA9A558</span>&gt;)<br>(<span class="hljs-string">&#x27;inject_library_file&#x27;</span>, &lt;function inject_library_file at <span class="hljs-number">0x000002A27AAD8EE8</span>&gt;)<br>(<span class="hljs-string">&#x27;kill&#x27;</span>, &lt;function kill at <span class="hljs-number">0x000002A27AAAE558</span>&gt;)<br>(<span class="hljs-string">&#x27;query_system_parameters&#x27;</span>, &lt;function query_system_parameters at <span class="hljs-number">0x000002A27A894048</span>&gt;)<br>(<span class="hljs-string">&#x27;resume&#x27;</span>, &lt;function resume at <span class="hljs-number">0x000002A27AAAE048</span>&gt;)<br>(<span class="hljs-string">&#x27;shutdown&#x27;</span>, &lt;function shutdown at <span class="hljs-number">0x000002A27AAE2168</span>&gt;)<br>(<span class="hljs-string">&#x27;spawn&#x27;</span>, &lt;function spawn at <span class="hljs-number">0x000002A27AAA1318</span>&gt;)<br></code></pre></td></tr></table></figure>

<p>在下面的代码中可能会涉及到这些函数的使用。</p>
<h2 id="Python-Template"><a href="#Python-Template" class="headerlink" title="Python Template"></a>Python Template</h2><p>一个简单的 Frida-Python 交互模板，通过 spawn 模式启动：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Early instrumentation</span><br><span class="hljs-keyword">import</span> frida, sys, time<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">on_message</span>(<span class="hljs-params">message, data</span>):<br>    <span class="hljs-keyword">if</span> message[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;send&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] &#123;0&#125;&quot;</span>.<span class="hljs-built_in">format</span>(message[<span class="hljs-string">&#x27;payload&#x27;</span>]))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(message)<br><br>js = <span class="hljs-string">&quot;&quot;&quot;js code here&quot;&quot;&quot;</span><br><br>device = frida.get_usb_device()<br>pid = device.spawn([<span class="hljs-string">&quot;com.example.app&quot;</span>])<br>session = device.attach(pid)<br>script = session.create_script(js)<br>script.on(<span class="hljs-string">&#x27;message&#x27;</span>, on_message)<br>script.load()<br>device.resume(pid)<br>sys.stdin.read()<br></code></pre></td></tr></table></figure>

<p>或是通过附加的方式接入：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Normal start - app needs to be opened</span><br><span class="hljs-keyword">import</span> frida, sys<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">on_message</span>(<span class="hljs-params">message, data</span>):<br>    <span class="hljs-keyword">if</span> message[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;send&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] &#123;0&#125;&quot;</span>.<span class="hljs-built_in">format</span>(message[<span class="hljs-string">&#x27;payload&#x27;</span>]))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(message)<br><br>js = <span class="hljs-string">&quot;&quot;&quot;js code here&quot;&quot;&quot;</span><br><br>process = frida.get_usb_device().attach(<span class="hljs-string">&#x27;com.example.app&#x27;</span>)<br>script = process.create_script(js)<br>script.on(<span class="hljs-string">&#x27;message&#x27;</span>, on_message)<br>script.load()<br>sys.stdin.read()<br></code></pre></td></tr></table></figure>


<h2 id="JavaScript-Template"><a href="#JavaScript-Template" class="headerlink" title="JavaScript Template"></a>JavaScript Template</h2><p>记录那些常用的 JavaScript 脚本，希望我们不再需要反复的手写了。</p>
<h3 id="替换函数实现"><a href="#替换函数实现" class="headerlink" title="替换函数实现"></a>替换函数实现</h3><p>通过 <code>Java.use</code> 找到特定的类，然后使用 <code>class.function_name.implementation</code> 能够获取到其实现，如果修改改变量则会替换该函数；而在其中调用 <code>this</code> 可以访问原本的函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Script loaded successfully &quot;</span>);<br><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">x</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Inside java perform function&quot;</span>);<br>    <span class="hljs-comment">//定位类</span><br>    <span class="hljs-keyword">var</span> my_class = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.demo.MainActivity&quot;</span>);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Java.Use.Successfully!&quot;</span>);<span class="hljs-comment">//定位类成功！</span><br>    <span class="hljs-comment">//在这里更改类的方法的实现（implementation）</span><br>    my_class.<span class="hljs-property">fun</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">x,y</span>)&#123;<br>        <span class="hljs-comment">//打印替换前的参数</span><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>( <span class="hljs-string">&quot;original call: fun(&quot;</span>+ x + <span class="hljs-string">&quot;, &quot;</span> + y + <span class="hljs-string">&quot;)&quot;</span>);<br>        <span class="hljs-comment">//把参数替换成2和5，依旧调用原函数</span><br>        <span class="hljs-keyword">var</span> ret_value = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fun</span>(<span class="hljs-number">2</span>, <span class="hljs-number">5</span>);<br>        <span class="hljs-keyword">return</span> ret_value;<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure>

<h3 id="获取类及其下的方法"><a href="#获取类及其下的方法" class="headerlink" title="获取类及其下的方法"></a>获取类及其下的方法</h3><p>或许可以通过这样的方法来获得一个类和它对应的方法，在这个用例里我们打印了 <code>MainActivity</code> 下的所有方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> main = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.example.app.MainActivity&quot;</span>);<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">inspectClass</span>(<span class="hljs-params">obj</span>) &#123;<br>    <span class="hljs-keyword">const</span> obj_class = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">cast</span>(obj.<span class="hljs-title function_">getClass</span>(), <span class="hljs-title class_">Class</span>);<br>    <span class="hljs-keyword">const</span> fields = obj_class.<span class="hljs-title function_">getDeclaredFields</span>();<br>    <span class="hljs-keyword">const</span> methods = obj_class.<span class="hljs-title function_">getMethods</span>();<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Inspect &quot;</span> + obj.<span class="hljs-title function_">getClass</span>().<span class="hljs-title function_">toString</span>());<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\tFields:&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> fields)<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\t&quot;</span> + fields[i].<span class="hljs-title function_">toString</span>());<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\tMethods:&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> methods)<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\t&quot;</span> + methods[i].<span class="hljs-title function_">toString</span>());<br>&#125;<br><span class="hljs-title function_">inspectClass</span>(main)<br></code></pre></td></tr></table></figure>

<h3 id="获取类及其下的-native-方法"><a href="#获取类及其下的-native-方法" class="headerlink" title="获取类及其下的 native 方法"></a>获取类及其下的 native 方法</h3><p>在这篇问答中提到：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/51811348/find-manually-registered-obfuscated-native-function-address">Find manually registered (obfuscated) native function address</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> <span class="hljs-title class_">RevealNativeMethods</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">var</span> pSize = <span class="hljs-title class_">Process</span>.<span class="hljs-property">pointerSize</span>;<br>  <span class="hljs-keyword">var</span> env = <span class="hljs-title class_">Java</span>.<span class="hljs-property">vm</span>.<span class="hljs-title function_">getEnv</span>();<br>  <span class="hljs-keyword">var</span> <span class="hljs-title class_">RegisterNatives</span> = <span class="hljs-number">215</span>, <span class="hljs-title class_">FindClassIndex</span> = <span class="hljs-number">6</span>; <span class="hljs-comment">// search &quot;215&quot; @ https://docs.oracle.com/javase/8/docs/technotes/guides/jni/spec/functions.html</span><br>  <span class="hljs-keyword">var</span> jclassAddress2NameMap = &#123;&#125;;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getNativeAddress</span>(<span class="hljs-params">idx</span>) &#123;<br>    <span class="hljs-keyword">return</span> env.<span class="hljs-property">handle</span>.<span class="hljs-title function_">readPointer</span>().<span class="hljs-title function_">add</span>(idx * pSize).<span class="hljs-title function_">readPointer</span>();<br>  &#125;<br>  <span class="hljs-comment">// intercepting FindClass to populate Map&lt;address, jclass&gt;</span><br>  <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(<span class="hljs-title function_">getNativeAddress</span>(<span class="hljs-title class_">FindClassIndex</span>), &#123;<br>    <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) &#123;<br>      jclassAddress2NameMap[args[<span class="hljs-number">0</span>]] = args[<span class="hljs-number">1</span>].<span class="hljs-title function_">readCString</span>();<br>    &#125;<br>  &#125;);<br>  <span class="hljs-comment">// RegisterNative(jClass*, .., JNINativeMethod *methods[nMethods], uint nMethods) // https://android.googlesource.com/platform/libnativehelper/+/master/include_jni/jni.h#977</span><br>  <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(<span class="hljs-title function_">getNativeAddress</span>(<span class="hljs-title class_">RegisterNatives</span>), &#123;<br>    <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) &#123;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, nMethods = <span class="hljs-built_in">parseInt</span>(args[<span class="hljs-number">3</span>]); i &lt; nMethods; i++) &#123;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">          https://android.googlesource.com/platform/libnativehelper/+/master/include_jni/jni.h#129</span><br><span class="hljs-comment">          typedef struct &#123;</span><br><span class="hljs-comment">             const char* name;</span><br><span class="hljs-comment">             const char* signature;</span><br><span class="hljs-comment">             void* fnPtr;</span><br><span class="hljs-comment">          &#125; JNINativeMethod;</span><br><span class="hljs-comment">        */</span><br>        <span class="hljs-keyword">var</span> structSize = pSize * <span class="hljs-number">3</span>; <span class="hljs-comment">// = sizeof(JNINativeMethod)</span><br>        <span class="hljs-keyword">var</span> methodsPtr = <span class="hljs-title function_">ptr</span>(args[<span class="hljs-number">2</span>]);<br>        <span class="hljs-keyword">var</span> signature = methodsPtr.<span class="hljs-title function_">add</span>(i * structSize + pSize).<span class="hljs-title function_">readPointer</span>();<br>        <span class="hljs-keyword">var</span> fnPtr = methodsPtr.<span class="hljs-title function_">add</span>(i * structSize + (pSize * <span class="hljs-number">2</span>)).<span class="hljs-title function_">readPointer</span>(); <span class="hljs-comment">// void* fnPtr</span><br>        <span class="hljs-keyword">var</span> jClass = jclassAddress2NameMap[args[<span class="hljs-number">0</span>]].<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;/&#x27;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;\x1b[3&#x27;</span> + <span class="hljs-string">&#x27;6;01&#x27;</span> + <span class="hljs-string">&#x27;m&#x27;</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(&#123;<br>          <span class="hljs-attr">module</span>: <span class="hljs-title class_">DebugSymbol</span>.<span class="hljs-title function_">fromAddress</span>(fnPtr)[<span class="hljs-string">&#x27;moduleName&#x27;</span>], <span class="hljs-comment">// https://www.frida.re/docs/javascript-api/#debugsymbol</span><br>          <span class="hljs-attr">package</span>: jClass.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;.&#x27;</span>),<br>          <span class="hljs-attr">class</span>: jClass[jClass.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>],<br>          <span class="hljs-attr">method</span>: methodsPtr.<span class="hljs-title function_">readPointer</span>().<span class="hljs-title function_">readCString</span>(), <span class="hljs-comment">// char* name</span><br>          <span class="hljs-attr">signature</span>: signature.<span class="hljs-title function_">readCString</span>(), <span class="hljs-comment">// char* signature TODO Java bytecode signature parser &#123; Z: &#x27;boolean&#x27;, B: &#x27;byte&#x27;, C: &#x27;char&#x27;, S: &#x27;short&#x27;, I: &#x27;int&#x27;, J: &#x27;long&#x27;, F: &#x27;float&#x27;, D: &#x27;double&#x27;, L: &#x27;fully-qualified-class;&#x27;, &#x27;[&#x27;: &#x27;array&#x27; &#125; https://github.com/skylot/jadx/blob/master/jadx-core/src/main/java/jadx/core/dex/nodes/parser/SignatureParser.java</span><br>          <span class="hljs-attr">address</span>: fnPtr<br>        &#125;), <span class="hljs-string">&#x27;\x1b[39;49;00m&#x27;</span>);<br>      &#125;<br>    &#125;<br>  &#125;);<br>&#125;<br><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-title class_">RevealNativeMethods</span>);<br></code></pre></td></tr></table></figure>

<h3 id="对特定动态库进行-hook"><a href="#对特定动态库进行-hook" class="headerlink" title="对特定动态库进行 hook"></a>对特定动态库进行 hook</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> sign2 = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;libhello-jni.so&quot;</span>, <span class="hljs-string">&quot;Java_com_example_hellojni_HelloJni_sign2&quot;</span>);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sign2);<br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(sign2, &#123;<br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) &#123;<br>            <span class="hljs-comment">//jstring</span><br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;sign2 str1:&quot;</span>, <span class="hljs-title function_">ptr</span>(<span class="hljs-title class_">Java</span>.<span class="hljs-property">vm</span>.<span class="hljs-title function_">tryGetEnv</span>().<span class="hljs-title function_">getStringUtfChars</span>(args[<span class="hljs-number">2</span>])).<span class="hljs-title function_">readCString</span>());<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;sign2 str2:&quot;</span>, <span class="hljs-title function_">ptr</span>(<span class="hljs-title class_">Java</span>.<span class="hljs-property">vm</span>.<span class="hljs-title function_">tryGetEnv</span>().<span class="hljs-title function_">getStringUtfChars</span>(args[<span class="hljs-number">3</span>])).<span class="hljs-title function_">readCString</span>());<br>        &#125;, <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;sign2 retval:&quot;</span>, <span class="hljs-title function_">ptr</span>(<span class="hljs-title class_">Java</span>.<span class="hljs-property">vm</span>.<span class="hljs-title function_">tryGetEnv</span>().<span class="hljs-title function_">getStringUtfChars</span>(retval)).<span class="hljs-title function_">readCString</span>());<br>        &#125;<br>    &#125;);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Module</span>.<span class="hljs-title function_">enumerateExports</span>(<span class="hljs-string">&quot;mylib.so&quot;</span>, &#123;<br>    <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) &#123;<br>        <span class="hljs-keyword">if</span> (e.<span class="hljs-property">type</span> == <span class="hljs-string">&#x27;function&#x27;</span>) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;name of function = &quot;</span> + e.<span class="hljs-property">name</span>);<br>            <span class="hljs-keyword">if</span> (e.<span class="hljs-property">name</span> == <span class="hljs-string">&quot;Java_example_decrypt&quot;</span>) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Function Decrypt recognized by name&quot;</span>);<br>                <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(e.<span class="hljs-property">address</span>, &#123;<br>                    <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) &#123;<br>                        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Interceptor attached onEnter...&quot;</span>);<br>                    &#125;,<br>                    <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>) &#123;<br>                        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Interceptor attached onLeave...&quot;</span>);<br>                    &#125;<br>                &#125;);<br>            &#125;<br>        &#125;<br>    &#125;,<br>    <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;&#125;<br>&#125;);<br></code></pre></td></tr></table></figure>

<blockquote>
<p>请注意，这个方法并不总是有效，尤其是当我们需要以 spawn 的方式启动应用时，这个脚本会由于目标还尚未被加载导致无效。</p>
</blockquote>
<h3 id="修改-native-函数返回值"><a href="#修改-native-函数返回值" class="headerlink" title="修改 native 函数返回值"></a>修改 native 函数返回值</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(<span class="hljs-title class_">Module</span>.<span class="hljs-title function_">getExportByName</span>(<span class="hljs-string">&#x27;libnative-lib.so&#x27;</span>, <span class="hljs-string">&#x27;Jniint&#x27;</span>), &#123;<br>    <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">first</span> = args[<span class="hljs-number">0</span>].<span class="hljs-title function_">toInt32</span>(); <span class="hljs-comment">// int</span><br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;on enter with: &quot;</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">first</span>)<br>    &#125;,<br>    <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>) &#123;<br>      <span class="hljs-keyword">const</span> dstAddr = <span class="hljs-title class_">Java</span>.<span class="hljs-property">vm</span>.<span class="hljs-title function_">getEnv</span>().<span class="hljs-title function_">newIntArray</span>(<span class="hljs-number">1117878</span>);<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;dstAddr is : &quot;</span> + dstAddr.<span class="hljs-title function_">toInt32</span>())<br>      retval.<span class="hljs-title function_">replace</span>(dstAddr);<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure>

<blockquote>
<p>如果 <code>getExportByName</code> 的第一个参数为 null，那么 frida 将会查找所有动态库</p>
</blockquote>
<h3 id="dlopen-hook"><a href="#dlopen-hook" class="headerlink" title="dlopen hook"></a>dlopen hook</h3><p><code>dlopen</code> 往往被用于加载动态库，那么如果对这个函数进行 hook，那么就能解决前文所说的 “在加载动态库后再对其进行 hook” 的操作了。</p>
<p>主动加载：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> dlopen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeFunction</span>(<span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">&#x27;dlopen&#x27;</span>), <span class="hljs-string">&#x27;pointer&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]);<br><span class="hljs-keyword">const</span> dlerror = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeFunction</span>(<span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">&#x27;dlerror&#x27;</span>), <span class="hljs-string">&#x27;pointer&#x27;</span>, []);<br><span class="hljs-keyword">const</span> path = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">allocUtf8String</span>(<span class="hljs-string">&quot;/data/local/tmp/libdummy.so&quot;</span>);<br><span class="hljs-keyword">var</span> ret = <span class="hljs-title function_">dlopen</span>(path, <span class="hljs-number">2</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;ret = &quot;</span> + ret);<br><span class="hljs-keyword">var</span> error = <span class="hljs-title function_">dlerror</span>();<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;error = &quot;</span> + <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">readUtf8String</span>(error));<br></code></pre></td></tr></table></figure>

<p>被动加载：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> dlopen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeFunction</span>(<span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">&#x27;dlopen&#x27;</span>), <span class="hljs-string">&#x27;pointer&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]);<br><span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">replace</span>(dlopen, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeCallback</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">path, mode</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;dlopen(&quot;</span> + <span class="hljs-string">&quot;path=\&quot;&quot;</span> + <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">readUtf8String</span>(path) + <span class="hljs-string">&quot;\&quot;&quot;</span> + <span class="hljs-string">&quot;, mode=&quot;</span> + mode + <span class="hljs-string">&quot;)&quot;</span>);<br>    <span class="hljs-keyword">var</span> name = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">readUtf8String</span>(path);<br>    <span class="hljs-keyword">if</span> (name !== <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[*] dlopen &quot;</span> + name);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">dlopen</span>(path, mode);<br>&#125;, <span class="hljs-string">&#x27;pointer&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]));<br></code></pre></td></tr></table></figure>

<p>更常用的方案：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//刚注入的时候这个so还没加载，需要hook dlopen</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">inline_hook</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> base_hello_jni = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findBaseAddress</span>(<span class="hljs-string">&quot;libxxxx.so&quot;</span>);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;base_hello_jni:&quot;</span>, base_hello_jni);<br>    <span class="hljs-keyword">if</span> (base_hello_jni) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(base_hello_jni);<br>        <span class="hljs-comment">//inline hook</span><br>        <span class="hljs-keyword">var</span> addr_07320 = base_hello_jni.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x07320</span>);<span class="hljs-comment">//指令执行的地址，不是变量所在的栈或堆</span><br>        <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(addr_07320, &#123;<br>            <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;addr_07320 x13:&quot;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">x13</span>);<span class="hljs-comment">//注意这里是怎么得到寄存器值的</span><br>            &#125;, <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) &#123;<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//8.0以下所有的so加载都通过dlopen</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hook_dlopen</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> dlopen = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;dlopen&quot;</span>);<br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(dlopen, &#123;<br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) &#123;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">call_hook</span> = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">var</span> so_name = <span class="hljs-title function_">ptr</span>(args[<span class="hljs-number">0</span>]).<span class="hljs-title function_">readCString</span>();<br>            <span class="hljs-keyword">if</span> (so_name.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;libxxxx.so&quot;</span>) &gt;= <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;dlopen:&quot;</span>, <span class="hljs-title function_">ptr</span>(args[<span class="hljs-number">0</span>]).<span class="hljs-title function_">readCString</span>());<br>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">call_hook</span> = <span class="hljs-literal">true</span>;<span class="hljs-comment">//dlopen函数找到了</span><br>            &#125;<br><br>        &#125;, <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">call_hook</span>) &#123;<span class="hljs-comment">//dlopen函数找到了就hook so</span><br>                <span class="hljs-title function_">inline_hook</span>();<br>            &#125;<br>        &#125;<br>    &#125;);<br><span class="hljs-comment">// 高版本Android系统使用android_dlopen_ext</span><br>    <span class="hljs-keyword">var</span> android_dlopen_ext = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;android_dlopen_ext&quot;</span>);<br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(android_dlopen_ext, &#123;<br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) &#123;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">call_hook</span> = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">var</span> so_name = <span class="hljs-title function_">ptr</span>(args[<span class="hljs-number">0</span>]).<span class="hljs-title function_">readCString</span>();<br>            <span class="hljs-keyword">if</span> (so_name.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;libhxxxx.so&quot;</span>) &gt;= <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;android_dlopen_ext:&quot;</span>, <span class="hljs-title function_">ptr</span>(args[<span class="hljs-number">0</span>]).<span class="hljs-title function_">readCString</span>());<br>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">call_hook</span> = <span class="hljs-literal">true</span>;<br>            &#125;<br><br>        &#125;, <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">call_hook</span>) &#123;<br>                <span class="hljs-title function_">inline_hook</span>();<br>            &#125;<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>通过这个方式能保证在对动态库进行钩取时候对其是否加载进行检测。</p>
<p>在限定 <code>Android</code> 平台时，还可以直接对 <code>loadLibrary</code> 进行 hook：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-title class_">System</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;java.lang.System&#x27;</span>);<br>    <span class="hljs-keyword">const</span> <span class="hljs-title class_">Runtime</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;java.lang.Runtime&#x27;</span>);<br>    <span class="hljs-keyword">const</span> <span class="hljs-title class_">VMStack</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;dalvik.system.VMStack&#x27;</span>);<br><br>    <span class="hljs-title class_">System</span>.<span class="hljs-property">loadLibrary</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">library</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;System.loadLibrary(&quot;&#x27;</span> + library + <span class="hljs-string">&#x27;&quot;)&#x27;</span>);<br>            <span class="hljs-title class_">Runtime</span>.<span class="hljs-title function_">getRuntime</span>().<span class="hljs-title function_">loadLibrary0</span>(<span class="hljs-title class_">VMStack</span>.<span class="hljs-title function_">getCallingClassLoader</span>(), library);<br>        &#125; <span class="hljs-keyword">catch</span>(ex) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ex);<br>        &#125;<br>    &#125;;<br>    <br>    <span class="hljs-title class_">System</span>.<span class="hljs-property">load</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">library</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;System.load(&quot;&#x27;</span> + library + <span class="hljs-string">&#x27;&quot;)&#x27;</span>);<br>            <span class="hljs-title class_">Runtime</span>.<span class="hljs-title function_">getRuntime</span>().<span class="hljs-title function_">nativeLoad</span>(library, <span class="hljs-title class_">VMStack</span>.<span class="hljs-title function_">getCallingClassLoader</span>());<br>        &#125; <span class="hljs-keyword">catch</span>(ex) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ex);<br>        &#125;<br>    &#125;;<br>&#125;);<br></code></pre></td></tr></table></figure>
<h3 id="打印调用栈"><a href="#打印调用栈" class="headerlink" title="打印调用栈"></a>打印调用栈</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> membase = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findBaseAddress</span>(<span class="hljs-string">&#x27;libtest.so&#x27;</span>);<br><span class="hljs-keyword">const</span> funcs = [ <span class="hljs-string">&#x27;0x21B248&#x27;</span>, <span class="hljs-string">&#x27;0x21D0C8&#x27;</span>, <span class="hljs-string">&#x27;0x234730&#x27;</span>, <span class="hljs-string">&#x27;0x23F718&#x27;</span>, <span class="hljs-string">&#x27;0x259E68&#x27;</span> ];<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> funcs) &#123;<br>    <span class="hljs-keyword">var</span> funcPtr = membase.<span class="hljs-title function_">add</span>(funcs[i]);<br>    <span class="hljs-keyword">var</span> handler = (<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">var</span> name = funcs[i];<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name + <span class="hljs-string">&#x27;: &#x27;</span>);<br>            <span class="hljs-keyword">var</span> trace = <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">backtrace</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-title class_">Backtracer</span>.<span class="hljs-property">ACCURATE</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">DebugSymbol</span>.<span class="hljs-property">fromAddress</span>);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j <span class="hljs-keyword">in</span> trace)<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(trace[j]);<br>        &#125;;<br>    &#125;)();<br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(funcPtr, &#123;<span class="hljs-attr">onEnter</span>: handler&#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="用-Stalker-跟踪函数接下来的调用"><a href="#用-Stalker-跟踪函数接下来的调用" class="headerlink" title="用 Stalker 跟踪函数接下来的调用"></a>用 Stalker 跟踪函数接下来的调用</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> funcs = [ <span class="hljs-string">&#x27;0x870FF0&#x27;</span>, <span class="hljs-string">&#x27;0x871BA0&#x27;</span> ];<br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STALKED</span> = <span class="hljs-number">12345</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STARTING_ADDRESS</span> = <span class="hljs-string">&quot;0x102FE0&quot;</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ENDING_ADDRESS</span> = <span class="hljs-string">&quot;0x89BE04&quot;</span>;<br><span class="hljs-keyword">const</span> base = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findBaseAddress</span>(<span class="hljs-string">&#x27;libtest.so&#x27;</span>);<br><span class="hljs-keyword">var</span> threads = [];<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> funcs) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Hooking funcs[&#x27;</span> + i + <span class="hljs-string">&#x27;] &#x27;</span> + funcs[i]);<br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(base.<span class="hljs-title function_">add</span>(funcs[i]), &#123;<br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) &#123;<br>            <span class="hljs-keyword">var</span> tid = <span class="hljs-title class_">Process</span>.<span class="hljs-title function_">getCurrentThreadId</span>();<br>            <span class="hljs-keyword">if</span> (threads[tid] == <span class="hljs-variable constant_">STALKED</span>)<br>                <span class="hljs-keyword">return</span>;<br>            <span class="hljs-title class_">Stalker</span>.<span class="hljs-title function_">follow</span>(tid, &#123;<br>                <span class="hljs-attr">events</span>: &#123;<br>                    <span class="hljs-attr">call</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// CALL instructions: yes please</span><br>                    <span class="hljs-attr">ret</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// RET instructions: no thanks</span><br>                    <span class="hljs-attr">exec</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// all instructions: no thanks</span><br>                &#125;,<br>                <span class="hljs-attr">onCallSummary</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">summary</span>) &#123;<br>                    <span class="hljs-keyword">var</span> log = []<br>                    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> summary) &#123;<br>                        <span class="hljs-keyword">var</span> addr = <span class="hljs-title function_">ptr</span>(i).<span class="hljs-title function_">sub</span>(base));<br>                        <span class="hljs-keyword">if</span> (addr.<span class="hljs-title function_">compare</span>(<span class="hljs-title function_">ptr</span>(<span class="hljs-variable constant_">STARTING_ADDRESS</span>)) &gt;= <span class="hljs-number">0</span> &amp;&amp; addr.<span class="hljs-title function_">compare</span>(<span class="hljs-title function_">ptr</span>(<span class="hljs-variable constant_">ENDING_ADDRESS</span>)) &lt;= <span class="hljs-number">0</span>)<br>                            log.<span class="hljs-title function_">push</span>(addr);<br>                    &#125;<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(log));<br>                &#125;<br>            &#125;);<br>            threads[tid] = <span class="hljs-variable constant_">STALKED</span>;<br>        &#125;,<br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) &#123;<br>            <span class="hljs-keyword">var</span> tid = <span class="hljs-title class_">Process</span>.<span class="hljs-title function_">getCurrentThreadId</span>();<br>            <span class="hljs-keyword">if</span> (threads[tid] == <span class="hljs-variable constant_">STALKED</span>)<br>                <span class="hljs-keyword">return</span>;<br>            <span class="hljs-title class_">Stalker</span>.<span class="hljs-title function_">unfollow</span>(tid);<br>            <span class="hljs-title class_">Stalker</span>.<span class="hljs-title function_">garbageCollect</span>();<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>events</code> 中能决定跟踪的颗粒度，包含跟踪所有 <code>call</code>,<code>ret</code> 和所有指令三个等级</p>
<h3 id="Hook一个Obj-C方法"><a href="#Hook一个Obj-C方法" class="headerlink" title="Hook一个Obj-C方法"></a>Hook一个Obj-C方法</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> sendMessage = <span class="hljs-title class_">ObjC</span>.<span class="hljs-property">classes</span>.<span class="hljs-property">SecureStorage</span>[<span class="hljs-string">&quot;- readFile:&quot;</span>];<br><span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(sendMessage.<span class="hljs-property">implementation</span>, &#123;<br>    <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) &#123;<br>        <span class="hljs-keyword">var</span> message = <span class="hljs-title class_">ObjC</span>.<span class="hljs-title class_">Object</span>(retval);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;- [SecureStorage readFile:] --&gt;\n\&quot;&quot;</span> + message.<span class="hljs-title function_">toString</span>() + <span class="hljs-string">&quot;\&quot;&quot;</span>);<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure>

<h2 id="JavaScript-Function"><a href="#JavaScript-Function" class="headerlink" title="JavaScript Function"></a>JavaScript Function</h2><h3 id="string2byte"><a href="#string2byte" class="headerlink" title="string2byte"></a>string2byte</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">string2Bytes</span>(<span class="hljs-params">str</span>) &#123;  <br>    <span class="hljs-keyword">var</span> ch, st, re = []; <br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; str.<span class="hljs-property">length</span>; i++ ) &#123; <br>        ch = str.<span class="hljs-title function_">charCodeAt</span>(i);  <br>        st = [];                 <br>        <span class="hljs-keyword">do</span> &#123;  <br>            st.<span class="hljs-title function_">push</span>( ch &amp; <span class="hljs-number">0xFF</span> );  <br>            ch = ch &gt;&gt; <span class="hljs-number">8</span>;          <br>        &#125;    <br>        <span class="hljs-keyword">while</span> ( ch );  <br>        re = re.<span class="hljs-title function_">concat</span>( st.<span class="hljs-title function_">reverse</span>() ); <br>    &#125;  <br>    <span class="hljs-keyword">return</span> re;  <br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="hex2bytes"><a href="#hex2bytes" class="headerlink" title="hex2bytes"></a>hex2bytes</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">hex2bytes</span>=(<span class="hljs-params">hex</span>)=&gt;&#123;<br>	<span class="hljs-keyword">let</span> pos=<span class="hljs-number">0</span>,len=hex.<span class="hljs-property">length</span>;<br>    <span class="hljs-keyword">if</span>(len%<span class="hljs-number">2</span>!=<span class="hljs-number">0</span>)&#123;<br>    	<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span><br>    &#125;<br>    len/<span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">let</span> bytes=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>();<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;len;i++)&#123;<br>    	<span class="hljs-keyword">let</span> s=hex.<span class="hljs-title function_">substr</span>(pos,<span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">let</span> v=<span class="hljs-built_in">parseInt</span>(s,<span class="hljs-number">16</span>);<br>        bytes.<span class="hljs-title function_">push</span>(v);<br>        pos+=<span class="hljs-number">2</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> bytes<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="bytes2hex"><a href="#bytes2hex" class="headerlink" title="bytes2hex"></a>bytes2hex</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">bytes2hex</span>=(<span class="hljs-params">bytes</span>)=&gt;&#123;<br>	<span class="hljs-keyword">let</span> hex=<span class="hljs-string">&quot;&quot;</span>,len=bytes.<span class="hljs-property">length</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;len;i++)&#123;<br>    	<span class="hljs-keyword">let</span> tmp,num=bytes[i];<br>        <span class="hljs-keyword">if</span>(num&lt;<span class="hljs-number">0</span>)&#123;<br>        	tmp=(<span class="hljs-number">255</span>+num+<span class="hljs-number">1</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>        	tmp=num.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span>(tmp.<span class="hljs-property">length</span>==<span class="hljs-number">1</span>)&#123;<br>        	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;0&quot;</span>+tmp;<br>        &#125;<br>        hex+=tmp;<br>    &#125;<br>    <span class="hljs-keyword">return</span> hex<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h1><p><a target="_blank" rel="noopener" href="https://awesomeopensource.com/project/iddoeldor/frida-snippets">frida-snippets: 一些可用的脚本或工具</a></p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2025/01/01/%E6%98%A8%E6%97%A5%E3%80%81%E4%BB%8A%E6%97%A5%E5%92%8C%E6%98%8E%E6%97%A5%EF%BC%8C%E7%8B%82%E5%A5%94%E5%90%91%E8%99%9A%E6%97%A0%E7%9A%84%E6%B8%A1%E8%BD%AE%E8%BD%B0%E9%B8%A3%E5%95%B8%E5%8F%AB%E7%9D%80%E6%92%95%E6%89%AF%E4%BA%BA%E7%9A%84%E7%81%B5%E9%AD%82/">← Next 昨日、今日和明日，狂奔向虚无的渡轮轰鸣啸叫着撕扯人的灵魂</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2024/05/10/%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%20Learning%20Walking/">强化学习 Learning Walking Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/6.png" alt="Logo"></a><h1 id="Dr"><a href="TokameinE">TokameinE</a></h1><div id="description"><p></p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/ErodedElk"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" target="_blank" rel="noopener" href="https://space.bilibili.com/1782544616"><i class="fa-brands fa-bilibili" alt="BiliBili"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Usage-Cheat-Sheet"><span class="toc-number">2.</span> <span class="toc-text">Usage Cheat Sheet</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.1.</span> <span class="toc-text">启动模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-Platform"><span class="toc-number">2.2.</span> <span class="toc-text">Windows Platform</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Command-Line"><span class="toc-number">2.3.</span> <span class="toc-text">Command Line</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Remote-Frida-Server"><span class="toc-number">2.4.</span> <span class="toc-text">Remote Frida Server</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Code-Cheat-Sheet"><span class="toc-number">3.</span> <span class="toc-text">Code Cheat Sheet</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Script-Function"><span class="toc-number">3.1.</span> <span class="toc-text">Script Function</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Python-Template"><span class="toc-number">3.2.</span> <span class="toc-text">Python Template</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JavaScript-Template"><span class="toc-number">3.3.</span> <span class="toc-text">JavaScript Template</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.3.1.</span> <span class="toc-text">替换函数实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%B1%BB%E5%8F%8A%E5%85%B6%E4%B8%8B%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">3.3.2.</span> <span class="toc-text">获取类及其下的方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%B1%BB%E5%8F%8A%E5%85%B6%E4%B8%8B%E7%9A%84-native-%E6%96%B9%E6%B3%95"><span class="toc-number">3.3.3.</span> <span class="toc-text">获取类及其下的 native 方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E7%89%B9%E5%AE%9A%E5%8A%A8%E6%80%81%E5%BA%93%E8%BF%9B%E8%A1%8C-hook"><span class="toc-number">3.3.4.</span> <span class="toc-text">对特定动态库进行 hook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-native-%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">3.3.5.</span> <span class="toc-text">修改 native 函数返回值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dlopen-hook"><span class="toc-number">3.3.6.</span> <span class="toc-text">dlopen hook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8D%B0%E8%B0%83%E7%94%A8%E6%A0%88"><span class="toc-number">3.3.7.</span> <span class="toc-text">打印调用栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8-Stalker-%E8%B7%9F%E8%B8%AA%E5%87%BD%E6%95%B0%E6%8E%A5%E4%B8%8B%E6%9D%A5%E7%9A%84%E8%B0%83%E7%94%A8"><span class="toc-number">3.3.8.</span> <span class="toc-text">用 Stalker 跟踪函数接下来的调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hook%E4%B8%80%E4%B8%AAObj-C%E6%96%B9%E6%B3%95"><span class="toc-number">3.3.9.</span> <span class="toc-text">Hook一个Obj-C方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JavaScript-Function"><span class="toc-number">3.4.</span> <span class="toc-text">JavaScript Function</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#string2byte"><span class="toc-number">3.4.1.</span> <span class="toc-text">string2byte</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hex2bytes"><span class="toc-number">3.4.2.</span> <span class="toc-text">hex2bytes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bytes2hex"><span class="toc-number">3.4.3.</span> <span class="toc-text">bytes2hex</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Other"><span class="toc-number">4.</span> <span class="toc-text">Other</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>