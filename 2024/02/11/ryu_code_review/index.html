<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>ryu 代码案例分析到理解简单 SDN 网络 | TokameinE - 雨声淅淅沥沥，犬吠永不止息</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: Bender;
 src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
 font-family: BenderLight;
 src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/91110244_p0.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>ryu 代码案例分析到理解简单 SDN 网络</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2024-02-10T16:35:00.000Z" id="date"> 2024-02-11</time></div></span><br><span>Last Update: <div class="control"><time datetime="2024-12-29T04:50:35.007Z" id="updated"> 2024-12-29</time></div></span></div></div><hr><div id="post-content"><p>ryu 作为一个由 python 编写的控制器，其 app 均可直接通过 python 来创建，本文仅做学习之余的备忘录，用以熟悉其开发流程。</p>
<blockquote>
<p> 一般来说，通过 <code>ryu-manage app.py</code> 即可运行该应用。在需要运行多个应用时可按顺序添加参数。<br> 下文会对此做一些额外的实验（希望）。</p>
</blockquote>
<h1 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h1><p>ryu 提供了前置的各项环境，在开发应用时，只需要声明一个继承自 <code>app_manager.RyuApp</code> ，该类就会具备各项所需条件和环境而无需再做额外操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> ryu.base <span class="hljs-keyword">import</span> app_manager<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleSwitch13</span>(app_manager.RyuApp):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):<br>        <span class="hljs-built_in">super</span>(SimpleSwitch13, self).__init__(*args, **kwargs)<br></code></pre></td></tr></table></figure>

<p>以上为固定的范式，一般所有的应用都可以这么声明。<code>SimpleSwitch13</code> 为应用名称。</p>
<h1 id="行为"><a href="#行为" class="headerlink" title="行为"></a>行为</h1><h2 id="修饰器与事件"><a href="#修饰器与事件" class="headerlink" title="修饰器与事件"></a>修饰器与事件</h2><p>在完成应用框架的声明以后，接下来是要定义应用的具体行为。ryu 提供了特定的修饰器 <code>set_ev_cls</code> 以帮助用户解释不同命令的行为模式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleSwitch13</span>(app_manager.RyuApp):<br>	<span class="hljs-comment">#...此处省略...</span><br>	<br><span class="hljs-meta">    @set_ev_cls(<span class="hljs-params">ofp_event.EventOFPSwitchFeatures, CONFIG_DISPATCHER</span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">switch_features_handler</span>(<span class="hljs-params">self, ev</span>):<br>        datapath = ev.msg.datapath<br>        ofproto = datapath.ofproto<br>        parser = datapath.ofproto_parser<br><br>        <span class="hljs-comment"># install table-miss flow entry</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment"># We specify NO BUFFER to max_len of the output action due to</span><br>        <span class="hljs-comment"># OVS bug. At this moment, if we specify a lesser number, e.g.,</span><br>        <span class="hljs-comment"># 128, OVS will send Packet-In with invalid buffer_id and</span><br>        <span class="hljs-comment"># truncated packet data. In that case, we cannot output packets</span><br>        <span class="hljs-comment"># correctly.  The bug has been fixed in OVS v2.1.0.</span><br>        <span class="hljs-keyword">match</span> = parser.OFPMatch()<br>        actions = [parser.OFPActionOutput(ofproto.OFPP_CONTROLLER,<br>                                          ofproto.OFPCML_NO_BUFFER)]<br>        self.add_flow(datapath, <span class="hljs-number">0</span>, <span class="hljs-keyword">match</span>, actions)<br></code></pre></td></tr></table></figure>

<p><code>set_ev_cls</code> 的参数分别对应了：<br>    - 所监听的事件名<br>    - 所处的阶段</p>
<p>监听事件名包括了这些内容：</p>
<ul>
<li>ryu.controller.ofp_event<ul>
<li>datapath state 通知系<ul>
<li>EventOFPStateChange</li>
</ul>
</li>
<li>EventOFPMsgBase 基类<ul>
<li>EventOFPHello</li>
<li>EventOFPSwitchFeatures</li>
<li>EventOFPPortDescStatsReply</li>
<li>EventOFPEchoRequest</li>
<li>EventOFPEchoReply</li>
<li>EventOFPPortStatus</li>
<li>EventOFPErrorMsg</li>
</ul>
</li>
<li>port state 通知系<ul>
<li>EventOFPPortStateChange - 在 <strong>EventOFPPortStatus</strong> 之后发出</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>在一个常规的连接行为下，会按照如下的顺序分阶段完成：</p>
<ul>
<li>控制器与交换机完成 TCP&#x2F;STL 连接建立</li>
<li>控制器监听到 <code>EventOFPStateChange</code> 事件</li>
<li>交换机发送 <code>OFPT_HELLO</code> - 此时控制器监听 <code>EventOFPHello</code> <ul>
<li>自 <code>from: ryu.controller.controller.Datapath._recv_loop</code> </li>
<li>到 <code>ryu.controller.ofp_handler.OFPHandler.hello_handler [HANDSHAKE_DISPATCHER]</code></li>
</ul>
</li>
<li>控制器监听到 <code>EventOFPStateChange</code> 事件<ul>
<li>由 <code>ryu.controller.ofp_handler.OFPHandler.hello_handler [CONFIG_DISPATCHER]</code> 发出</li>
</ul>
</li>
<li><code>controller.ofp_handler.OFPHandler.hello_handler</code> 发出 <code>OFPFeaturesRequest</code> </li>
<li>交换机发送 <code>OFPT_FEATURES</code> 事件</li>
<li>控制器监听 <code>EventOFPSwitchFeatures</code> <ul>
<li>自 <code> ryu.controller.controller.Datapath._recv_loop</code></li>
<li>到  <code>ryu.controller.ofp_handler.OFPHandler.switch_features_handler [CONFIG_DISPATCHER]</code></li>
<li>或到 <code>ryu.controller.dpset.DPSet.switch_features_handler [CONFIG_DISPATCHER]</code></li>
</ul>
</li>
<li><code>ryu.controller.ofp_handler.OFPHandler.switch_features_handler</code> 发送 <code>OFPPortDescStatsRequest</code> </li>
<li>交换机发送 <code>OFPT_MULTIPART_REPLY/OFPMP_PORT_DESC</code></li>
<li>接受事件 <code>EventOFPPortDescStatsReply</code> <ul>
<li>自 <code>ryu.controller.controller.Datapath._recv_loop</code></li>
<li>到 <code>ryu.controller.ofp_handler.OFPHandler.multipart_reply_handler [CONFIG_DISPATCHER]</code></li>
</ul>
</li>
<li>接受事件 <code>EventOFPStateChange</code><ul>
<li>自 <code>ryu.controller.ofp_handler.OFPHandler.multipart_reply_handler [MAIN_DISPATCHER]</code></li>
<li>到 <code>ryu.controller.dpset.DPSet.dispatcher_change [MAIN_DISPATCHER]</code></li>
</ul>
</li>
<li>注册 DP 服务：<code>EventDP</code><ul>
<li>自 <code>ryu.controller.dpset.DPSet._register</code></li>
</ul>
</li>
</ul>
<p>在这个流程中分别有三个阶段：<code>HANDSHAKE_DISPATCHER</code>&#x2F;<code>CONFIG_DISPATCHER</code>&#x2F;<code>MAIN_DISPATCHER</code>，也就是代码中的第二个参数。以及各类事件，对应代码中的第一个参数。</p>
<blockquote>
<p>除了上述这三个阶段，还有一个在终止时进入的 <code>DEAD_DISPATCHER</code> 阶段。</p>
</blockquote>
<p>因此 <code>set_ev_cls</code> 的行为是：监听 <code>参数2</code> 阶段下的 <code>参数一</code> 事件。</p>
<table>
<thead>
<tr>
<th>协商</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>ryu.controller.handler.HANDSHAKE_DISPATCHER</td>
<td>发送并且等待 hello 消息</td>
</tr>
<tr>
<td>ryu.controller.handler.CONFIG_DISPATCHER</td>
<td>版本协商和发送功能请求信息</td>
</tr>
<tr>
<td>ryu.controller.handler.MAIN_DISPATCHER</td>
<td>收到交换机特性信息并发送设置配置信息</td>
</tr>
<tr>
<td>ryu.controller.handler.DEAD_DISPATCHER</td>
<td>与对等设备断开连接。或由于某些无法恢复的错误而断开连接。</td>
</tr>
</tbody></table>
<p>不过除了以上的这些事件外，还有另外一类事件定义在 <code>ryu.controller.dpset</code> 下，其用于 DP 服务：</p>
<ul>
<li>EventDP</li>
<li>EventDPReconnected</li>
<li>EventPortAdd</li>
<li>EventPortDelete</li>
<li>EventPortModify</li>
</ul>
<blockquote>
<p>思考：所以 OpenFlow 实际上仍算是一个应用层协议？假设交换机和控制器间通过 TCP 进行通信，那么这或许也说明该协议的工作层级并不低，属于应用层的范畴，可以直接在设备的网卡上捕获的完整的流量?(或许，这仅为笔者的思考)</p>
</blockquote>
<h2 id="Datapath"><a href="#Datapath" class="headerlink" title="Datapath"></a>Datapath</h2><p>在本文案例中，来自于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">datapath = ev.msg.datapath<br></code></pre></td></tr></table></figure>

<h3 id="ryu-controller-controller-Datapath"><a href="#ryu-controller-controller-Datapath" class="headerlink" title="ryu.controller.controller.Datapath"></a>ryu.controller.controller.Datapath</h3><p>该实例用来描述 OpenFlow 交换机的类，它的实例包含下面属性。</p>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>64 位 OpenFlow Datapath ID。仅适用于 ryu.controller.handler.MAIN_DISPATCHER 阶段。</td>
</tr>
<tr>
<td>ofproto</td>
<td>针对协商的 OpenFlow 版本导出 OpenFlow 定义（主要是规范中出现的常量）的模块。例如，ryu.ofproto.ofprot_v1_0 用于 OpenFlow 1.0。</td>
</tr>
<tr>
<td>ofproto_parser</td>
<td>为协商的 OpenFlow 版本导出 OpenFlow 线报文编码器和解码器的模块。例如，用于 OpenFlow 1.0 的 ryu.ofproto.ofprot_v1_0_parser。</td>
</tr>
<tr>
<td>ofproto_parser.OFPxxxx(datapath,…)</td>
<td>用于为给定交换机准备 OpenFlow 报文的可调用程序。xxxx 是报文名称。例如，OFPFlowMod 表示 flow-mod 消息。参数取决于报文。</td>
</tr>
<tr>
<td>set_xid(self, msg)</td>
<td>生成 OpenFlow XID 并将其放入 msg.xid。</td>
</tr>
<tr>
<td>send_msg(self, msg)</td>
<td>将 OpenFlow 报文排队发送到相应的交换机。如果 msg.xid 为 None，则会在队列之前自动调用报文的 set_xid。</td>
</tr>
<tr>
<td>send_packet_out</td>
<td>deprecated</td>
</tr>
<tr>
<td>send_flow_mod</td>
<td>deprecated</td>
</tr>
<tr>
<td>send_flow_del</td>
<td>deprecated</td>
</tr>
<tr>
<td>send_delete_all_flows</td>
<td>deprecated</td>
</tr>
<tr>
<td>send_barrier</td>
<td>排队向交换机发送 OpenFlow 屏障报文。</td>
</tr>
<tr>
<td>send_nxt_set_flow_format</td>
<td>deprecated</td>
</tr>
<tr>
<td>is_reserved_port</td>
<td>deprecated</td>
</tr>
<tr>
<td>简单来说，DataPath 实例包含了一个来自交换机事件的所有必要信息。</td>
<td></td>
</tr>
</tbody></table>
<h3 id="ofproto-parser"><a href="#ofproto-parser" class="headerlink" title="ofproto_parser"></a>ofproto_parser</h3><p>相关的代码定义在 <code>ryu.ryu.ofproto.ofproto_v1_3_parser.py</code> 下，后面的具体版本取决于所用的 OF 版本，这里笔者以 1.3 为例。</p>
<p>该成员下定义了具体的报文构造函数，由于数量众多，这里就只列了前 16 个，实际上不止这些：</p>
<ul>
<li>OFPHello - 开始连接时，交换机和控制器之间会交换 hello 信息</li>
<li>OFPErrorMsg - 交换机通过此信息通知控制器出现问题</li>
<li>OFPEchoRequest -  Echo request message</li>
<li>OFPEchoReply - Echo reply message</li>
<li>OFPExperimenter - Experimenter extension message </li>
<li>OFPSwitchFeatures - 交换机用功能回复信息响应功能请求</li>
<li>OFPGetConfigReply - 交换机通过获取配置回复信息来响应配置请求</li>
<li>OFPPacketIn - 交换机通过此报文将收到的数据包发送给控制器</li>
<li>OFPFlowRemoved - 当流量条目超时或被删除时，交换机会通过此信息通知控制器</li>
<li>OFPPortStatus - 交换机通知控制器端口的更改</li>
<li>OFPFlowMod - 控制器发送此信息以修改流量表</li>
<li>OFPMultipartReply</li>
<li>OFPBarrierReply - 交换机会用此信息响应屏障请求</li>
<li>OFPQueueGetConfigReply - 交换机通过此信息响应队列配置请求</li>
<li>OFPRoleReply - 交换机用此信息响应角色请求</li>
<li>OFPGetAsyncReply - 交换机以此信息响应获取异步配置请求</li>
</ul>
<p>不过大致上是这样划分的：</p>
<ul>
<li>Controller-to-Switch消息：SDN控制器主动发送给OpenFlow交换机的消息<ul>
<li>Features：用于获取交换机特性</li>
<li>Configuration：用来配置和查询交换机参数</li>
<li>Modify-State：用来修改交换机状态信息（增删改流表项、组表项等）<ul>
<li>Table-Mod消息</li>
<li>Flow-Mod消息（流表操作，添加、删除、修改流表项）</li>
<li>Group-Mod消息</li>
<li>Port-Mod消息</li>
<li>Meter-Mod消息</li>
</ul>
</li>
<li>Read-State：用来读取交换机状态信息（当前配置、统计信息等）<ul>
<li>Port-Stats消息</li>
<li>Flow-Stats消息</li>
<li>…</li>
</ul>
</li>
<li>Packet-Out：用来指定交换机将数据包从指定端口转发出去</li>
<li>Barrier：在不同消息之间使用，确保操作顺序执行</li>
<li>Role Request：控制器用于询问或设置自身在交换机中的角色，常用于交换机与多控制器连接的场景</li>
<li>Asynchronous-Configuration：控制器设置异步消息过滤器，只接收感兴趣的异步消息，一般在多控制器场景下使用</li>
</ul>
</li>
<li>Asynchronous（异步）消息：OpenFlow交换机主动发送给SDN控制器的异步消息<ul>
<li>Packet-In：将数据包交给控制器处理，一般流表匹配中出现Table-Miss时或流表项显示指定将数据包交给控制器时，触发该消息</li>
<li>Flow-Removed：通知控制器，流表项被删除；流表项超时或控制器删除流表项时触发该消息（需要在交换机配置时使能该消息）</li>
<li>Port-status ：通知控制器，交换机端口状态发生变化</li>
<li>Role-status：通知控制器，控制器在交换机中的角色发送变化</li>
<li>Controller-Status：通知控制器，OpenFlow通道状态发生变化</li>
<li>Flow-monitor：通知控制器，流表发送变化</li>
</ul>
</li>
<li>Symmetric（对称）消息：可由SDN控制器或OpenFlow交换机主动发送的消息<ul>
<li>Hello：建立控制器与交换机之间的OpenFlow通道</li>
<li>Echo：检测交换机与控制器之间的连接状态或测量OpenFlow通道的时延和带宽</li>
<li>Error：用于通告错误</li>
<li>Experiment：用于实验，测试新特性</li>
</ul>
</li>
</ul>
<p class='item-img' data-src='/./images/ryu_code_review/sdn-type.png'><img src="/./images/ryu_code_review/sdn-type.png"></p>
<p>除此之外，还包括了一些其他数据的构造类，比如 <code>OFPMatch</code> 用以构造流表的匹配结构；或是 <code>OFPInstruction</code> 用于构造 OF 指令结构。</p>
<p>在本文案例代码中，通过如下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">      parser = datapath.ofproto_parser<br>      <span class="hljs-keyword">match</span> = parser.OFPMatch()<br>      actions = [parser.OFPActionOutput(ofproto.OFPP_CONTROLLER,<br>                                        ofproto.OFPCML_NO_BUFFER)]<br>self.add_flow(datapath, <span class="hljs-number">0</span>, <span class="hljs-keyword">match</span>, actions)<br></code></pre></td></tr></table></figure>

<p>分别构造了一个空流表，这意味着它会匹配到任何(<strong>Any</strong>)项；以及一个输出行为 <code>OFPActionOutput</code> 。</p>
<h2 id="如何下发流表"><a href="#如何下发流表" class="headerlink" title="如何下发流表"></a>如何下发流表</h2><p>代码中定义了如下函数来完成一个流表的下发：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_flow</span>(<span class="hljs-params">self, datapath, priority, <span class="hljs-keyword">match</span>, actions, buffer_id=<span class="hljs-literal">None</span></span>):<br>    ofproto = datapath.ofproto<br>    parser = datapath.ofproto_parser<br><br>    inst = [parser.OFPInstructionActions(ofproto.OFPIT_APPLY_ACTIONS,<br>                                         actions)]<br>    <span class="hljs-keyword">if</span> buffer_id:<br>        mod = parser.OFPFlowMod(datapath=datapath, buffer_id=buffer_id,<br>                                priority=priority, <span class="hljs-keyword">match</span>=<span class="hljs-keyword">match</span>,<br>                                instructions=inst)<br>    <span class="hljs-keyword">else</span>:<br>        mod = parser.OFPFlowMod(datapath=datapath, priority=priority,<br>                                <span class="hljs-keyword">match</span>=<span class="hljs-keyword">match</span>, instructions=inst)<br>    datapath.send_msg(mod)<br></code></pre></td></tr></table></figure>

<p>假设我们使用 TCP 的方式建立连接，那么这个函数的行为就相当朴素了。通过构造一份 <code>OFPFlowMod</code> 报文，并通过常规的 TCP 请求包发送给交换机即可完成下发。</p>
<p>这里附带一份常规报文的基本格式：</p>
<p class='item-img' data-src='/./images/ryu_code_review/sdn-packet.png'><img src="/./images/ryu_code_review/sdn-packet.png"></p>
<blockquote>
<p>思考：不过这里或许也会存在一定的安全问题？比如说通过 TCP 连接的信道是没有相关的鉴权和身份验证的。尽管这份连接往往必须由交换机发出，即攻击者一般不能决定哪些设备能够访问交换机，但是一旦信道建立完毕，后续在这个信道上通信的报文都会被认为是合法的，因此如果能有办法劫持信道，或许有办法干扰交换机的工作。</p>
</blockquote>
<h2 id="处理-pack-in"><a href="#处理-pack-in" class="headerlink" title="处理 pack in"></a>处理 pack in</h2><p>上文中，我们为交换机添加的默认流表会使得所有发往交换机的报文都被转发给控制器。</p>
<p>根据一些书籍或资料表示，交换机转发给控制器的报文分为 <code>有缓存</code> 和 <code>无缓存</code>。前者只会转发报文的 <code>header</code> ，而不会将报文的具体内容一并转发，而后者则两者都会转发。不过在 2014 年的时候，还因为 Open vSwitch 的一些 bug(网上的表述为”臭虫“) 导致所有的报文都会被完全转发给控制器。现在或许已经修好了？</p>
<p>以下是完整代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@set_ev_cls(<span class="hljs-params">ofp_event.EventOFPPacketIn, MAIN_DISPATCHER</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">_packet_in_handler</span>(<span class="hljs-params">self, ev</span>):<br>    <span class="hljs-comment"># If you hit this you might want to increase</span><br>    <span class="hljs-comment"># the &quot;miss_send_length&quot; of your switch</span><br>    <span class="hljs-keyword">if</span> ev.msg.msg_len &lt; ev.msg.total_len:<br>        self.logger.debug(<span class="hljs-string">&quot;packet truncated: only %s of %s bytes&quot;</span>,<br>                          ev.msg.msg_len, ev.msg.total_len)<br>    msg = ev.msg<br>    datapath = msg.datapath<br>    ofproto = datapath.ofproto<br>    parser = datapath.ofproto_parser<br>    in_port = msg.<span class="hljs-keyword">match</span>[<span class="hljs-string">&#x27;in_port&#x27;</span>]<br><br>    pkt = packet.Packet(msg.data)<br>    eth = pkt.get_protocols(ethernet.ethernet)[<span class="hljs-number">0</span>]<br><br>    <span class="hljs-keyword">if</span> eth.ethertype == ether_types.ETH_TYPE_LLDP:<br>        <span class="hljs-comment"># ignore lldp packet</span><br>        <span class="hljs-keyword">return</span><br>    dst = eth.dst<br>    src = eth.src<br><br>    dpid = <span class="hljs-built_in">format</span>(datapath.<span class="hljs-built_in">id</span>, <span class="hljs-string">&quot;d&quot;</span>).zfill(<span class="hljs-number">16</span>)<br>    self.mac_to_port.setdefault(dpid, &#123;&#125;)<br><br>    self.logger.info(<span class="hljs-string">&quot;packet in %s %s %s %s&quot;</span>, dpid, src, dst, in_port)<br><br>    <span class="hljs-comment"># learn a mac address to avoid FLOOD next time.</span><br>    self.mac_to_port[dpid][src] = in_port<br><br>    <span class="hljs-keyword">if</span> dst <span class="hljs-keyword">in</span> self.mac_to_port[dpid]:<br>        out_port = self.mac_to_port[dpid][dst]<br>    <span class="hljs-keyword">else</span>:<br>        out_port = ofproto.OFPP_FLOOD<br><br>    actions = [parser.OFPActionOutput(out_port)]<br><br>    <span class="hljs-comment"># install a flow to avoid packet_in next time</span><br>    <span class="hljs-keyword">if</span> out_port != ofproto.OFPP_FLOOD:<br>        <span class="hljs-keyword">match</span> = parser.OFPMatch(in_port=in_port, eth_dst=dst, eth_src=src)<br>        <span class="hljs-comment"># verify if we have a valid buffer_id, if yes avoid to send both</span><br>        <span class="hljs-comment"># flow_mod &amp; packet_out</span><br>        <span class="hljs-keyword">if</span> msg.buffer_id != ofproto.OFP_NO_BUFFER:<br>            self.add_flow(datapath, <span class="hljs-number">1</span>, <span class="hljs-keyword">match</span>, actions, msg.buffer_id)<br>            <span class="hljs-keyword">return</span><br>        <span class="hljs-keyword">else</span>:<br>            self.add_flow(datapath, <span class="hljs-number">1</span>, <span class="hljs-keyword">match</span>, actions)<br>    data = <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">if</span> msg.buffer_id == ofproto.OFP_NO_BUFFER:<br>        data = msg.data<br><br>    out = parser.OFPPacketOut(datapath=datapath, buffer_id=msg.buffer_id,<br>                              in_port=in_port, actions=actions, data=data)<br>    datapath.send_msg(out)<br></code></pre></td></tr></table></figure>

<p>先解释一下相关变量：</p>
<ul>
<li>dpid - 每个交换机独有的位移 ID，在连接控制器时分配</li>
<li>mac_to_port - 控制器维护了一张 mac-port 表，用于记录每个 mac 地址与端口的对应关系</li>
<li>buffer_id - 在没有上传完整报文时，该变量标识的报文在交换机下缓冲区的位置</li>
<li>OFPP_FLOOD - 泛洪&#x2F;广播。意味着将报文广播到<strong>除了入端口外</strong>的所有端口</li>
</ul>
<p>主要的代码逻辑如下：</p>
<ul>
<li>接到 Packet in 事件后解析相关参数</li>
<li>过滤掉 LLDP 流量</li>
<li>将输入端口记录到该交换机的 <code>mac_to_port[dpid][src]</code> 中</li>
<li>判断目标 mac 地址是否已经有 <code>mac_to_port[dpid][dst]</code> 条目<ul>
<li>如果有，那么出端口就是该条目的值</li>
<li>否则，出端口为广播端口</li>
</ul>
</li>
<li>判断出端口是否为广播端口<ul>
<li>如果不是，构造流表，再判断是否上传了完整报文<ul>
<li>如果上传了报文，那么下发流表，并<strong>直接返回</strong></li>
<li>否则，先下发流表，等待后续重新回传数据包</li>
</ul>
</li>
</ul>
</li>
<li>判断数据包是否被全部上传<ul>
<li>如果是，那么设置 data 为 <code>msg.data</code></li>
</ul>
</li>
<li>构造 <code>PacketOut</code> 事件作为输出报文，并设置对应成员、</li>
<li>发回交换机</li>
</ul>
<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding=UTF-8</span><br><span class="hljs-keyword">from</span> mininet.net <span class="hljs-keyword">import</span> Mininet<br><span class="hljs-keyword">from</span> mininet.node <span class="hljs-keyword">import</span> CPULimitedHost<br><span class="hljs-keyword">from</span> mininet.link <span class="hljs-keyword">import</span> TCLink<br><span class="hljs-keyword">from</span> mininet.node <span class="hljs-keyword">import</span> RemoteController, Host, OVSKernelSwitch<br><span class="hljs-keyword">import</span> TokaSdn<br>net = Mininet(host=CPULimitedHost, link=TCLink)<br><span class="hljs-comment"># 创建网络节点</span><br>c0 = net.addController(name=<span class="hljs-string">&#x27;c0&#x27;</span>,controller=RemoteController,protocol=<span class="hljs-string">&#x27;tcp&#x27;</span>,port=<span class="hljs-number">6633</span>)<br>h1 = net.addHost(<span class="hljs-string">&#x27;h1&#x27;</span>,mac=<span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>)<br>h2 = net.addHost(<span class="hljs-string">&#x27;h2&#x27;</span>)<br>h3 = net.addHost(<span class="hljs-string">&#x27;h3&#x27;</span>,mac=<span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>)<br>s1 = net.addSwitch(<span class="hljs-string">&#x27;s1&#x27;</span>)<br>s2 = net.addSwitch(<span class="hljs-string">&#x27;s2&#x27;</span>)<br>s3 = net.addSwitch(<span class="hljs-string">&#x27;s3&#x27;</span>)<br><span class="hljs-comment"># 创建节点间的链路</span><br>net.addLink(h1, s1, bw=<span class="hljs-number">10</span>, delay=<span class="hljs-string">&#x27;5ms&#x27;</span>,max_queue_size=<span class="hljs-number">1000</span>, loss=<span class="hljs-number">0</span>, use_htb=<span class="hljs-literal">True</span>)<br>net.addLink(h2, s2)<br>net.addLink(h3, s3)<br>net.addLink(s1, s2)<br>net.addLink(s2, s3)<br><span class="hljs-comment"># 配置主机 ip</span><br>h1.setIP(<span class="hljs-string">&#x27;10.0.0.1&#x27;</span>, <span class="hljs-number">24</span>)<br>h2.setIP(<span class="hljs-string">&#x27;10.0.0.2&#x27;</span>, <span class="hljs-number">24</span>)<br>h3.setIP(<span class="hljs-string">&#x27;10.0.0.3&#x27;</span>, <span class="hljs-number">24</span>)<br>net.start()<br>net.ping((h1,h3))<br>net.stop()<br></code></pre></td></tr></table></figure>

<p>这里我们限定使用 TCP 完成连接，并指定了控制器，ryu 默认会启动在 6633 端口上，未指定地址时默认本地。同时，我们令主机 h1 去尝试访问 h3，并通过日志来观察控制器行为。</p>
<p>日志如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs sh">packet <span class="hljs-keyword">in</span> 0000000000000001 00:00:00:00:00:01 ff:ff:ff:ff:ff:ff 1<br>&#123;<span class="hljs-string">&#x27;0000000000000002&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 3&#125;, <span class="hljs-string">&#x27;0000000000000001&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 1&#125;&#125;<br>packet <span class="hljs-keyword">in</span> 0000000000000002 00:00:00:00:00:01 ff:ff:ff:ff:ff:ff 2<br>&#123;<span class="hljs-string">&#x27;0000000000000002&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 3, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2&#125;, <span class="hljs-string">&#x27;0000000000000001&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 1&#125;&#125;<br>packet <span class="hljs-keyword">in</span> 0000000000000003 00:00:00:00:00:01 ff:ff:ff:ff:ff:ff 2<br>&#123;<span class="hljs-string">&#x27;0000000000000002&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 3, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2&#125;, <span class="hljs-string">&#x27;0000000000000001&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 1&#125;, <span class="hljs-string">&#x27;0000000000000003&#x27;</span>: &#123;<span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2&#125;&#125;<br>packet <span class="hljs-keyword">in</span> 0000000000000003 00:00:00:00:00:03 00:00:00:00:00:01 1<br>&#123;<span class="hljs-string">&#x27;0000000000000002&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 3, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2&#125;, <span class="hljs-string">&#x27;0000000000000001&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 1&#125;, <span class="hljs-string">&#x27;0000000000000003&#x27;</span>: &#123;<span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 1&#125;&#125;<br>add flow be called!<br>packet <span class="hljs-keyword">in</span> 0000000000000002 00:00:00:00:00:03 00:00:00:00:00:01 3<br>&#123;<span class="hljs-string">&#x27;0000000000000002&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 3, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 3&#125;, <span class="hljs-string">&#x27;0000000000000001&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 1&#125;, <span class="hljs-string">&#x27;0000000000000003&#x27;</span>: &#123;<span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 1&#125;&#125;<br>add flow be called!<br>packet <span class="hljs-keyword">in</span> 0000000000000001 00:00:00:00:00:03 00:00:00:00:00:01 2<br>&#123;<span class="hljs-string">&#x27;0000000000000002&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 3, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 3&#125;, <span class="hljs-string">&#x27;0000000000000001&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 1, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 2&#125;, <span class="hljs-string">&#x27;0000000000000003&#x27;</span>: &#123;<span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 1&#125;&#125;<br>add flow be called!<br>packet <span class="hljs-keyword">in</span> 0000000000000001 00:00:00:00:00:01 00:00:00:00:00:03 1<br>&#123;<span class="hljs-string">&#x27;0000000000000002&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 3, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 3&#125;, <span class="hljs-string">&#x27;0000000000000001&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 1, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 2&#125;, <span class="hljs-string">&#x27;0000000000000003&#x27;</span>: &#123;<span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 1&#125;&#125;<br>add flow be called!<br>packet <span class="hljs-keyword">in</span> 0000000000000002 00:00:00:00:00:01 00:00:00:00:00:03 2<br>&#123;<span class="hljs-string">&#x27;0000000000000002&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 3, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 3&#125;, <span class="hljs-string">&#x27;0000000000000001&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 1, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 2&#125;, <span class="hljs-string">&#x27;0000000000000003&#x27;</span>: &#123;<span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 1&#125;&#125;<br>add flow be called!<br>packet <span class="hljs-keyword">in</span> 0000000000000003 00:00:00:00:00:01 00:00:00:00:00:03 2<br>&#123;<span class="hljs-string">&#x27;0000000000000002&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 3, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 3&#125;, <span class="hljs-string">&#x27;0000000000000001&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 1, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 2&#125;, <span class="hljs-string">&#x27;0000000000000003&#x27;</span>: &#123;<span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 1&#125;&#125;<br>add flow be called!<br>packet <span class="hljs-keyword">in</span> 0000000000000003 00:00:00:00:00:03 33:33:ff:00:00:03 1<br>&#123;<span class="hljs-string">&#x27;0000000000000002&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 3, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 3&#125;, <span class="hljs-string">&#x27;0000000000000001&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 1, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 2&#125;, <span class="hljs-string">&#x27;0000000000000003&#x27;</span>: &#123;<span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 1&#125;&#125;<br>packet <span class="hljs-keyword">in</span> 0000000000000003 9a:45:4b:da:a9:ba 33:33:00:00:00:16 2<br>&#123;<span class="hljs-string">&#x27;0000000000000002&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 3, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 3&#125;, <span class="hljs-string">&#x27;0000000000000001&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 1, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 2&#125;, <span class="hljs-string">&#x27;0000000000000003&#x27;</span>: &#123;<span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 1, <span class="hljs-string">&#x27;9a:45:4b:da:a9:ba&#x27;</span>: 2&#125;&#125;<br>packet <span class="hljs-keyword">in</span> 0000000000000002 00:00:00:00:00:03 33:33:ff:00:00:03 3<br>&#123;<span class="hljs-string">&#x27;0000000000000002&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 3, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 3&#125;, <span class="hljs-string">&#x27;0000000000000001&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 1, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 2&#125;, <span class="hljs-string">&#x27;0000000000000003&#x27;</span>: &#123;<span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 1, <span class="hljs-string">&#x27;9a:45:4b:da:a9:ba&#x27;</span>: 2&#125;&#125;<br>packet <span class="hljs-keyword">in</span> 0000000000000001 00:00:00:00:00:03 33:33:ff:00:00:03 2<br>&#123;<span class="hljs-string">&#x27;0000000000000002&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 3, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 3&#125;, <span class="hljs-string">&#x27;0000000000000001&#x27;</span>: &#123;<span class="hljs-string">&#x27;92:83:5b:9d:3d:62&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 1, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 2&#125;, <span class="hljs-string">&#x27;0000000000000003&#x27;</span>: &#123;<span class="hljs-string">&#x27;00:00:00:00:00:01&#x27;</span>: 2, <span class="hljs-string">&#x27;00:00:00:00:00:03&#x27;</span>: 1, <span class="hljs-string">&#x27;9a:45:4b:da:a9:ba&#x27;</span>: 2&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>不过这个日志读起来也挺麻烦的，这里简单过一遍行为。</p>
<ul>
<li>首先由于目前没有任何其他流表，h1 发出的数据包会被直接转发给控制器，此时的目标 mac 是广播地址 <code>ff:ff:ff:ff:ff:ff</code><ul>
<li><code>packet in 0000000000000001 00:00:00:00:00:01 ff:ff:ff:ff:ff:ff 1</code></li>
</ul>
</li>
<li>控制器记录了交换机 s1 下 h1 主机所连接的端口</li>
<li>然后这个广播被 s2 接受到，由于仍然没有匹配的 mac 地址，继续广播<ul>
<li><code>packet in 0000000000000002 00:00:00:00:00:01 ff:ff:ff:ff:ff:ff 2</code></li>
</ul>
</li>
<li>由于 s3 下也没有对应地址，继续广播<ul>
<li><code>packet in 0000000000000003 00:00:00:00:00:01 ff:ff:ff:ff:ff:ff 2</code></li>
</ul>
</li>
<li>当 h3 主机接收到该广播后，向 h1 回复，此时交换机 s3 会接受报文<ul>
<li><code>packet in 0000000000000003 00:00:00:00:00:03 00:00:00:00:00:01 1</code></li>
</ul>
</li>
<li>此时交换机的 mac_to_port 会记录下来相关条目数据，并下发流表<ul>
<li><code>&#123;&#39;0000000000000002&#39;: &#123;&#39;92:83:5b:9d:3d:62&#39;: 3, &#39;00:00:00:00:00:01&#39;: 2&#125;, &#39;0000000000000001&#39;: &#123;&#39;92:83:5b:9d:3d:62&#39;: 2, &#39;00:00:00:00:00:01&#39;: 1&#125;, &#39;0000000000000003&#39;: &#123;&#39;00:00:00:00:00:01&#39;: 2, &#39;00:00:00:00:00:03&#39;: 1&#125;&#125;</code></li>
<li>流表匹配项包括入端口、目标 mac、源 mac，在三者都匹配时转发到 <code>out_port</code> 端口</li>
</ul>
</li>
<li>同样，交换机 s3 根据先前的路径访问 s2，由于已经有过记录，因此可以下发流表</li>
<li>s2 回复 s1 的路径也同样下发流表</li>
<li>最后 h3 又完成了一次 ping h1，但这次通过流表完成，很多日志就不需要打印了。</li>
</ul>
<blockquote>
<p>不过需要注意一点，有些日志可能不会被打印，因此这个逻辑大致如此，但实际上有些区别。<br>我们下发的流表中优先级是大于默认流表的，而只有默认流表会打印日志，因此有一部分流量通过我们下发的流表完成转发时不会再有日志输出。</p>
</blockquote>
<h1 id="案例：simple-switch-13-py"><a href="#案例：simple-switch-13-py" class="headerlink" title="案例：simple_switch_13.py"></a>案例：simple_switch_13.py</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Copyright (C) 2011 Nippon Telegraph and Telephone Corporation.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="hljs-comment"># you may not use this file except in compliance with the License.</span><br><span class="hljs-comment"># You may obtain a copy of the License at</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#    http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Unless required by applicable law or agreed to in writing, software</span><br><span class="hljs-comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="hljs-comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or</span><br><span class="hljs-comment"># implied.</span><br><span class="hljs-comment"># See the License for the specific language governing permissions and</span><br><span class="hljs-comment"># limitations under the License.</span><br><br><span class="hljs-keyword">from</span> ryu.base <span class="hljs-keyword">import</span> app_manager<br><span class="hljs-keyword">from</span> ryu.controller <span class="hljs-keyword">import</span> ofp_event<br><span class="hljs-keyword">from</span> ryu.controller.handler <span class="hljs-keyword">import</span> CONFIG_DISPATCHER, MAIN_DISPATCHER<br><span class="hljs-keyword">from</span> ryu.controller.handler <span class="hljs-keyword">import</span> set_ev_cls<br><span class="hljs-keyword">from</span> ryu.ofproto <span class="hljs-keyword">import</span> ofproto_v1_3<br><span class="hljs-keyword">from</span> ryu.lib.packet <span class="hljs-keyword">import</span> packet<br><span class="hljs-keyword">from</span> ryu.lib.packet <span class="hljs-keyword">import</span> ethernet<br><span class="hljs-keyword">from</span> ryu.lib.packet <span class="hljs-keyword">import</span> ether_types<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleSwitch13</span>(app_manager.RyuApp):<br>    OFP_VERSIONS = [ofproto_v1_3.OFP_VERSION]<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):<br>        <span class="hljs-built_in">super</span>(SimpleSwitch13, self).__init__(*args, **kwargs)<br>        self.mac_to_port = &#123;&#125;<br><br><span class="hljs-meta">    @set_ev_cls(<span class="hljs-params">ofp_event.EventOFPSwitchFeatures, CONFIG_DISPATCHER</span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">switch_features_handler</span>(<span class="hljs-params">self, ev</span>):<br>        datapath = ev.msg.datapath<br>        ofproto = datapath.ofproto<br>        parser = datapath.ofproto_parser<br><br>        <span class="hljs-comment"># install table-miss flow entry</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-comment"># We specify NO BUFFER to max_len of the output action due to</span><br>        <span class="hljs-comment"># OVS bug. At this moment, if we specify a lesser number, e.g.,</span><br>        <span class="hljs-comment"># 128, OVS will send Packet-In with invalid buffer_id and</span><br>        <span class="hljs-comment"># truncated packet data. In that case, we cannot output packets</span><br>        <span class="hljs-comment"># correctly.  The bug has been fixed in OVS v2.1.0.</span><br>        <span class="hljs-keyword">match</span> = parser.OFPMatch()<br>        actions = [parser.OFPActionOutput(ofproto.OFPP_CONTROLLER,<br>                                          ofproto.OFPCML_NO_BUFFER)]<br>        self.add_flow(datapath, <span class="hljs-number">0</span>, <span class="hljs-keyword">match</span>, actions)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_flow</span>(<span class="hljs-params">self, datapath, priority, <span class="hljs-keyword">match</span>, actions, buffer_id=<span class="hljs-literal">None</span></span>):<br>        ofproto = datapath.ofproto<br>        parser = datapath.ofproto_parser<br><br>        inst = [parser.OFPInstructionActions(ofproto.OFPIT_APPLY_ACTIONS,<br>                                             actions)]<br>        <span class="hljs-keyword">if</span> buffer_id:<br>            mod = parser.OFPFlowMod(datapath=datapath, buffer_id=buffer_id,<br>                                    priority=priority, <span class="hljs-keyword">match</span>=<span class="hljs-keyword">match</span>,<br>                                    instructions=inst)<br>        <span class="hljs-keyword">else</span>:<br>            mod = parser.OFPFlowMod(datapath=datapath, priority=priority,<br>                                    <span class="hljs-keyword">match</span>=<span class="hljs-keyword">match</span>, instructions=inst)<br>        datapath.send_msg(mod)<br><br><span class="hljs-meta">    @set_ev_cls(<span class="hljs-params">ofp_event.EventOFPPacketIn, MAIN_DISPATCHER</span>)</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_packet_in_handler</span>(<span class="hljs-params">self, ev</span>):<br>        <span class="hljs-comment"># If you hit this you might want to increase</span><br>        <span class="hljs-comment"># the &quot;miss_send_length&quot; of your switch</span><br>        <span class="hljs-keyword">if</span> ev.msg.msg_len &lt; ev.msg.total_len:<br>            self.logger.debug(<span class="hljs-string">&quot;packet truncated: only %s of %s bytes&quot;</span>,<br>                              ev.msg.msg_len, ev.msg.total_len)<br>        msg = ev.msg<br>        datapath = msg.datapath<br>        ofproto = datapath.ofproto<br>        parser = datapath.ofproto_parser<br>        in_port = msg.<span class="hljs-keyword">match</span>[<span class="hljs-string">&#x27;in_port&#x27;</span>]<br><br>        pkt = packet.Packet(msg.data)<br>        eth = pkt.get_protocols(ethernet.ethernet)[<span class="hljs-number">0</span>]<br><br>        <span class="hljs-keyword">if</span> eth.ethertype == ether_types.ETH_TYPE_LLDP:<br>            <span class="hljs-comment"># ignore lldp packet</span><br>            <span class="hljs-keyword">return</span><br>        dst = eth.dst<br>        src = eth.src<br><br>        dpid = <span class="hljs-built_in">format</span>(datapath.<span class="hljs-built_in">id</span>, <span class="hljs-string">&quot;d&quot;</span>).zfill(<span class="hljs-number">16</span>)<br>        self.mac_to_port.setdefault(dpid, &#123;&#125;)<br><br>        self.logger.info(<span class="hljs-string">&quot;packet in %s %s %s %s&quot;</span>, dpid, src, dst, in_port)<br><br>        <span class="hljs-comment"># learn a mac address to avoid FLOOD next time.</span><br>        self.mac_to_port[dpid][src] = in_port<br><br>        <span class="hljs-keyword">if</span> dst <span class="hljs-keyword">in</span> self.mac_to_port[dpid]:<br>            out_port = self.mac_to_port[dpid][dst]<br>        <span class="hljs-keyword">else</span>:<br>            out_port = ofproto.OFPP_FLOOD<br><br>        actions = [parser.OFPActionOutput(out_port)]<br><br>        <span class="hljs-comment"># install a flow to avoid packet_in next time</span><br>        <span class="hljs-keyword">if</span> out_port != ofproto.OFPP_FLOOD:<br>            <span class="hljs-keyword">match</span> = parser.OFPMatch(in_port=in_port, eth_dst=dst, eth_src=src)<br>            <span class="hljs-comment"># verify if we have a valid buffer_id, if yes avoid to send both</span><br>            <span class="hljs-comment"># flow_mod &amp; packet_out</span><br>            <span class="hljs-keyword">if</span> msg.buffer_id != ofproto.OFP_NO_BUFFER:<br>                self.add_flow(datapath, <span class="hljs-number">1</span>, <span class="hljs-keyword">match</span>, actions, msg.buffer_id)<br>                <span class="hljs-keyword">return</span><br>            <span class="hljs-keyword">else</span>:<br>                self.add_flow(datapath, <span class="hljs-number">1</span>, <span class="hljs-keyword">match</span>, actions)<br>        data = <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">if</span> msg.buffer_id == ofproto.OFP_NO_BUFFER:<br>            data = msg.data<br><br>        out = parser.OFPPacketOut(datapath=datapath, buffer_id=msg.buffer_id,<br>                                  in_port=in_port, actions=actions, data=data)<br>        datapath.send_msg(out)<br></code></pre></td></tr></table></figure>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://chentingz.github.io/2019/12/30/%E3%80%8COpenFlow%E3%80%8D%E5%8D%8F%E8%AE%AE%E5%85%A5%E9%97%A8/">「OpenFlow」协议入门</a></p>
<blockquote>
<p>写的很详细，本文部分图片来自本文，还有一些分类内容也摘自本文</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sgatbl/p/6861771.html">SDN学习之实现环路通信</a></p>
<blockquote>
<p>参考了本文的代码分析，并额外做了补充</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://zenhox.github.io/2018/04/02/Ryu%E5%AD%A6%E4%B9%A0%E4%B8%80/">Ryu学习一</a></p>
<blockquote>
<p>给出了一部分 api 的表格，本文中的表格取自本文</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://ryu.readthedocs.io/">ryu 文档</a></p>
<blockquote>
<p>文档，但大多时候不如直接看代码</p>
</blockquote>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2024/04/08/%E5%BC%BA%E7%BD%91%E6%9D%AF2023Final-D8%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90%E2%80%94%E2%80%94%E4%BB%8E%E8%B6%8A%E7%95%8C%E8%AF%BB%E5%88%B0%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C(CVE-2023-4427)/">← Next 强网杯2023Final-D8利用分析——从越界读到任意代码执行(CVE-2023-4427)</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2024/01/11/QWB2024-Re-Part-Record/">QWB2024-Re Part Record Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/6.png" alt="Logo"></a><h1 id="Dr"><a href="TokameinE">TokameinE</a></h1><div id="description"><p></p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/ErodedElk"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" target="_blank" rel="noopener" href="https://space.bilibili.com/1782544616"><i class="fa-brands fa-bilibili" alt="BiliBili"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">前置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A1%8C%E4%B8%BA"><span class="toc-number">2.</span> <span class="toc-text">行为</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E9%A5%B0%E5%99%A8%E4%B8%8E%E4%BA%8B%E4%BB%B6"><span class="toc-number">2.1.</span> <span class="toc-text">修饰器与事件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Datapath"><span class="toc-number">2.2.</span> <span class="toc-text">Datapath</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ryu-controller-controller-Datapath"><span class="toc-number">2.2.1.</span> <span class="toc-text">ryu.controller.controller.Datapath</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ofproto-parser"><span class="toc-number">2.2.2.</span> <span class="toc-text">ofproto_parser</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%B8%8B%E5%8F%91%E6%B5%81%E8%A1%A8"><span class="toc-number">2.3.</span> <span class="toc-text">如何下发流表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86-pack-in"><span class="toc-number">2.4.</span> <span class="toc-text">处理 pack in</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">3.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%EF%BC%9Asimple-switch-13-py"><span class="toc-number">4.</span> <span class="toc-text">案例：simple_switch_13.py</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>